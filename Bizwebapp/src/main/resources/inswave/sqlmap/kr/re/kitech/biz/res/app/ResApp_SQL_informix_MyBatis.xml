<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.re.kitech.biz.res.app">	
<!-- 사업신청 리스트(사용자) 조회 -->
<select id="selectBsnsAppUserList" parameterType="kr.re.kitech.biz.res.app.vo.ResAppSrcVo" resultType="kr.re.kitech.biz.res.app.vo.ResAppBsnsReqVo" >
SELECT /* QueryID : kr.re.kitech.biz.res.selectBsnsAppUserList */
       a.bsns_req_no  -- 사업신청번호	
     , a.prj_nm       -- 과제명
     , a.resch_rspns_main -- 연구책임자
     , b.empno AS resch_rspns_main_empno
     , TRIM(b.nm) AS resch_rspns_main_nm     -- 성명(연구책임자주)
     , DECODE(a.selt_rst, '      ', '미정', fun_xodxcommst_cd_nm(TRIM(a.selt_rst), 0)) AS selt_rst_nm  -- 선정결과명
     , TRIM(a.req_ymd) AS req_ymd -- 신청일자
     , c.prj_no -- 과제번호(과제 MASTER)
     , a.req_state -- 신청상태
     , t1.bsns_nm AS bsns_cd_ofic_nm -- 관계부처
     , x1.bsns_nm AS bsns_cd_detls_bsns_nm -- 사업명
     , a.bsns_cd_exclsv_agncy --전담기관
     , t2.dept_typ
     , t2.dept_nm
     , j.start_ymd
     , j.cls_ymd
     , j.tot_cash_amt
     , d.apr_state
     , DECODE(d.apr_state,NULL,e.cd_nm,f.cd_nm) AS apr_state_str
     , c.curr_accnt_no AS accnt_no 
FROM resappmast a  -- 사업신청 MASTER
JOIN humbasicinfo b ON a.resch_rspns_main = b.syspayno  -- 인사 MASTER
JOIN xodrbacode t1 ON a.bsns_cd_ofic = t1.bsns_cd
JOIN xodrbacode x1 ON a.bsns_cd_detls_bsns = x1.bsns_cd
JOIN xodhdeptinfo t2 ON b.dept_cd = t2.dept_cd AND b.dept_new_ymd = t2.dept_new_ymd
JOIN ( SELECT bsns_req_no, 
              start_ymd,
              cls_ymd,
              SUM(gov_cntrbamt + cmpy_cash + local_gov_cash + univ_cash + etc_cash) AS tot_cash_amt
         FROM resappbugt
        GROUP BY 1,2,3
     ) j ON a.bsns_req_no = j.bsns_req_no 
LEFT JOIN resinpmast c ON a.bsns_req_no = c.bsns_req_no  -- 과제 MASTER
LEFT JOIN xomxintfatab d ON a.bsns_req_no = d.req_no  -- 전자결재 인터페이스 테이블
LEFT JOIN xodxcommst e ON a.req_state = e.cd
LEFT JOIN xodxcommst f ON d.apr_state = f.cd
WHERE ( a.req_psn = #{ req_psn } 
      <if test='resch_rspns_main != null and resch_rspns_main != ""'> OR a.resch_rspns_main = #{ resch_rspns_main } </if> )
<if test='bsns_req_no != null and bsns_req_no != ""'>  AND a.bsns_req_no LIKE '%' || #{ bsns_req_no } || '%' </if>
<if test='prj_nm != null and prj_nm != ""'>  AND a.prj_nm LIKE '%' || #{ prj_nm } || '%'  /*과제명 */</if>
<if test='resch_rspns_main != null and resch_rspns_main != ""'>  AND a.resch_rspns_main = #{ resch_rspns_main } </if>
<if test='req_ymd_fr != null and req_ymd_fr != ""'>  AND a.req_ymd >= #{ req_ymd_fr } </if>
<if test='req_ymd_to != null and req_ymd_to != ""'> AND a.req_ymd <![CDATA[<= ]]> #{req_ymd_to} </if>
<if test='req_state != null and req_state != ""'>  AND a.req_state = #{ req_state } </if>
<if test='selt_rst != null and selt_rst != ""'>  AND a.selt_rst = #{ selt_rst } </if>
<if test='bsns_cd_inout != null and bsns_cd_inout != ""'> AND a.bsns_cd_inout = #{bsns_cd_inout} /*내외부구분 */ </if>  
<if test='bsns_cd_detls_bsns_nm != null and bsns_cd_detls_bsns_nm != ""'> AND x1.bsns_nm LIKE '%'||#{bsns_cd_detls_bsns_nm} ||'%' /*세부사업명 */ </if>  
<if test='curr_accnt_no != null and curr_accnt_no != ""'>  AND c.curr_accnt_no = #{ curr_accnt_no } </if>
  ORDER BY a.regst_daytm DESC
</select>
	
<!-- 사업신청 상세 조회 -->
<select id="selectResAppMast" parameterType="java.lang.String" resultType="kr.re.kitech.biz.res.app.vo.ResAppMastVo" >
SELECT /* QueryID : kr.re.kitech.biz.res.selectResAppMast */
       a.bsns_req_no    -- 사업신청번호
     , a.bsns_cd_inout -- 사업코드내외
     , a.bsns_cd_ofic   -- 사업코드부처
     , a.bsns_cd_exclsv_agncy -- 사업코드전담기관
     , a.bsns_cd_bsns    -- 사업코드사업
     , a.bsns_cd_detls_bsns   -- 사업코드세부사업
     , fun_xodxcommst_cd_nm(TRIM(a.bsns_cd_inout), 0) AS bsns_cd_inout_nm   -- 사업코드내외(명)
     , cd1.bsns_nm AS bsns_cd_ofic_nm           -- 사업코드부처(명)
     , fun_xodxcommst_cd_nm(TRIM(a.bsns_cd_exclsv_agncy), 0) AS bsns_cd_exclsv_agncy_nm   -- 사업코드전담기관(명)
     , cd2.bsns_nm AS bsns_cd_bsns_nm           -- 사업코드사업(명)
     , cd3.bsns_nm AS bsns_cd_detls_bsns_nm     -- 사업코드세부사업(명)
     , a.prj_nm          -- 과제명
     , a.prj_eng_nm      -- 과제영문명
     , a.tot_resch_amt  -- 총연구비(2014.12.23 컬럼추가)
     , a.suply_value -- 공급가액(2014.12.23 컬럼추가)
     , a.tax_amt -- 부가세(2014.12.23 컬럼추가)
     , TRIM(a.resch_rspns_main) AS resch_rspns_main          -- 연구책임자
     , b.empno AS resch_rspns_main_empno    -- 개인번호(연구책임자)
     , b.nm AS resch_rspns_main_nm     -- 성명(연구책임자)        
     , TRIM(a.prj_typ)                   AS prj_typ                   -- 과제유형
     , TRIM(a.tech_typ)                  AS tech_typ                  -- 기술유형
     , TRIM(a.tech_life_cycle)           AS tech_life_cycle           -- 기술수명주기
     , a.aplctn_objct_yn                 AS aplctn_objct_yn           -- 실용화대상여부
     , TRIM(a.econo_soct_goal)           AS econo_soct_goal           -- 경제사회적목적
     , TRIM(a.sixt_relat_tech)           AS sixt_relat_tech           -- 6T관련기술
     , TRIM(a.sixt_relat_tech_detls)     AS sixt_relat_tech_detls     -- 6T관련기술세부
     , fun_xodxcommst_cd_nm(TRIM(a.sixt_relat_tech_detls), 0)  AS sixt_relat_tech_detls_nm  -- 6T관련기술세부(명)(6T 관련기술)
     , TRIM(a.tot_resch_prd_orign_ymd)   AS tot_resch_prd_orign_ymd   -- 총연구기간시작일자
     , TRIM(a.tot_resch_prd_cls_ymd)     AS tot_resch_prd_cls_ymd     -- 총연구기간종료일자
     , TRIM(NVL(a.step_resch_prd_orign_ymd, a.tot_resch_prd_orign_ymd)) AS step_resch_prd_orign_ymd -- 현단계 연구기간 시작일자
     , TRIM(NVL(a.step_resch_prd_cls_ymd, a.tot_resch_prd_cls_ymd)) AS step_resch_prd_cls_ymd -- 현단계 연구기간 종료일자
     , NVL(a.cur_step, 1) AS cur_step -- 현단계
     , TRIM(a.thyr_resch_prd_orign_ymd)  AS thyr_resch_prd_orign_ymd  -- 당해연구기간시작일자
     , TRIM(a.thyr_resch_prd_cls_ymd)    AS thyr_resch_prd_cls_ymd    -- 당해연구기간종료일자
     , TRIM(a.req_state)                 AS req_state                 -- 신청상태
     , fun_xodxcommst_cd_nm(TRIM(a.req_state), 0) AS req_state_nm              -- 신청상태(명)
     , TRIM(a.selt_rst)                  AS selt_rst                  -- 선정결과
     , decode(TRIM(a.selt_rst), '      ', '미정', fun_xodxcommst_cd_nm(TRIM(a.selt_rst), 0)) AS selt_rst_nm -- 선정결과(명)
     , TRIM(a.req_ymd)                   AS req_ymd                   -- 신청일자
     , TRIM(a.req_psn)                   AS req_psn                   -- 신청자
     , TRIM(a.selt_ymd)                  AS selt_ymd                  -- 선정일자
     , a.resn_and_unusual_item  -- 사유및특이사항
     , a.prj_regst_yn           -- 과제등록여부
     , a.selt_score             -- 선정점수     
     , TRIM(a.detls_prj_charct)          AS detls_prj_charct          -- 세부과제성격
     , TRIM(a.sci_tech_std_clsf)         AS sci_tech_std_clsf         -- 과학기술표준분류
     , fun_xodxcommst_cd_nm(TRIM(a.sci_tech_std_clsf), 0) AS sci_tech_std_clsf_nm      -- 과학기술표준분류(명)
     , TRIM(a.ntrm_clsf)                 AS ntrm_clsf                 -- NTRM분류
     , fun_xodxcommst_cd_nm(TRIM(a.ntrm_clsf), 0) AS ntrm_clsf_nm     -- NTRM분류(명)(국가기술지도(NTRM)분류)
     , a.dev_goal   -- 개발목표
     , a.resch_contnt     -- 연구내용
     , a.expec_efct       -- 기대효과
     , a.kwd_krchar       -- 키워드한글
     , a.kwd_eng          -- 키워드영문
     , a.secrt_prj_ex     -- 보안과제유무
     , TRIM(a.indst_tech_clsf_label) AS indst_tech_clsf_label     -- 산업기술분류표
     , cd4.smalclsf          AS indst_tech_clsf_label_nm  -- 산업기술분류표(명)
     , TRIM(a.pre_plan_prj)  AS pre_plan_prj              -- 선행기획과제
     , TRIM(a.selt_attach_file_no) AS selt_attach_file_no
     , TRIM(a.middle_attach_file) AS middle_attach_file -- 사업계획서(중간첨부파일)
     , TRIM(a.final_attach_file) AS final_attach_file       -- 최종사업계획서(최종첨부파일)
     , TRIM(a.bsns_notice_attach_file_no) AS  bsns_notice_attach_file_no -- 사업공고 첨부파일
     , a.bsns_notice_no           -- 사업공고번호
     , TRIM(a.tot_prj_yrs) AS tot_prj_yrs    -- 총과제년수
     , d.prj_no                   -- 과제번호(과제 MASTER)
     , b.dept_cd                  -- 부서
     , b.dept_new_ymd             -- 신설일
     , e.apr_state  -- (전자결재인터페이스)결재상태코드
     , a.regst_syspayno  -- 작성자
     , cd3.oh_absrp_rt  -- OH흡수율
     , a.mail_send_yn   -- 메일발송여부(선정시)
     , nvl(f.vacct_no, '') AS vacct_no
     , a.intrn_use_ex     --국제공동연구과제여부
     , a.note_use_ex      -- 연구노트사용여부
     , a.note_type_cd    -- 연구노트구분
     , a.prj_card_clsf    -- 과제구분
     , a.threefive        --3책5공여부
     , a.threefive_clsf   --3책5공제한사유
     , a.consider   --  사업조정회의 심의여부
     , a.consider_clsf   --  사업조정회의 심의여부 제외기준
     , a.tax_cd
     , a.tax_free_item
     , a.tax_item
     , a.cmpy_yn
     , s.secu01_yn
     , s.secu02_yn
     , s.secu03_yn
     , s.secu04_yn
     , a.wrk_clsf
     , a.trust_gb
     , a.total_res_amt
     , NVL(a.step_res_amt, a.total_res_amt) AS step_res_amt -- 우리원 현단계 연구비
     , DECODE(NVL(a.trust_gb,''), 'Y', 'RCA020', a.part_clsf) AS part_clsf
     , a.intgr_mngmt_unit -- 연구장비통합관리단위(2021.09.28.추가)
     , c.req_no AS cu_req_no
     , 'U' AS cud_type
  FROM resappmast a 
  JOIN humbasicinfo b ON a.resch_rspns_main = b.syspayno  -- 인사기본 MASTER
  JOIN xomxintfatab e ON a.bsns_req_no = e.req_no   -- 전자결재 인터페이스 테이블
  JOIN xodrbacode cd1 ON a.bsns_cd_ofic = cd1.bsns_cd    -- 사업코드부처
  JOIN xodrbacode cd2 ON a.bsns_cd_bsns = cd2.bsns_cd    -- 사업코드사업
  JOIN xodrbacode cd3 ON a.bsns_cd_detls_bsns = cd3.bsns_cd  -- 사업코드세부사업
  LEFT JOIN resinpmast d ON a.bsns_req_no = d.bsns_req_no   -- 과제 MASTER
  LEFT JOIN resindtecc cd4 ON a.indst_tech_clsf_label = cd4.cd  
  LEFT JOIN ffnvacct f ON a.bsns_req_no = f.bsns_req_no
  LEFT JOIN resappsecurity s ON s.bsns_req_no = a.bsns_req_no
  LEFT JOIN resparemngmtmstr c ON a.bsns_req_no = c.bsns_req_no
 WHERE a.bsns_req_no = #{bsns_req_no}
</select>
	
<!-- 사업신청 예산 내역 조회 -->
<select id="selectResAppBugt" parameterType="kr.re.kitech.biz.res.app.vo.ResAppSrcVo" resultType="kr.re.kitech.biz.res.app.vo.ResAppBugtVo">
SELECT /* QueryID : kr.re.kitech.biz.res.selectResAppBugt */
       d.cd                      AS bugt_item       -- 예산항목
     , d.cd_desc                 AS itm_nm          -- 비목구분(비목구분)
     , d.cd_nm                   AS bugt_item_nm    -- 비목구분명(세부비목명)
   <if test='bsns_req_no != null and bsns_req_no != ""'>
     , NVL(a.gov_cntrbamt  , 0)  AS gov_cntrbamt    -- 정부출연금
     , NVL(a.cmpy_cash     , 0)  AS cmpy_cash       -- 기업현금
     , NVL(a.cmpy_goods    , 0)  AS cmpy_goods      -- 기업현물
     , NVL(a.contpat_goods , 0)  AS contpat_goods   -- 상대국현물
     , NVL(a.local_gov_cash, 0)  AS local_gov_cash  -- 지방정부현금
     , NVL(a.univ_cash     , 0)  AS univ_cash       -- 대학현금
     , NVL(a.etc_cash      , 0)  AS etc_cash        -- 기타현금
     , NVL(a.gov_cntrbamt   +
           a.cmpy_cash      +
           a.cmpy_goods     +
           a.contpat_goods  +
           a.local_gov_cash +
           a.univ_cash      +
           a.etc_cash      , 0)  AS tot_amt         -- 합계
     , a.bsns_req_no      -- 사업신청번호
     , a.anal             -- 년차
     , NVL(a.gov_cntrbamt, 0) + NVL(a.cmpy_cash, 0) + NVL(a.local_gov_cash, 0) + NVL(a.univ_cash, 0) + NVL(a.etc_cash, 0) AS cash_tot_amt -- 현금총금액
     , NVL(a.cmpy_goods, 0) + NVL(a.contpat_goods, 0) AS goods_tot_amt   -- 현물총금액
     , a.start_ymd  -- 시작일자
     , a.cls_ymd    -- 종료일자
   </if>
  FROM xodxcommst d
<if test='bsns_req_no != null and bsns_req_no != ""'>
  LEFT JOIN resappbugt a ON a.bugt_item = d.cd AND a.bsns_req_no = #{bsns_req_no}
</if>
 WHERE d.cd_clsf =  'RHQ'
   AND d.use_ex = 'Y'
 ORDER BY d.mngmt_no_1
</select>
  
<!-- 연구원구분 조회 -->
<select id="selectUserAuthorInfo" parameterType="kr.re.kitech.biz.res.app.vo.ResAppSrcVo" resultType="java.lang.String">
-- 로그인한 사용자가 해당 과제의 연구책임자인지, 참여연구원인지의 여부를 조회
SELECT /* QueryID : kr.re.kitech.biz.res.selectUserAuthorInfo */
         a.reschr_clsf  -- 연구원구분([RAL001]연구책임자, [RAL002]참여연구원)
  FROM resapppare a
 WHERE a.bsns_req_no = #{bsns_req_no}   -- 사업신청번호
   AND a.syspayno    = #{syspayno}   -- 시스템개인번호
</select>

<!-- 간접비율 조회 -->  
<select id="selectAppIndrc" parameterType="kr.re.kitech.biz.res.app.vo.ResBsnsReqEtcVo" resultType="kr.re.kitech.biz.res.app.vo.ResBsnsReqEtcVo">
SELECT /* kr.re.kitech.biz.res.app.selectAppIndrc */
       indrc_rt 
 FROM resappindrc 
WHERE #{ymd} BETWEEN start_ymd AND cls_ymd
</select>
  
  <select id="selectResAppPrePrjList" parameterType="kr.re.kitech.biz.res.app.vo.ResAppPrePrjVo" resultType="kr.re.kitech.biz.res.app.vo.ResAppPrePrjVo">
SELECT /* QueryID : kr.re.kitech.biz.res.selectResAppPrePrjList */
     a.bsns_req_no,
     a.seq,
     a.accnt_no,
     b.accnt_no_nm AS prj_nm,
     b.accnt_rspns,
     c.nm AS accnt_rspns_nm,
     b.start_ymd || ' ~ ' || b.cls_ymd AS tot_yr_ymd,
     a.contr_rt
FROM resapppreprj a
JOIN resbgacctm b ON b.main_accnt_no = a.accnt_no AND b.accnt_clsf = 'RAR001'
JOIN humbasicinfo c ON c.syspayno = b.accnt_rspns
WHERE bsns_req_no = #{bsns_req_no}
ORDER BY seq
</select>
  
  <select id="selectResPareMngmtMstrList" parameterType="kr.re.kitech.biz.res.app.vo.ResPareMngmtMstrVo" resultType="kr.re.kitech.biz.res.app.vo.ResPareMngmtMstrVo">
SELECT /* QueryID : kr.re.kitech.biz.res.selectResPareMngmtMstrList */
       a.req_no
     , a.resch_rspns
     , a.prj_nm
     , a.exclsv_agncy_nm
     , a.bsns_cd_inout -- 내외구분 코드
     , fun_xodxcommst_cd_nm(trim(a.bsns_cd_inout), 0) as bsns_cd_inout_nm -- 내외구분
     , a.bsns_cd_ofic
     , a.start_ymd
     , a.cls_ymd 
     , a.bsns_req_no
     , b.empno
     , b.dept_cd
     , b.dept_new_ymd
     , nm AS resch_rspns_nm
FROM resparemngmtmstr a 
JOIN humbasicinfo b ON a.resch_rspns = b.syspayno 
WHERE 1=1 
<if test="resch_rspns != null and resch_rspns != ''"> AND resch_rspns = #{resch_rspns} </if>
<if test="prj_nm != null and prj_nm != ''"> AND prj_nm LIKE #{prj_nm} </if>
<if test="req_no != null and req_no != ''"> AND req_no = #{req_no} </if>
<if test="start_ymd != null and start_ymd != ''"> AND start_ymd BETWEEN #{start_ymd} AND #{cls_ymd} </if>
ORDER BY req_no DESC
</select>
 
<!-- 사전참여연구원 조회 -->  
<select id="selectResPareMngmtList" parameterType="kr.re.kitech.biz.res.app.vo.ResPareMngmtMstrVo" resultType="kr.re.kitech.biz.res.app.vo.ResAppPareVo">
SELECT /* QueryID : kr.re.kitech.biz.res.selectResPareMngmtList */
      a.req_no
    , a.reschr_clsf
    , fun_xodxcommst_cd_nm(trim(a.reschr_clsf), 0) as reschr_clsf_nm -- 연구원구분
    , a.psnexpns_clsf
    , fun_xodxcommst_cd_nm(trim(a.psnexpns_clsf), 0) as psnexpns_clsf_nm -- 인건비구분
    , CASE WHEN b.empno IS NULL THEN substr(a.syspayno, 3) ELSE b.empno END AS empno
    , a.nm
    , a.cash_attnce_rt
    , a.goods_attnce_rt
    , a.attnce_prd_orign_ymd
    , a.attnce_prd_cls_ymd
    , a.psnexpns_month_unit_price
    , a.cash_amt
    , a.goods_amt
    , a.apprvl_yn
    , b.job_clsf
    , a.syspayno
    , b.resid_no
    , b.occugrp_cd
    , b.email
    , b.posi_cd
    , b.sci_tech_regst_no
    , b.res_person_no AS respersonno
    , CASE WHEN c.resid_no IS NULL THEN 'N' ELSE 'Y' END AS restr_yn -- 참여제한여부
FROM resparemngmt a
LEFT JOIN humbasicinfo b ON a.syspayno = b.syspayno
LEFT JOIN (SELECT DISTINCT resid_no
             FROM resbapjmpn 
            WHERE restrc_prd_orign_ymd <![CDATA[<= ]]> TO_CHAR(CURRENT, '%Y%m%d') 
              AND restrc_prd_cls_ymd >= TO_CHAR(CURRENT, '%Y%m%d') 
       ) c ON b.resid_no = c.resid_no
WHERE 1=1 
<if test="req_no != null and req_no != ''"> AND a.req_no = #{req_no} </if>
<if test="syspayno != null and syspayno != ''"> AND a.syspayno = #{syspayno} </if>
<if test="apprvl_yn != null and apprvl_yn != ''"> AND a.apprvl_yn = #{apprvl_yn} </if>
ORDER BY a.reschr_clsf, a.psnexpns_clsf, a.syspayno
</select>  
  
<!-- 사업신청 참여연구원 조회 -->  
<select id="selectResAppPareList" parameterType="kr.re.kitech.biz.res.app.vo.ResPareMngmtMstrVo" resultType="kr.re.kitech.biz.res.app.vo.ResAppPareVo">
SELECT /* QueryID : kr.re.kitech.biz.res.selectResAppPareList */
       a.bsns_req_no   -- 사업신청번호
     , a.syspayno      -- 시스템개인번호
     , trim(a.nm)  AS nm      -- 성명
     , b.empno -- 개인번호
     , b.posi_cd
     , a.reschr_clsf
     , fun_xodxcommst_cd_nm(trim(a.reschr_clsf), 0) as reschr_clsf_nm -- 연구원구분
     , a.psnexpns_clsf
     , fun_xodxcommst_cd_nm(trim(a.psnexpns_clsf), 0) as psnexpns_clsf_nm -- 인건비구분
     , a.attnce_prd_orign_ymd  -- 참여기간시작일자
     , a.attnce_prd_cls_ymd    -- 참여기간종료일자
     , NVL(a.psnexpns_month_unit_price, 0)  AS psnexpns_month_unit_price  -- 인건비월단가
     , NVL(a.cash_attnce_rt , 0.00)   AS cash_attnce_rt   -- 현금참여율
     , NVL(a.goods_attnce_rt, 0.00)   AS goods_attnce_rt  -- 현물참여율
     , NVL(a.respn_rts      , 0.00)   AS respn_rts        -- 책임비율
     , NVL(a.cash_amt , 0)            AS cash_amt         -- 현금금액
     , NVL(a.goods_amt, 0)            AS goods_amt        -- 현물금액
     , a.apprvl_req_no                AS apprvl_req_no    -- 전자결재신청번호
     , NVL(a.apprvl_state, 'RHO001')  AS apprvl_state     -- 승인상태
     , NVL(a.adjst_attnce_rt, 0.00)   AS adjst_attnce_rt  -- 조정참여율
     , b.resid_no    -- 주민등록번호
     , b.email        -- 이메일
     , b.occugrp_cd   -- 직급코드 
     , b.job_clsf  
     , b.sci_tech_regst_no
     , b.res_person_no AS respersonno
     , CASE WHEN c.resid_no IS NULL THEN 'N' ELSE 'Y' END AS restr_yn -- 참여제한여부
FROM resapppare a 
LEFT JOIN humbasicinfo b ON a.syspayno = b.syspayno
LEFT JOIN (SELECT DISTINCT resid_no
             FROM resbapjmpn 
            WHERE restrc_prd_orign_ymd <![CDATA[<= ]]> TO_CHAR(CURRENT, '%Y%m%d') 
              AND restrc_prd_cls_ymd >= TO_CHAR(CURRENT, '%Y%m%d') 
       ) c ON b.resid_no = c.resid_no
WHERE a.bsns_req_no = #{bsns_req_no} 
<if test="syspayno != null and syspayno != ''"> AND a.syspayno = #{syspayno} </if>
ORDER BY a.bsns_req_no, a.reschr_clsf, a.syspayno
</select>

<!-- 3책5공 제외사업기준(RIE), 사업조정 제외기준 조회(RIH) -->  
<select id="selectBsnsAplyThreeFive" parameterType="kr.re.kitech.biz.res.app.vo.ResAppBsnsThreeFiveVo" resultType="kr.re.kitech.biz.res.app.vo.ResAppBsnsThreeFiveVo">
SELECT /* QueryID : kr.re.kitech.biz.res.selectBsnsAplyThreeFive */
      cd AS threefive_clsf
    , cd_nm AS threefive_nm
    <if test='cd_clsf != null and cd_clsf == "RIE"'>
    , mngmt_item_1 AS threefive_detail_nm
    </if>
  FROM xodxcommst 
 WHERE cd_clsf = #{cd_clsf}
   AND use_ex = 'Y'
 ORDER BY seq
</select>
  
<select id="selectBsnsAppList" parameterType="kr.re.kitech.biz.res.app.vo.ResAppSrcVo" resultType="kr.re.kitech.biz.res.app.vo.ResAppBsnsReqVo">
-- 사업신청 목록 조회
SELECT /* kr.re.kitech.biz.res.app.selectBsnsAppList */
       a.bsns_req_no         -- 사업신청번호
     , a.prj_nm    -- 과제명
     , a.resch_rspns_main   -- 연구책임자
     , b.empno AS resch_rspns_main_empno
     , TRIM(b.nm) AS resch_rspns_main_nm     -- 성명(연구책임자)    
     , a.bsns_cd_inout
     , a.tot_resch_prd_orign_ymd
     , a.tot_resch_prd_cls_ymd
     , a.req_state
     , t1.bsns_nm AS bsns_cd_ofic_nm -- 관계부처
     , x1.bsns_nm AS bsns_cd_detls_bsns_nm
     , a.bsns_cd_exclsv_agncy --전담기관
     , t2.dept_typ
     , t2.dept_nm
     , DECODE(a.selt_rst, '      ', '미정', fun_xodxcommst_cd_nm(TRIM(a.selt_rst), 0)) AS selt_rst_nm  -- 선정결과명
     , TRIM(a.req_ymd) AS req_ymd     -- 신청일자
     , c.prj_no    -- 과제번호(과제 MASTER)
     , c.curr_accnt_no AS accnt_no
     , j.start_ymd
     , j.cls_ymd
     , j.tot_cash_amt
     , a.selt_score
     , a.selt_ymd 
     , d.apr_state      -- (전자결재인터페이스)결재상태코드    
     , TRIM( DECODE(d.apr_state, 'XAD100', e.cd_nm::char(250), 
             DECODE(NVL(e.cd_nm, ''), '', '', e.cd_nm) ||DECODE(NVL(f.cd_nm, ''), '', '', '(' || f.cd_nm || ')') 
           ))  AS apr_state_str  -- 결재상태코드명(사업신청내역+전자결재인터페이스 혼합)
FROM resappmast a  -- 사업신청 MASTER
JOIN humbasicinfo b ON a.resch_rspns_main = b.syspayno  -- 인사 MASTER
JOIN xodrbacode t1 ON a.bsns_cd_ofic = t1.bsns_cd
JOIN xodrbacode x1 ON a.bsns_cd_detls_bsns = x1.bsns_cd
JOIN xodhdeptinfo t2 ON b.dept_cd = t2.dept_cd AND b.dept_new_ymd = t2.dept_new_ymd
LEFT JOIN ( xomxintfatab d 
                JOIN xodxcommst f ON d.apr_state = f.cd
          ) ON a.bsns_req_no = d.req_no -- 전자결재 인터페이스 테이블
JOIN ( SELECT bsns_req_no, 
              start_ymd,
              cls_ymd,
              SUM(gov_cntrbamt + cmpy_cash + local_gov_cash + univ_cash + etc_cash) AS tot_cash_amt
         FROM resappbugt
        GROUP BY 1,2,3
     ) j ON a.bsns_req_no = j.bsns_req_no 
LEFT JOIN resinpmast c ON a.bsns_req_no = c.bsns_req_no -- 과제 MASTER
LEFT JOIN xodxcommst e ON a.req_state = e.cd
WHERE a.req_ymd BETWEEN #{req_ymd_fr} AND #{req_ymd_to}
<if test='bsns_req_no != null and bsns_req_no != ""'> AND a.bsns_req_no LIKE #{bsns_req_no} ||'%' </if>
<if test='prj_nm != null and prj_nm != ""'> AND a.prj_nm LIKE '%'||#{prj_nm} ||'%' /*사업신청명 */</if>  
<if test='req_state != null and req_state != ""'> AND NVL(a.req_state, '') = #{req_state} /* 결재상태 */ </if>  
<if test='selt_rst != null and selt_rst != ""'> AND DECODE(a.selt_rst, '      ', 'RAG999', a.selt_rst) = #{selt_rst} /*선정상태 */ </if>  
<if test='resch_rspns_main != null and resch_rspns_main != ""'> AND a.resch_rspns_main = #{resch_rspns_main} /*연구책임자개인번호*/</if>  
<if test='bsns_cd_inout != null and bsns_cd_inout != ""'> AND a.bsns_cd_inout = #{bsns_cd_inout} /*내외부구분 */ </if>  
<if test='divsn_dept != null and divsn_dept != ""'> AND t2.divsn_dept = #{divsn_dept} /*센터 */ </if>  
<if test='bsns_cd_detls_bsns_nm != null and bsns_cd_detls_bsns_nm != ""'> AND x1.bsns_nm LIKE '%'||#{bsns_cd_detls_bsns_nm} ||'%' /*세부사업명 */ </if>  
<if test='curr_accnt_no != null and curr_accnt_no != ""'> AND c.curr_accnt_no = #{curr_accnt_no} /*사업신청번호*/ </if>  
ORDER BY a.regst_daytm DESC
</select>

<!-- 사업신청 마스터 저장 -->
<insert id="insertResAppMast" parameterType="kr.re.kitech.biz.res.app.vo.ResAppMastVo">
INSERT /* kr.re.kitech.biz.req.app.insertResAppMast */
  INTO resappmast (
      bsns_req_no               -- 사업신청번호
    , bsns_cd_inout             -- 사업코드내외
    , bsns_cd_ofic              -- 사업코드부처
    , bsns_cd_exclsv_agncy      -- 사업코드전담기관
    , bsns_cd_bsns              -- 사업코드사업
    , bsns_cd_detls_bsns        -- 사업코드세부사업
   <if test='prj_nm != null'> , prj_nm /*과제명 */ </if>
   <if test='prj_eng_nm != null'> , prj_eng_nm /* 과제영문명 */ </if>
   <if test='tot_resch_amt != null'> , tot_resch_amt </if>
   <if test='suply_value != null'> , suply_value </if>
   <if test='tax_amt != null'> , tax_amt </if>
   <if test='resch_rspns_main != null'> , resch_rspns_main /* 연구책임자*/ </if>
   <if test='tot_resch_prd_orign_ymd != null'> , tot_resch_prd_orign_ymd /* 총연구기간시작일자 */ </if>
   <if test='tot_resch_prd_cls_ymd != null'> , tot_resch_prd_cls_ymd /* 총연구기간종료일자*/</if>
   <if test='tot_prj_yrs != null'> , tot_prj_yrs /* 총과제년수*/</if>
   <if test='step_resch_prd_orign_ymd != null'> , step_resch_prd_orign_ymd /* 현단계 연구기간시작일자 */ </if>
   <if test='step_resch_prd_cls_ymd != null'> , step_resch_prd_cls_ymd /* 현단계 연구기간종료일자*/</if>
   <if test='cur_step != null'> , cur_step /* 현단계 */</if>
   <if test='thyr_resch_prd_orign_ymd != null'> , thyr_resch_prd_orign_ymd /* 당해연구기간시작일자*/ </if>
   <if test='thyr_resch_prd_cls_ymd != null'> , thyr_resch_prd_cls_ymd /* 당해연구기간종료일자*/ </if>
   <if test='req_state != null'> , req_state /* 신청상태 */ </if>
    , req_ymd /* 신청일자 */ 
   <if test='req_psn != null'> , req_psn /* 신청자 */ </if>
   <if test='prj_regst_yn != null'> , prj_regst_yn /* 과제등록여부 */ </if>
   <if test='dev_goal != null'> , dev_goal /* 개발목표 */ </if>
   <if test='kwd_krchar != null'> , kwd_krchar /* 키워드한글 */ </if>
   <if test='kwd_eng != null'> , kwd_eng </if>
   <if test='secrt_prj_ex != null'> , secrt_prj_ex /* 보안과제유무 */ </if>
   <if test='pre_plan_prj != null'> , pre_plan_prj /* 선행기획과제 */ </if>
   <if test='middle_attach_file != null'> , middle_attach_file /* 사업계획서 */ </if>
   <if test='bsns_notice_attach_file_no != null'> , bsns_notice_attach_file_no /* 사업공고 */ </if>
   <if test='bsns_notice_no != null'> , bsns_notice_no /* 공고번호 */ </if>
   <if test='note_use_ex != null'> , note_use_ex /* 연구노트사용유무 */ </if>
   <if test='note_type_cd != null'> , note_type_cd /* 연구노트구분 */ </if>
   <if test='intrn_use_ex != null'> , intrn_use_ex /* 국제공동연구여부 */ </if>
   <if test='prj_card_clsf != null'> , prj_card_clsf /* 과제구분 */ </if>
   <if test='threefive != null'> , threefive /* 3책5공여부 */ </if>
   <if test='threefive_clsf != null'> , threefive_clsf /* 3책5공 제외기준 */ </if>
   <if test='consider != null'> , consider /* 사업조정회의 심의여부 */ </if>
   <if test='consider_clsf != null'> , consider_clsf /* 사업조정회의 심의여부 제외기준 */</if>
   <if test='tax_cd != null'> , tax_cd </if>
   <if test='tax_free_item != null'> , tax_free_item /* 비과세항목 */ </if>
   <if test='tax_item != null'> , tax_item /* 과세항목 */ </if>
   <if test='cmpy_yn != null'> , cmpy_yn /* 의뢰기관 기업체여부 */ </if>
   <if test='wrk_clsf != null'> , wrk_clsf /* 중소기업 참여유형*/ </if>
   <if test='total_res_amt != null'> , total_res_amt /* 총연구비 */</if>
   <if test='step_res_amt != null'> , step_res_amt /* 현단계연구비 */</if>
   <if test='part_clsf != null'> , part_clsf /* 과제참여유형*/ </if>
   <if test='intgr_mngmt_unit != null'> , intgr_mngmt_unit /* 연구장비통합관리단위 */</if>
    , regst_syspayno            -- 등록시스템개인번호
    , regst_daytm               -- 등록일시
) VALUES (
      #{bsns_req_no}              -- 사업신청번호
    , #{bsns_cd_inout}            -- 사업코드내외
    , #{bsns_cd_ofic}             -- 사업코드부처
    , #{bsns_cd_exclsv_agncy}     -- 사업코드전담기관
    , #{bsns_cd_bsns}             -- 사업코드사업
    , #{bsns_cd_detls_bsns}       -- 사업코드세부사업
    <if test='prj_nm != null'> , #{prj_nm} /*과제명 */ </if>
    <if test='prj_eng_nm != null'> , #{prj_eng_nm} /* 과제영문명 */ </if>
    <if test='tot_resch_amt != null'> , #{tot_resch_amt} </if>
    <if test='suply_value != null'> , #{suply_value} </if>
    <if test='tax_amt != null'> , #{tax_amt} </if>
    <if test='resch_rspns_main != null'> , #{resch_rspns_main} /* 연구책임자*/ </if>
    <if test='tot_resch_prd_orign_ymd != null'> , #{tot_resch_prd_orign_ymd} /* 총연구기간시작일자 */ </if>
    <if test='tot_resch_prd_cls_ymd != null'> , #{tot_resch_prd_cls_ymd} /* 총연구기간종료일자*/</if>
    <if test='tot_prj_yrs != null'> , #{tot_prj_yrs} /* 총과제년수*/</if>
    <if test='step_resch_prd_orign_ymd != null'> , #{step_resch_prd_orign_ymd} /* 현단계 연구기간시작일자 */ </if>
    <if test='step_resch_prd_cls_ymd != null'> , #{step_resch_prd_cls_ymd} /* 현단계 연구기간종료일자*/</if>
    <if test='cur_step != null'> , #{cur_step} /* 현단계 */</if>
    <if test='thyr_resch_prd_orign_ymd != null'> , #{thyr_resch_prd_orign_ymd} /* 당해연구기간시작일자*/ </if>
    <if test='thyr_resch_prd_cls_ymd != null'> , #{thyr_resch_prd_cls_ymd} /* 당해연구기간종료일자*/ </if>
    <if test='req_state != null'> , #{req_state} /* 신청상태 */ </if>
    , TO_CHAR(SYSDATE,'%Y%m%d') /* 신청일자 */ 
    <if test='req_psn != null'> , #{req_psn} /* 신청자 */ </if>
    <if test='prj_regst_yn != null'> , #{prj_regst_yn} /* 과제등록여부 */ </if>
    <if test='dev_goal != null'> , #{dev_goal} /* 개발목표 */ </if>
    <if test='kwd_krchar != null'> , #{kwd_krchar} /* 키워드한글 */ </if>
    <if test='kwd_eng != null'> , #{kwd_eng} </if>
    <if test='secrt_prj_ex != null'> , #{secrt_prj_ex} /* 보안과제유무 */ </if>
    <if test='pre_plan_prj != null'> , #{pre_plan_prj} /* 선행기획과제 */ </if>
    <if test='middle_attach_file != null'> , #{middle_attach_file} /* 사업계획서 */ </if>
    <if test='bsns_notice_attach_file_no != null'> , #{bsns_notice_attach_file_no} /* 사업공고 */ </if>
    <if test='bsns_notice_no != null'> , #{bsns_notice_no} /* 공고번호 */ </if>
    <if test='note_use_ex != null'> , #{note_use_ex} /* 연구노트사용유무 */ </if>
    <if test='note_type_cd != null'> , #{note_type_cd} /* 연구노트구분 */ </if>
    <if test='intrn_use_ex != null'> , #{intrn_use_ex} /* 국제공동연구여부 */ </if>
    <if test='prj_card_clsf != null'> , #{prj_card_clsf} /* 과제구분 */ </if>
    <if test='threefive != null'> , #{threefive} /* 3책5공여부 */ </if>
    <if test='threefive_clsf != null'> , #{threefive_clsf} /* 3책5공 제외기준 */ </if>
    <if test='consider != null'> , #{consider} /* 사업조정회의 심의여부 */ </if>
    <if test='consider_clsf != null'> , #{consider_clsf} /* 사업조정회의 심의여부 제외기준 */</if>
    <if test='tax_cd != null'> , #{tax_cd} </if>
    <if test='tax_free_item != null'> , #{tax_free_item} /* 비과세항목 */ </if>
    <if test='tax_item != null'> , #{tax_item} /* 과세항목 */ </if>
    <if test='cmpy_yn != null'> , #{cmpy_yn} /* 의뢰기관 기업체여부 */ </if>
    <if test='wrk_clsf != null'> , #{wrk_clsf} /* 중소기업 참여유형*/ </if>
    <if test='total_res_amt != null'> , #{total_res_amt} /* 총연구비 */</if>
    <if test='step_res_amt != null'> , #{step_res_amt} /* 현단계연구비 */</if>
    <if test='part_clsf != null'> , #{part_clsf} /* 과제참여유형*/ </if>
    <if test='intgr_mngmt_unit != null'> , #{intgr_mngmt_unit} /* 연구장비통합관리단위 */</if>
    , #{regst_syspayno} -- 등록시스템개인번호
    , SYSDATE           -- 등록일시
  )
</insert>

<!-- 사업조정회의 사업신청번호 업데이트 -->
<update id="updateResAppBsnsAdjst" parameterType="kr.re.kitech.biz.res.app.vo.ResAppBsnsAdjstVo">
UPDATE /* kr.re.kitech.biz.res.app.updateResAppBsnsAdjst */
       resappbsnsadjst
   SET bsns_req_no = #{bsns_req_no},
       updt_syspayno = #{updt_syspayno},
       updt_daytm = SYSDATE
 WHERE ( req_no = #{req_no} OR bsns_req_no = #{req_no})
</update>

<!-- 수행과제 보안등급 분류 및 심사기준 입력 -->
<insert id="insertResAppSecurity" parameterType="kr.re.kitech.biz.res.app.vo.ResAppMastVo">
INSERT /* kr.re.kitech.biz.res.app.insertResAppSecurity */
   INTO resappsecurity(
    bsns_req_no
  <if test='secu01_yn != null'> , secu01_yn </if>
  <if test='secu02_yn != null'> , secu02_yn </if>
  <if test='secu03_yn != null'> , secu03_yn </if>
  <if test='secu04_yn != null'> , secu04_yn </if>
   ,regst_syspayno
   ,regst_daytm
) 
VALUES(
    #{bsns_req_no}
   <if test='secu01_yn != null'> , #{secu01_yn} </if>
   <if test='secu02_yn != null'> , #{secu02_yn} </if>
   <if test='secu03_yn != null'> , #{secu03_yn} </if>
   <if test='secu04_yn != null'> , #{secu04_yn} </if>
   ,#{regst_syspayno}
   ,CURRENT
)
</insert>

<!-- 참여연구원 사전등록 수정 -->
<update id="updateResPareMngmtMstr" parameterType="kr.re.kitech.biz.res.app.vo.ResPareMngmtMstrVo">
UPDATE /* kr.re.kitech.biz.res.app.updateResPareMngmtMstr */
     resparemngmtmstr
SET <if test= 'prj_nm !=null'> prj_nm = #{prj_nm}, </if>       
    <if test= 'exclsv_agncy_nm !=null'> exclsv_agncy_nm = #{exclsv_agncy_nm}, </if>   
    <if test= 'bsns_cd_inout !=null'> bsns_cd_inout = #{bsns_cd_inout}, </if> 
    <if test= 'bsns_cd_ofic !=null'> bsns_cd_ofic = #{bsns_cd_ofic}, </if>  
    <if test= 'start_ymd !=null'> start_ymd = #{start_ymd}, </if>   
    <if test= 'cls_ymd !=null'> cls_ymd = #{cls_ymd}, </if> 
    <if test= 'bsns_req_no !=null'> bsns_req_no = #{bsns_req_no}, </if>  
    updt_syspayno = #{updt_syspayno},
    updt_daytm = SYSDATE
WHERE req_no = #{req_no}
</update>
<update id="updateResAppMast" parameterType="kr.re.kitech.biz.res.app.vo.ResAppMastVo">
UPDATE /* kr.re.kitech.biz.res.app.updateResAppMast */
      resappmast
   SET bsns_cd_inout = #{bsns_cd_inout}  -- 사업코드내외
     , bsns_cd_ofic  = #{bsns_cd_ofic}  -- 사업코드부처
     , bsns_cd_exclsv_agncy = #{bsns_cd_exclsv_agncy} -- 사업코드전담기관
     , bsns_cd_bsns = #{bsns_cd_bsns}  -- 사업코드사업
     , bsns_cd_detls_bsns = #{bsns_cd_detls_bsns}  -- 사업코드세부사업
     , req_ymd = TO_CHAR(SYSDATE, '%Y%m%d')
      <if test='prj_nm != null' > , prj_nm = #{prj_nm} /*과제명 */ </if> 
      <if test='prj_eng_nm != null' > , prj_eng_nm = #{prj_eng_nm} /* 과제영문명 */ </if> 
      <if test='tot_resch_amt != null' > , tot_resch_amt = #{tot_resch_amt} </if>
      <if test='suply_value != null' > , suply_value = #{suply_value}   </if>
      <if test='tax_amt != null' > , tax_amt = #{tax_amt}       </if>
     , resch_rspns_main = #{resch_rspns_main}   /* 연구책임자 */
     , tot_resch_prd_orign_ymd  = #{tot_resch_prd_orign_ymd}   /* 총연구기간시작일자 */
     , tot_resch_prd_cls_ymd    = #{tot_resch_prd_cls_ymd}   /* 총연구기간종료일자 */
     , tot_prj_yrs = #{tot_prj_yrs} /* 총과제년수*/
     , step_resch_prd_orign_ymd  = #{step_resch_prd_orign_ymd}   /* 현단계 연구기간시작일자 */
     , step_resch_prd_cls_ymd    = #{step_resch_prd_cls_ymd}   /* 현단계 연구기간종료일자*/
     , cur_step = #{cur_step} /* 현단계*/
      <if test='thyr_resch_prd_orign_ymd != null' > , thyr_resch_prd_orign_ymd = #{thyr_resch_prd_orign_ymd} /* 당해연구기간시작일자*/ </if> 
      <if test='thyr_resch_prd_cls_ymd != null' > , thyr_resch_prd_cls_ymd = #{thyr_resch_prd_cls_ymd} /* 당해연구기간종료일자*/ </if> 
      <if test='req_state != null' > , req_state  = #{req_state} /* 신청상태*/ </if> 
      <if test='prj_regst_yn != null' > , prj_regst_yn  = #{prj_regst_yn} /* 과제등록여부*/ </if> 
      <if test='dev_goal != null' > , dev_goal = #{dev_goal} /* 개발목표*/ </if> 
      <if test='kwd_krchar != null' > , kwd_krchar = #{kwd_krchar} /* 키워드한글*/ </if> 
      <if test='kwd_eng != null' > , kwd_eng = #{kwd_eng} /* 키워드영문*/ </if> 
      <if test='secrt_prj_ex != null' > , secrt_prj_ex  = #{secrt_prj_ex} /* 보안과제유무*/ </if> 
      <if test='pre_plan_prj != null' > , pre_plan_prj  = #{pre_plan_prj} /* 선행기획과제*/ </if> 
      <if test='middle_attach_file != null' > , middle_attach_file = #{middle_attach_file} /* 사업계획서*/ </if> 
      <if test='bsns_notice_attach_file_no != null' > , bsns_notice_attach_file_no  = #{bsns_notice_attach_file_no} /* 사업공고*/ </if> 
      <if test='bsns_notice_no != null' > , bsns_notice_no = #{bsns_notice_no} /* 공고번호*/ </if> 
      <if test='intrn_use_ex != null' > , intrn_use_ex = #{intrn_use_ex} /* 국제공동연구과제구분*/ </if> 
      <if test='note_use_ex != null' > , note_use_ex = #{note_use_ex} /* 연구노트사용유무*/ </if> 
      <if test='note_type_cd != null' > , note_type_cd = #{note_type_cd} /* 연구노트구분*/ </if> 
      <if test='prj_card_clsf != null' > , prj_card_clsf = #{prj_card_clsf} /* 과제구분*/ </if> 
      <if test='threefive != null' > , threefive = #{threefive} /* 3책5공여부*/  </if> 
      <if test='threefive_clsf != null'> , threefive_clsf = #{threefive_clsf} /* 3책5공 제외기준 */</if> 
      <if test='consider != null' > , consider = #{consider} /* 사업조정회의 심의여부여부 */ </if> 
      <if test='consider_clsf != null'> , consider_clsf = #{consider_clsf} /* 사업조정회의 심의여부 제외기준 */ </if> 
     , tax_cd = #{tax_cd}  -- 과세여부
      <if test='tax_free_item != null and tax_free_item !=""'> 
        , tax_free_item = #{tax_free_item} /* 비과세항목 */
        , tax_item = ''
      </if>  
      <if test='tax_item != null and tax_item != ""'> 
        , tax_item = #{tax_item} /* 과세항목 */
        , tax_free_item = '' 
      </if> 
      <if test='cmpy_yn != null'> , cmpy_yn = #{cmpy_yn}  </if> 
      <if test='wrk_clsf != null'> , wrk_clsf = #{wrk_clsf} </if> 
     , total_res_amt = #{total_res_amt}
     , step_res_amt = #{step_res_amt}
      <if test='part_clsf != null'> , part_clsf = #{part_clsf} </if> 
      <if test='intgr_mngmt_unit != null'> , intgr_mngmt_unit = #{intgr_mngmt_unit} </if> 
     , updt_syspayno = #{updt_syspayno}    -- 수정시스템개인번호
     , updt_daytm = SYSDATE  -- 수정일시
WHERE bsns_req_no = #{bsns_req_no} -- 사업신청번호
</update>

<!-- 수행과제 보안등급 분류 및 심사기준 수정 -->
<update id="updateResAppSecurity" parameterType="kr.re.kitech.biz.res.app.vo.ResAppMastVo">
UPDATE /* kr.re.kitech.biz.res.app.updateResAppSecurity */
     resappsecurity
SET <if test='secu01_yn != null'> secu01_yn = #{secu01_yn}, </if>
    <if test='secu02_yn != null'> secu02_yn = #{secu02_yn}, </if>
    <if test='secu03_yn != null'> secu03_yn = #{secu03_yn}, </if>
    <if test='secu04_yn != null'> secu04_yn = #{secu04_yn}, </if>  
    updt_syspayno = #{updt_syspayno},
    updt_daytm = CURRENT
WHERE bsns_req_no = #{bsns_req_no}
</update>

<!-- 선행연구과제 삭제 -->
<delete id="deleteResAppPrePrj" parameterType="java.lang.String">
DELETE /* kr.re.kitech.biz.res.app.deleteResAppPrePrj */
 FROM resapppreprj
WHERE bsns_req_no = #{bsns_req_no}
</delete>

<!-- 선행연구과제 입력 -->
<insert id="insertResAppPrePrj" parameterType="kr.re.kitech.biz.res.app.vo.ResAppPrePrjVo">
INSERT /* kr.re.kitech.biz.res.app.insertResAppPrePrj */
  INTO resapppreprj(
    bsns_req_no,
    seq,
    accnt_no,
    contr_rt,
    regst_syspayno,
    regst_daytm
  ) VALUES(
    #{bsns_req_no},
    #{seq},
    #{accnt_no},
    #{contr_rt},
    #{regst_syspayno},
    CURRENT
    )
</insert>

<!-- 참여연구원 삭제 -->
<delete id="deleteResAppPare" parameterType="java.lang.String">
DELETE /* kr.re.kitech.biz.res.app.deleteResAppPare */
  FROM resapppare
WHERE bsns_req_no = #{bsns_req_no}
</delete>

<!-- 참여연구원 저장 -->
<insert id="insertResAppPare" parameterType="kr.re.kitech.biz.res.app.vo.ResAppPareVo">
INSERT /* kr.re.kitech.biz.res.app.insertResAppPare */
  INTO resapppare
  (
      bsns_req_no                -- 사업신청번호
    , syspayno                   -- 시스템개인번호
    , nm                         -- 성명
    , reschr_clsf                -- 연구원구분
    , psnexpns_clsf              -- 인건비구분
    , attnce_prd_orign_ymd       -- 참여기간시작일자
    , attnce_prd_cls_ymd         -- 참여기간종료일자
    , psnexpns_month_unit_price  -- 인건비월단가
    , cash_attnce_rt             -- 현금참여율
    , goods_attnce_rt            -- 현물참여율
<if test='respn_rts != null'> , respn_rts  /* 책임비율*/ </if>
    , cash_amt                   -- 현금금액
    , goods_amt                  -- 현물금액
<if test='apprvl_req_no != null'> , apprvl_req_no  /* 전자결재신청번호*/ </if>
<if test='apprvl_state != null'> , apprvl_state    /*  승인상태*/ </if>
<if test='adjst_attnce_rt != null'> , adjst_attnce_rt  /*  조정참여율*/ </if>
    , regst_syspayno             -- 등록시스템개인번호
    , regst_daytm                -- 등록일시
  )
  VALUES
  (
      #{bsns_req_no}                -- 사업신청번호
    , #{syspayno}                   -- 시스템개인번호
    , #{nm}                         -- 성명
    , #{reschr_clsf}                -- 연구원구분
    , #{psnexpns_clsf}              -- 인건비구분
    , #{attnce_prd_orign_ymd}       -- 참여기간시작일자
    , #{attnce_prd_cls_ymd}         -- 참여기간종료일자
    , #{psnexpns_month_unit_price}  -- 인건비월단가
    , #{cash_attnce_rt}             -- 현금참여율
    , #{goods_attnce_rt}            -- 현물참여율
<if test='respn_rts != null'> , #{respn_rts}  /* 책임비율*/ </if>
    , #{cash_amt}                   -- 현금금액
    , #{goods_amt}                  -- 현물금액
<if test='apprvl_req_no != null'> , #{apprvl_req_no}  /* 전자결재신청번호*/ </if>
<if test='apprvl_state != null'> , #{apprvl_state}    /*  승인상태 */ </if>
<if test='adjst_attnce_rt != null'> , #{adjst_attnce_rt}  /*  조정참여율 */ </if>
    , #{regst_syspayno}             -- 등록시스템개인번호
    , SYSDATE                   -- 등록일시
  )
</insert>

<!-- 사업신청 연구비 저장 -->
<update id="mergeResAppBugt" parameterType="kr.re.kitech.biz.res.app.vo.ResAppBugtVo">
MERGE /* kr.re.kitech.biz.res.app.mergeResAppBugt */
 INTO resappbugt AS a
USING dual AS b ON 1=1 AND a.bsns_req_no = #{bsns_req_no} AND a.bugt_item = #{bugt_item} AND a.anal = #{anal}
WHEN MATCHED THEN
  UPDATE 
     SET gov_cntrbamt   = #{gov_cntrbamt}        -- 정부출연금
       , cmpy_cash      = #{cmpy_cash}        -- 기업현금
       , cmpy_goods     = #{cmpy_goods}        -- 기업현물
       , contpat_goods  = #{contpat_goods}        -- 상대국현물
       , local_gov_cash = #{local_gov_cash}        -- 지방정부현금
       , univ_cash      = #{univ_cash}        -- 대학현금
       , etc_cash       = #{etc_cash}        -- 기타현금
       , start_ymd      = #{start_ymd}        -- 시작일자
       , cls_ymd        = #{cls_ymd}        -- 종료일자
       , cash_tot_amt   = #{cash_tot_amt}        -- 현금총액
       , goods_tot_amt  = #{goods_tot_amt}        -- 현물총액
       , tot_amt = #{tot_amt}
       , updt_syspayno  = #{updt_syspayno}        -- 수정시스템개인번호
       , updt_daytm     = SYSDATE  -- 수정일시
   
WHEN NOT MATCHED THEN
   INSERT (
        bsns_req_no     -- 사업신청번호
      , bugt_item       -- 예산항목
      , anal            -- 년차
      , gov_cntrbamt    -- 정부출연금
      , cmpy_cash       -- 기업현금
      , cmpy_goods      -- 기업현물
      , contpat_goods   -- 상대국현물
      , local_gov_cash  -- 지방정부현금
      , univ_cash       -- 대학현금
      , etc_cash        -- 기타현금      
      , start_ymd       -- 시작일자
      , cls_ymd         -- 종료일자
      , cash_tot_amt    -- 현금총액
      , goods_tot_amt   -- 현물총액
      , tot_amt
      , regst_syspayno  -- 등록시스템개인번호
      , regst_daytm     -- 등록일시
    )
    VALUES
    (
        #{bsns_req_no}        -- 사업신청번호
      , #{bugt_item}          -- 예산항목
      , #{anal}               -- 정부출연금
      , #{gov_cntrbamt}       -- 기업현금
      , #{cmpy_cash}          -- 기업현물
      , #{cmpy_goods}         -- 상대국현물
      , #{contpat_goods}      -- 지방정부현금
      , #{local_gov_cash}     -- 대학현금
      , #{univ_cash}          -- 기타현금
      , #{etc_cash}           -- 년차
      , #{start_ymd}          -- 시작일자
      , #{cls_ymd}            -- 종료일자
      , #{cash_tot_amt}       -- 정부출연금 +기업현금+지방정부현금+대학현금+기타현금
      , #{goods_tot_amt}      -- 현물총액(기업현물+기타현물)
      , #{tot_amt}
      , #{regst_syspayno}     -- 등록시스템개인번호
      , SYSDATE         -- 등록일시
    )
</update>

<!-- 사업선정결과 저장 -->
<update id="updateResAppMastSeltRst" parameterType="kr.re.kitech.biz.res.app.vo.ResAppMastVo">
UPDATE /* kr.re.kitech.biz.res.app.updateResAppMastSeltRst */
        resappmast
   SET selt_rst = #{selt_rst}, -- 선정결과
     <if test='selt_ymd != null'> selt_ymd = #{selt_ymd}, /*선정일자 */ </if>
     <if test='resn_and_unusual_item != null'> resn_and_unusual_item = #{resn_and_unusual_item}, /* 사유및특이사항 */ </if>
     <if test='selt_score != null'> selt_score = #{selt_score}, /* 선정점수 */ </if>
     <if test='selt_attach_file_no != null'> selt_attach_file_no = #{selt_attach_file_no}, </if> 
       updt_syspayno = #{updt_syspayno},   -- 수정시스템개인번호
       updt_daytm = SYSDATE  -- 수정일시
 WHERE bsns_req_no = #{bsns_req_no} -- 사업신청번호
</update>

<!-- 선정과제 이메일 발송 후 메일발송여부(선정시) 수정 -->
<update id="updateResAppMastMailSend" parameterType="java.lang.String">
-- 선정과제 이메일 발송 후 메일발송여부(선정시) 수정
UPDATE /* kr.re.kitech.biz.res.app.updateResAppMastMailSend */
      resappmast
   SET mail_send_yn = 'Y'
 WHERE bsns_req_no = #{bsns_req_no}
</update>

<!-- 사업신청 삭제 -->
<delete id="deleteResBsnsReq" parameterType="java.lang.String">
DELETE /* kr.re.kitech.biz.res.app.deleteResBsnsReq */
  FROM resappmast
  WHERE bsns_req_no = #{bsns_req_no}
;
DELETE FROM resappbugt 
 WHERE bsns_req_no = #{bsns_req_no}
 ;
DELETE FROM resappsecurity  -- 수행과제 보안등급 분류 및 심사기준 삭제
WHERE bsns_req_no = #{bsns_req_no}
;
</delete>

<!-- 사업신청 삭제 시 참여연구원사전등록에 매핑된 신청번호 빈값처리 -->
<update id="updateResPareMngmtMstrDel" parameterType="kr.re.kitech.biz.res.app.vo.ResAppSrcVo">
UPDATE /* kr.re.kitech.biz.res.app.updateResPareMngmtMstrDel */
      resparemngmtmstr
SET bsns_req_no = '',
    updt_syspayno = #{updt_syspayno},
    updt_daytm = SYSDATE
WHERE bsns_req_no = #{bsns_req_no}
</update>
</mapper>