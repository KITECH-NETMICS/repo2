<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.re.kitech.biz.fin.spm">
<!-- 경비결의 목록 조회 -->
<select id="selectFspSlipHList" resultType="kr.re.kitech.biz.fin.spm.vo.FinSpmSlipVo" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectFspSlipHList */
       a.unslip_no
     , a.slip_ymd
     , a.slip_typ_cd
     , a.wrte_psn
     , (SELECT z.nm FROM humbasicinfo z WHERE a.wrte_psn = z.syspayno) AS wrte_psn_nm
     , a.rmk
     , c.slip_no
     , c.decsn_psn
     , (SELECT z.nm FROM humbasicinfo z WHERE c.decsn_psn = z.syspayno) AS decsn_psn_nm
     , c.accnt_ymd 
     , SUM(CASE b.base_debit_cr WHEN '1' THEN b.unslip_amt ELSE 0 END) AS dr_amt
     , SUM(CASE b.base_debit_cr WHEN '2' THEN b.unslip_amt ELSE 0 END) AS cr_amt
     , d.apr_state
     , fun_xodxcommst_cd_nm(apr_state, 0) apr_state_nm
  FROM fspsliph a 
  JOIN fspslipd b ON a.unslip_no = b.unslip_no
  LEFT JOIN fspslipdecsnh c ON a.slip_no = c.slip_no
  LEFT JOIN xomxintfatab d ON a.unslip_no = d.req_no
 WHERE a.slip_ymd BETWEEN #{from_ymd} AND #{to_ymd}
 <if test='unslip_no_list != null and unslip_no_list != ""'> AND a.unslip_no IN 
  <foreach item="item" index="index" collection="unslip_no_list.split(',')" open="(" separator="," close=")">
     '${item}'
  </foreach>
 </if>
 <if test='slip_typ_cd != null and slip_typ_cd != ""'> AND a.slip_typ_cd = #{slip_typ_cd} </if>
 <if test='decsn_ex != null and decsn_ex != ""'> AND a.decsn_ex = #{decsn_ex} </if>
 <if test='wrte_psn != null and wrte_psn != ""'> AND a.wrte_psn = #{wrte_psn} </if>
 <if test='unslip_no != null and unslip_no != ""'> AND a.unslip_no = #{unslip_no} </if>
 <if test='slip_no != null and slip_no != ""'> AND a.slip_no = #{slip_no} </if>
 <choose>
 	<when test='inqr_clsf != null and inqr_clsf == "110"'> AND a.slip_typ_cd NOT IN ('113', '115', '117') </when>
 	<otherwise> AND a.slip_typ_cd IN ('113', '117') </otherwise>
 </choose>
 GROUP BY a.unslip_no, a.slip_ymd, a.slip_typ_cd, a.wrte_psn, a.rmk, c.slip_no, c.decsn_psn, c.accnt_ymd, d.apr_state
 ORDER BY a.unslip_no
</select>

<!-- 카드결의 카드정보, 일반결의, 회의록 카드내역 팝업 조회 -->
<select id="selectFinExpnsSlipCardList" resultType="kr.re.kitech.biz.fin.spm.vo.CardInfoVo" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectFinExpnsSlipCardList */
       a.cardno
     , b.card_no
     , b.card_knd
     , b.card_clsf
     , a.use_ymd
     , a.apprvl_no
     , a.use_amt
     , a.supply_amt
     , a.tax_amt
     , a.un_amt
     , a.joinsto_nm
     , a.bsns_psn_regst_no
     , a.shop_addr1
     , a.shop_addr2
     , a.rmk
     , c.nm
     , a.adjstyn
     , DECODE(a.adjstyn, 'Y', DECODE(a.confyn, 'N', NVL(a.adjst_accnt_cd, x.mngmt_item_2), ''), DECODE(a.confyn, 'N', x.mngmt_item_1, a.conf_accnt_cd)) AS conf_accnt_cd
     , d.accnt_cd_abbr AS accnt_cd_nm
     , dofogu
  FROM fbacard b 
  JOIN ( /* 연구비 BC */
        SELECT cardno 
             , TRIM(auth_date || auth_time) AS use_ymd
             , use_no AS apprvl_no
             , auth_amt - NVL(cnlamt, 0) AS use_amt
             , auth_amt - NVL(cnlamt, 0) - NVL(auth_tax, 0) AS supply_amt
             , NVL(auth_tax, 0) AS tax_amt
             , auth_amt - NVL(cnlamt,0)- NVL(compcost,0) AS un_amt /* 미처리금액 */
             , mer_nm     AS joinsto_nm
             , mer_buz_no AS bsns_psn_regst_no
             , shop_addr1 
             , shop_addr2 
             , rmk
             , NVL(adjstyn, 'N') AS adjstyn
             , NVL(confyn, 'N') AS confyn
             , adjst_accnt_cd
             , conf_accnt_cd
             , DECODE(a.ab_lo_clss,'N', 'F', 'D') AS dofogu 
          FROM fbcrndauth a
         WHERE (cnldate IS NULL OR cnldate = '')
         <choose>
            <when test='inqr_clsf != null and inqr_clsf == "meet"'>
               AND NOT EXISTS (
                             SELECT  ''
                             FROM    fspmeetevidh d
                             WHERE   d.card_knd ='FAJ002'
                             AND     d.card_clsf='FAI003'
                             AND     d.cardno = a.cardno
                             AND     d.evid_apprno = a.use_no
                         )
            </when>
            <otherwise> AND auth_amt - NVL(cnlamt, 0) - NVL(compcost,0) > 0 </otherwise>
         </choose>
         <if test='cardno != null and cardno !=""'> AND cardno = #{cardno} </if>
         <if test='card_clsf != null and card_clsf !=""'> AND 'FAI003' = #{card_clsf} </if>
         <if test='card_knd != null and card_knd !=""'> AND 'FAJ002' = #{card_knd} </if>
         <if test='apprvl_no != null and apprvl_no !=""'> AND use_no = #{apprvl_no} </if>
         <if test='from_ymd != null and from_ymd !=""'> AND auth_date BETWEEN #{from_ymd} AND #{to_ymd} </if>
         UNION ALL
         /* 신한 연구비*/
        SELECT cardno 
             , rectime  AS use_ymd
             , apprno   AS apprvl_no
             , recamt - NVL(cnlamt,0)                  AS use_amt
             , recamt - NVL(cnlamt,0) - NVL(exttax, 0) AS supply_amt
             , NVL(exttax, 0) AS tax_amt
             , recamt - NVL(cnlamt,0) - NVL(compcost,0) AS un_amt
             , shopname  AS joinsto_nm
             , shopno AS bsns_psn_regst_no
             , shopaddr2 AS shop_addr1
             , '' AS shop_addr2
             , rmk
             , NVL(adjstyn, 'N') AS adjstyn
             , NVL(confyn, 'N') AS confyn
             , adjst_accnt_cd
             , conf_accnt_cd
             , dofogu
          FROM flgrnd_recogn a
         WHERE (cnldate IS NULL OR cnldate = '')
           AND shopname IS NOT NULL
           AND recamt - NVL(cnlamt,0)- NVL(compcost,0) > 0
         <if test='inqr_clsf != null and inqr_clsf == "meet"'>
           AND  NOT EXISTS (
                          SELECT ''
                          FROM   fspmeetevidh d
                          WHERE  d.card_knd  in ('FAJ003', 'FAJ006') 
                          AND    d.card_clsf='FAI003'
                          AND    d.cardno = a.cardno
                          AND    d.evid_apprno = a.apprno
                      )
         </if>
         <if test='cardno != null and cardno !=""'> AND cardno = #{cardno} </if>
         <if test='card_clsf != null and card_clsf !=""'> AND 'FAI003' = #{card_clsf} </if>
         <if test='card_knd != null and card_knd !=""'> AND #{card_knd} IN ('FAJ003', 'FAJ006') </if>
         <if test='apprvl_no != null and apprvl_no !=""'> AND apprno = #{apprvl_no} </if>
         <if test='from_ymd != null and from_ymd !=""'> AND rectime <![CDATA[ >= ]]> #{from_ymd} AND rectime <![CDATA[ <= ]]> #{to_ymd}||'999999'</if>
         UNION ALL
         /* 법인카드 OR BC(보탬e-예치) OR BC(보탬e-비예치) */
        SELECT cardno 
             , rectime  AS use_ymd
             , apprno               AS apprvl_no
             , recamt - NVL(cnlamt,0)                  AS use_amt
             , recamt - NVL(cnlamt,0) - NVL(tax_amt, 0) AS supply_amt
             , NVL(tax_amt, 0) AS tax_amt
             , recamt - NVL(cnlamt,0) - NVL(compcost,0) AS un_amt
             , shopname  AS joinsto_nm
             , shopno AS bsns_psn_regst_no
             , merchantaddr1 AS shop_addr1
             , merchantaddr2 AS shop_addr2
             , rmk
             , NVL(adjstyn, 'N') AS adjstyn
             , NVL(confyn, 'N') AS confyn
             , adjst_accnt_cd
             , conf_accnt_cd
             , dofogu  /* 국내외여부 */
          FROM fbc_recogn a
         WHERE (cnldate IS NULL OR cnldate = '')
         <choose>
            <when test='inqr_clsf != null and inqr_clsf == "meet"'>
                AND NOT EXISTS (
                            SELECT ''
                            FROM  fspmeetevidh d
                            WHERE (d.card_clsf='FAI001' OR (d.card_clsf ='FAI003' AND (d.card_knd ='FAJ008' OR d.card_knd ='FAJ009')))
                            AND   d.cardno = a.cardno
                            AND   d.evid_apprno = a.apprno
                        )
            </when>
            <otherwise> AND recamt - NVL(cnlamt,0)- NVL(compcost,0) > 0 </otherwise>
         </choose>
         <if test='cardno != null and cardno !=""'> AND cardno = #{cardno} </if>
         <if test='card_clsf != null and card_clsf !=""'> AND ('FAI001' = #{card_clsf} OR ('FAI003' = #{card_clsf} AND ('FAJ008' = #{card_knd} OR 'FAJ009' = #{card_knd}))) </if>
         <if test='apprvl_no != null and apprvl_no !=""'> AND apprno = #{apprvl_no} </if>
         <if test='from_ymd != null and from_ymd !=""'> AND rectime <![CDATA[ >= ]]> #{from_ymd} AND rectime <![CDATA[ <= ]]> #{to_ymd} ||'999999' </if>
         UNION ALL
        /* 통합이지바로 */
        SELECT a.cardno 
             , a.rectime  AS use_ymd
             , a.apprno AS apprvl_no
             , a.demcost - NVL(d.demcost, 0) AS use_amt
             , a.demcost - NVL(a.exttax, 0) - NVL(d.demcost, 0) - NVL(d.exttax, 0) AS supply_amt
             , NVL(a.exttax, 0) - NVL(d.exttax, 0) AS tax_amt
             , a.demcost - NVL(d.demcost, 0) - NVL(a.compcost, 0) AS un_amt
             , a.mchtnm AS joinsto_nm
             , a.bsnrgn AS bsns_psn_regst_no
             , a.mchtadr1 AS shop_addr1
             , a.mchtadr2 AS shop_addr2
             , '' AS rmk
             , NVL(a.adjstyn, 'N') AS adjstyn
             , NVL(a.confyn, 'N') AS confyn
             , a.adjst_accnt_cd
             , a.conf_accnt_cd
             , DECODE(a.foreignyn, 'Y', 'F', 'D') AS dofogu
          FROM ezbaro_cardorgn a  
          LEFT JOIN (
                     SELECT SUM(demcost) AS demcost
                          , SUM(exttax) AS exttax 
                          , MAX(purchdt) AS purchdt 
                          , cardno
                          , apprno 
                       FROM ezbaro_cardorgn 
                      WHERE purchdivcd = '02'
                      GROUP BY cardno, apprno
                    ) d ON a.cardno = d.cardno AND a.apprno = d.apprno
         WHERE a.purchdivcd = '01'
           AND a.demcost - NVL(d.demcost, 0) - NVL(a.compcost, 0) > 0
         <if test='inqr_clsf != null and inqr_clsf == "meet"'>
           AND  NOT EXISTS (
                        SELECT ''
                          FROM fspmeetevidh e
                         WHERE e.card_knd = 'FAJ007'
                           AND e.card_clsf = 'FAI003'
                           AND e.cardno = a.cardno
                           AND e.evid_apprno = a.apprno
                  )
         </if>
         <if test='cardno != null and cardno !=""'> AND a.cardno = #{cardno} </if>
         <if test='card_clsf != null and card_clsf !=""'> AND 'FAI003' = #{card_clsf} </if>
         <if test='card_knd != null and card_knd !=""'> AND 'FAJ007' = #{card_knd} </if>
         <if test='apprvl_no != null and apprvl_no !=""'> AND a.apprno = #{apprvl_no} </if>
         <if test='from_ymd != null and from_ymd !=""'> AND rectime <![CDATA[ >= ]]> #{from_ymd} AND rectime <![CDATA[ <= ]]> #{to_ymd}||'999999' </if>
   ) a ON a.cardno = b.cardno
  JOIN humbasicinfo c ON b.keep_charg = c.syspayno
  JOIN xodxcommst x ON b.card_clsf = x.cd AND x.cd_clsf = 'FAI'
  LEFT JOIN xodfaccnt d ON d.accnt_cd = DECODE(a.adjstyn, 'Y', DECODE(a.confyn, 'N', NVL(a.adjst_accnt_cd, x.mngmt_item_2), ''), DECODE(a.confyn, 'N', x.mngmt_item_1, a.conf_accnt_cd))
 WHERE 1=1
 <if test='card_no != null and card_no !=""'> AND b.card_no LIKE '%'||#{card_no} </if>
 <if test='keep_charg != null and keep_charg !=""'> AND b.keep_charg = #{keep_charg} </if>
 ORDER BY a.use_ymd
</select>

<!-- 결의서 헤더 조회 -->
<select id="selectFspSlipH" resultType="kr.re.kitech.biz.fin.com.vo.FspSlipHVo" parameterType="java.lang.String">
SELECT /* kr.re.kitech.biz.fin.spm.selectFspSlipH */
      a.unslip_no
     , a.slip_typ_cd
     , a.wrte_dept
     , b.dept_nm
     , b.fomat_unit
     , a.wrte_dept_new_ymd
     , a.wrte_psn
     , c.empno
     , c.nm
     , c.ext_no
     , a.slip_ymd
     , a.decsn_ex
     , a.rmk
     , DECODE(a.decsn_ex, 'Y', '확정', '미확정') decsn_ex_nm
     , a.slip_no
     , a.accnt_ymd
     , x.apr_state
     , 'U' AS cud_type
  FROM fspsliph a
  JOIN xodhdeptinfo b ON a.wrte_dept = b.dept_cd AND NVL(b.abol_ymd, '') = ''
  LEFT JOIN xomxintfatab x ON a.unslip_no = x.req_no
  LEFT JOIN humbasicinfo c ON a.wrte_psn = c.syspayno
 WHERE a.unslip_no = #{unslip_no}
</select>

<!-- 카드경비결의 목록 조회 -->
<select id="selectFspSlipDList" resultType="kr.re.kitech.biz.fin.com.vo.FspSlipDVo" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectFspSlipDList */
       a.unslip_no
     , a.unslip_odr
     , a.base_debit_cr
     , a.journ_cd
     , a.journ_odr
     , a.accnt_no
     , c.accnt_no_nm
     , CASE WHEN a.accnt_no ='FF210001' THEN a.accnt_rspns ELSE c.accnt_rspns END AS accnt_rspns
     , c.tax_cd
     , c.mngmt_clsf
     , c.start_ymd
     , c.cls_ymd
     , c.itm_solve_base
     , a.accnt_cd
     , d.accnt_cd_abbr AS accnt_cd_nm
     , a.expns_cd
     , f.expns_cd_nm
     , TRIM(a.ctrl_no) AS ctrl_no
     , a.unslip_amt + NVL(a.tax_amt,0) AS total_amt  /* 총액 */
     , a.unslip_amt + NVL(a.tax_amt,0) AS bf_total_amt
     , a.unslip_amt 
     , a.unslip_amt AS bf_unslip_amt /* 이전 결의금액 */
     , NVL(a.tax_amt,0) AS tax_amt  
     , TRIM(a.ramt_mngmt_1) AS ramt_mngmt_1
     , TRIM(a.ramt_mngmt_2) AS ramt_mngmt_2
     , a.rmk_1
     , a.rmk_2
     , a.rmk_3
     , a.evid_cd
     , TRIM(a.bill_no) AS bill_no
     , TRIM(a.attach_file_no) AS attach_file_no
     , a.req_no
     , a.accnt_no_clsf
     , a.part_all_clsf
    <if test='(slip_typ_cd != null and slip_typ_cd == "117") or (base_debit_cr != null and base_debit_cr == "2")'>
     , h.card_no
     , h.card_knd
     , h.card_clsf
     , b.use_ymd
     , b.apprvl_no
    </if>
    <if test='slip_typ_cd != null and slip_typ_cd == "113"'>
    , g.regs_date  AS issu_ymd
    </if>
     , TRIM(a.occr_slip_no) AS occr_slip_no
     , a.occr_slip_odr 
     , 'U' AS cud_type
     , fun_res_prj_evid(a.accnt_no, a.expns_cd, 1) AS evid_yn
     , fun_res_prj_evid(a.accnt_no, a.expns_cd, 2) AS service_id
  FROM fspslipd a 
  JOIN resbgacctm c ON a.accnt_no = c.accnt_no
  JOIN xodfaccnt d ON a.accnt_cd = d.accnt_cd
  JOIN xodfexpns f ON a.expns_cd = f.expns_cd
 <if test='(slip_typ_cd != null and slip_typ_cd == "117") or (base_debit_cr != null and base_debit_cr == "2")'>  
  LEFT JOIN fspsendreq b ON a.unslip_no = b.unslip_no AND a.unslip_odr = b.unslip_odr AND NVL(b.card_no,'') !=''
  LEFT JOIN fbacard h ON (b.card_no = h.card_no OR b.card_no = h.cardno)
 </if>  
 <if test='slip_typ_cd != null and slip_typ_cd == "113"'>
  LEFT JOIN ktx_issu_mstr g ON a.bill_no = g.issu_seqno
 </if>
 WHERE a.unslip_no = #{unslip_no} 
   AND (a.accnt_cd NOT IN ('11149015', '21025100') OR a.journ_cd IN ('Fn0130', 'Fn0140')) /* 재무처리 차변, 재무처리 대변 */
 <if test='base_debit_cr != null and base_debit_cr != ""'> AND a.base_debit_cr = #{base_debit_cr} </if>
 <if test='slip_typ_cd != null and slip_typ_cd == "117"'> AND a.base_debit_cr = '1' </if>
 <if test='slip_typ_cd != null and slip_typ_cd == "113"'>
   AND a.accnt_cd NOT IN ('21009010', '21009030', '21009070','21009090') /* 미지급 당좌, 미지급법인카드, 미지급RCMS, 미지급(e나라도움) */
 </if>
</select>

<!-- 카드결의 비용합계 -->
<select id="selectExpnsCardSum" resultType="kr.re.kitech.biz.fin.spm.vo.ExpnsAmtSummryVo" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectExpnsCardSum */
     ( SELECT NVL(SUM(unslip_amt + NVL(tax_amt,0)),0) 
         FROM fspslipd 
        WHERE accnt_no != 'FF030001'
          AND unslip_no = #{unslip_no} ) AS tot_expns_amt,
     ( SELECT NVL(SUM(unslip_amt),0)
         FROM fspslipd
        WHERE accnt_no = 'FF030001' 
          AND accnt_cd NOT IN ('11149015') -- 부가세대급금제외, 공제금액
          AND unslip_odr NOT IN ('995','996','997','998','999')
          AND unslip_no = #{unslip_no} ) AS tot_depst_amt,
     ( SELECT NVL(SUM(auth_amt) - SUM(NVL(cnlamt,0)),0)
         FROM fbcrndauth -- BC
        WHERE unslip_no = #{unslip_no} ) +
     ( SELECT NVL(SUM(recamt) - SUM(NVL(cnlamt,0)),0)
         FROM flgrnd_recogn -- 신한
        WHERE unslip_no = #{unslip_no} ) + 
     ( SELECT NVL(SUM(recamt) - SUM(NVL(cnlamt,0)),0)
         FROM fbc_recogn -- 법인
        WHERE unslip_no = #{unslip_no} ) +
     ( SELECT NVL(SUM(a.demcost) - SUM(NVL(b.demcost,0)),0)
         FROM ezbaro_cardorgn a-- 통합이지바로            
         LEFT JOIN (
                   SELECT  SUM(demcost) AS demcost, SUM(exttax) AS exttax ,MAX(purchdt) AS purchdt , cardno, apprno 
                   FROM ezbaro_cardorgn 
                   WHERE purchdivcd = '02'
                   GROUP BY cardno, apprno
                ) b ON a.cardno = b.cardno AND a.apprno = b.apprno
        WHERE a.unslip_no = #{unslip_no}
          AND a.purchdivcd = '01'
     ) AS tot_evid_amt
  FROM systables
 WHERE tabid = 1
</select>

<!-- 결의서 관리항목 조회 -->
<select id="selectFspSlipMngmtList" resultType="kr.re.kitech.biz.fin.com.vo.FspSlipMngmtVo" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectFspSlipMngmtList */
       b.unslip_no
     , b.unslip_odr
     , b.mngmt_item_cd
     , c.mngmt_item_nm
     , b.updt_possbl_yn
     , b.mngmt_detls_cd
     , b.mngmt_detls_nm
     , a.essen_ex
     , c.data_form
     , 'U' AS cud_type
  FROM fspslipmngmt b
  LEFT JOIN fbamngmtitem c ON b.mngmt_item_cd = c.mngmt_item_cd
  LEFT JOIN fbaaccntmngmt a ON a.accnt_cd = #{accnt_cd} AND b.mngmt_item_cd = a.mngmt_item_cd
 WHERE b.unslip_no = #{unslip_no} 
   AND b.unslip_odr = #{unslip_odr} 
 ORDER BY case when b.mngmt_item_cd='4043' then 999 else a.slip_prt_seq end
</select>

<!-- 경비결의 카드내역 조회 -->
<select id="selectExpnsCardSlip" resultType="kr.re.kitech.biz.fin.spm.vo.CardInfoVo" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo">
/* kr.re.kitech.biz.fin.spm.selectExpnsCardSlip */
 /* 연구비 BC */
SELECT TRIM(auth_date || auth_time) AS use_ymd
     , use_no AS apprvl_no
     , auth_amt - NVL(cnlamt, 0) AS use_amt
     , auth_amt - NVL(cnlamt, 0) - NVL(auth_tax, 0) AS supply_amt
     , NVL(auth_tax, 0) AS tax_amt
     , auth_amt - NVL(cnlamt,0)- NVL(compcost,0) AS un_amt /* 미처리금액 */
     , mer_nm     AS joinsto_nm
     , shop_addr1 
     , shop_addr2 
  FROM fbcrndauth
 WHERE cardno = REPLACE(#{card_no},'-','')
   AND auth_date LIKE #{use_ymd} ||'%'
   AND use_no = #{apprvl_no} 
   AND unslip_no = #{unslip_no}
 UNION ALL
 /* 신한 연구비*/
SELECT rectime AS use_ymd
	 , apprno  AS apprvl_no
	 , recamt - NVL(cnlamt,0)                  AS use_amt
	 , recamt - NVL(cnlamt,0) - NVL(exttax, 0) AS supply_amt
	 , NVL(exttax, 0) AS tax_amt
	 , recamt - NVL(cnlamt,0) - NVL(compcost,0) AS un_amt
	 , shopname  AS joinsto_nm
	 , shopaddr2 AS shop_addr1
	 , '' AS shop_addr2
  FROM flgrnd_recogn
 WHERE cardno = REPLACE(#{card_no},'-','')
   AND rectime LIKE #{use_ymd} ||'%'
   AND apprno = #{apprvl_no}
   AND unslip_no = #{unslip_no}
 UNION ALL
 /* 법인카드 */
SELECT rectime AS use_ymd
	 , apprno  AS apprvl_no
	 , recamt - NVL(cnlamt,0)                  AS use_amt
	 , recamt - NVL(cnlamt,0) - NVL(tax_amt, 0) AS supply_amt
	 , NVL(tax_amt, 0) AS tax_amt
	 , recamt - NVL(cnlamt,0) - NVL(compcost,0) AS un_amt
	 , shopname  AS joinsto_nm
	 , merchantaddr1 AS shop_addr1
	 , merchantaddr2 AS shop_addr2
  FROM fbc_recogn
 WHERE cardno = REPLACE(#{card_no},'-','')
   AND rectime LIKE #{use_ymd} ||'%'
   AND apprno = #{apprvl_no} 
   AND unslip_no = #{unslip_no}
 UNION ALL
 /* 통합이지바로 */
SELECT rectime AS use_ymd
	 , a.apprno AS apprvl_no
	 , a.demcost - NVL(d.demcost, 0) AS use_amt
	 , a.demcost - NVL(a.exttax, 0) - (NVL(d.demcost, 0) - NVL(d.exttax, 0)) AS supply_amt /* (승인금액-승인부가세) - (취소금액-취소부가세) */
	 , NVL(a.exttax, 0) - NVL(d.exttax, 0) AS tax_amt
	 , a.demcost - NVL(d.demcost, 0) - NVL(a.compcost, 0) AS un_amt
	 , a.mchtnm AS joinsto_nm
	 , a.mchtadr1 AS shop_addr1
	 , a.mchtadr2 AS shop_addr2
  FROM ezbaro_cardorgn a  
  LEFT JOIN (
			 SELECT SUM(demcost) AS demcost
				  , SUM(exttax) AS exttax 
				  , MAX(purchdt) AS purchdt 
				  , cardno
				  , apprno 
			   FROM ezbaro_cardorgn 
			  WHERE purchdivcd = '02' /* 취소 */
			  GROUP BY cardno, apprno
			) d ON a.cardno = d.cardno AND a.apprno = d.apprno
 WHERE a.purchdivcd = '01'
   AND a.cardno = REPLACE(#{card_no},'-','')
   AND a.rectime LIKE #{use_ymd} ||'%'
   AND a.apprno = #{apprvl_no}
   AND unslip_no = #{unslip_no}
</select>

<!-- 이지바로과제 증빙개수 조회 -->
<select id="selectFspItmEvidDetlsCnt" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo" resultType="int">
select /* kr.re.kitech.biz.fin.spm.selectFspItmEvidDetlsCnt */
      count(1) cnt 
from   fspitmeviddetls
where  unslip_no = #{unslip_no}
and    unslip_odr = #{unslip_odr}
and    expns_cd = #{expns_cd}
</select>

<!-- 이지바로 과제 증빙(회의록) 저장 -->
<insert id="insertFspItmEvidDetlsBySel" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo">
INSERT /* kr.re.kitech.biz.fin.spm.insertFspItmEvidDetls */
   INTO fspitmeviddetls(
      unslip_no
    , unslip_odr
    , expns_cd
    , inout_clsf
    , syspayno
    , odr
    , dept_nm
    , nm
    , title_nm
    , plc_nm
    , start_ymd
    , cls_ymd
    , start_time
    , cls_time
    , regst_syspayno
    , regst_daytm)
SELECT a.unslip_no
     , a.unslip_odr
     , d.expns_cd
     , DECODE(c.user_clsf,'1', 'FEH001', 'FEH002')
     , c.syspayno
     , ROW_NUMBER() OVER(PARTITION BY d.unslip_no ORDER BY e.meet_req_no DESC) AS seq
     , c.dept_nm
     , c.nm
     , e.meet_subject
     , e.meet_place
     , e.meet_start_ymd
     , e.meet_cls_ymd
     , e.meet_start_time
     , e.meet_cls_time
     , d.regst_syspayno
     , SYSDATE
  FROM fspslipd d
  JOIN fspevidattach a ON a.unslip_no = d.unslip_no AND a.unslip_odr = d.unslip_odr
  JOIN fspevidrptkey b ON a.evid_mngmt_no= b.evid_mngmt_no AND a.evid_item_cd = b.evid_item_cd AND a.evid_mngmt_seq = b.evid_mngmt_seq 
  JOIN fspmeetmntd c ON b.key_val = c.meet_req_no
  JOIN fspmeetmnth e ON c.meet_req_no = e.meet_req_no
 WHERE a.unslip_no = #{unslip_no}
  <choose>
   <when test='unslip_odr !=null and unslip_odr != 0'> AND a.unslip_odr = #{unslip_odr} </when>
   <otherwise> AND NOT EXISTS ( SELECT 1 FROM fspitmeviddetls WHERE unslip_no = d.unslip_no AND unslip_odr = d.unslip_odr) </otherwise>
  </choose>
   AND a.evid_item_cd  = 'F014'
</insert>
<select id="selectFspSendReqList" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo" resultType="kr.re.kitech.biz.fin.com.vo.FspSendReqVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectFspSendReqList */
       a.unslip_no
     , a.unslip_odr
     , a.send_odr
     , a.pay_clsf
     , a.send_req_amt 
     , a.vend_cd
     , a.vend_nm
     , TRIM(a.syspayno) AS syspayno
     , a.bankaccnt_no
     , TRIM(a.bank) AS bank
     , a.depstr_nm
     , a.use_ymd
     , a.rmk
     , DECODE(pay_clsf, 'FAX010', b.nm, a.vend_nm) emp_vend
     , TRIM(a.is_account) AS is_account
     , 'U' AS cud_type
  FROM fspsendreq a
  LEFT JOIN humbasicinfo b ON a.syspayno = b.syspayno
 WHERE a.unslip_no = #{unslip_no}
   AND a.unslip_odr = #{unslip_odr}
 ORDER BY a.send_odr
</select>
<select id="selectKtxIssuMstrList" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo" resultType="kr.re.kitech.biz.fin.spm.vo.KtxIssuMstrVo">
SELECT DISTINCT /* kr.re.kitech.biz.fin.spm.selectKtxIssuMstrList */
       TRIM(a.issu_seqno) AS issu_seqno
     , a.issu_id
     , a.regs_date
     , a.vend_cd
     , a.selr_corp_nm AS vend_nm
     , a.totl_amt
     , a.chrg_amt AS chrg_amt
     , NVL(a.tax_amt,0) AS tax_amt
     , a.selr_corp_no AS bsns_psn_regst_no  
     , NVL(a.chrg_amt, 0) + NVL(a.tax_amt, 0) - NVL(a.trans_amt, 0) AS un_amt
     , DECODE(a.note3, '', a.issu_seqno, a.note3) AS note3
     , a.evid_cd
     , a.unslip_no
     , DECODE(NVL(a.tax_returns_yn,''), '', 'N', a.tax_returns_yn) AS tax_returns_yn
     , DECODE(a.pops_code, '01', '영수', '02', '청구','') AS pops_nm
 <if test='inqr_clsf != null and inqr_clsf != "tax_bill"'>
     , c.bankaccnt_no
     , c.depstr AS depstr_nm
     , c.tran_bank AS bank
     , DECODE(TRIM(NVL(b.tran_stop_ymd,'')),'','Y','N') AS tran_stop_yn
     , CASE WHEN d.issu_seqno IS NULL THEN 'N' ELSE 'Y' END AS detail_yn
 </if>
  FROM ktx_issu_mstr a
<if test='inqr_clsf != null and inqr_clsf == "tax_bill"'>
  /* 전자세금계산서 등록팝업 */
  LEFT JOIN ktx_issu_mstr e ON a.issu_id = e.bfo_issu_id 
</if>
<if test='inqr_clsf != null and inqr_clsf != "tax_bill"'>
  LEFT JOIN xodfvendaccnt c ON a.vend_cd = c.vend_cd AND main_bankaccnt_yn ='Y'
  LEFT JOIN xodfvend b ON a.vend_cd = b.vend_cd
  LEFT JOIN ktx_issu_detail d ON a.issu_seqno = d.issu_seqno
</if>
WHERE 1=1 
<if test='vend_nm != null and vend_nm != ""'> AND a.selr_corp_nm LIKE '%'||#{vend_nm}||'%' </if>
<if test='relat_no != null and relat_no != ""'> AND a.pur_con_user_id = #{relat_no} </if>
<if test='from_ymd != null and from_ymd != "" and to_ymd != null and to_ymd != ""'> AND a.regs_date BETWEEN #{from_ymd} AND #{to_ymd} </if>
<if test='bsns_psn_regst_no != null and bsns_psn_regst_no != ""'> AND a.selr_corp_no = #{bsns_psn_regst_no}</if>
<choose>
	<when test='inqr_clsf != null and inqr_clsf == "tax_bill"'> 
	  /* 전자세금계산서 등록팝업 */
	  AND NVL(e.issu_id, '') = ''
	</when>
	<when test='issu_seqno != null and issu_seqno != ""'> AND a.issu_seqno = #{issu_seqno} /* 결의서처리내역조회 */ </when>
	<otherwise>
	    /* 결의서 작성화면 */
		AND (NVL(a.chrg_amt, 0) + NVL(a.tax_amt, 0)) > NVL(a.trans_amt, 0)
		AND NOT EXISTS (SELECT * FROM ktx_issu_mstr WHERE bfo_issu_id = a.issu_seqno)
		AND (a.tax_returns_yn NOT IN ('Y','E') OR a.tax_returns_yn IS NULL)
		AND (NVL(a.unslip_no,'') = '' OR a.unslip_no = #{unslip_no})
	</otherwise>
</choose>
ORDER BY a.vend_cd, a.regs_date, issu_seqno ASC
</select>

<!-- 경비결의 일반 비용합계조회 -->
<select id="selectExpnsBillSum" resultType="kr.re.kitech.biz.fin.spm.vo.ExpnsAmtSummryVo" parameterType="java.lang.String">
SELECT /* kr.re.kitech.biz.fin.spm.selectExpnsBillSum */
       NVL(a.amt, 0) tot_expns_amt
     , NVL(b.amt, 0) tot_dedct_amt
     , NVL(c.amt,0) tot_send_amt
     , NVL(d.amt,0) tot_evid_amt
FROM  (SELECT SUM(unslip_amt + NVL(tax_amt,0)) amt 
       FROM   fspslipd 
       WHERE  accnt_no != 'FF030001'
       AND    unslip_no = #{unslip_no}
       ) a,   -- 차변금액     
      (SELECT SUM(unslip_amt) amt 
       FROM   fspslipd 
       WHERE  accnt_no = 'FF030001'  -- 대변공제금액
       AND  base_debit_cr = 2
       AND    unslip_odr <![CDATA[ < ]]> '998' -- 998 : 미지급RCMS, 999:미지급당좌
       AND    unslip_no = #{unslip_no}
      ) b,       
      (SELECT SUM(send_req_amt) amt 
       FROM   fspsendreq 
       WHERE  unslip_no = #{unslip_no}
      ) c,       
      (SELECT SUM(totl_amt) amt 
       FROM   ktx_issu_mstr
       WHERE  unslip_no = #{unslip_no}
       ) d
</select>

<!-- 일반결의 수입처리 회계코드 조회 -->
<select id="selectAccntCdByFinBsnsClsf" resultType="kr.re.kitech.biz.fin.std.vo.XodfAccntVo" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectAccntCdByFinBsnsClsf */
       a.fin_bsns_clsf
     , b.mngmt_item_5 AS accnt_cd
     , c.accnt_cd_abbr
     , c.caseby_adjst_ex
     , c.bond_debt_clsf
  FROM resbgacctm a
  JOIN xodxcommst b ON a.fin_bsns_clsf = b.cd
  LEFT JOIN xodfaccnt c ON b.mngmt_item_5 = c.accnt_cd
 WHERE a.accnt_no = #{accnt_no}
</select>

<!-- 이지바로 과제 증빙(회의록,교육,특근,전문가) 저장 -->
<insert id="insertFspItmEvidDetls" parameterType="kr.re.kitech.biz.fin.pop.vo.FspItmEvidDetlsVo">
INSERT /* kr.re.kitech.biz.fin.spm.insertFspItmEvidDetls */
   INTO fspitmeviddetls (
      unslip_no 
    , unslip_odr 
    , expns_cd 
    , inout_clsf 
    , syspayno 
    , odr 
    , dept_nm 
    , nm 
    , title_nm 
    , plc_nm 
    , start_ymd 
    , cls_ymd 
    , start_time 
    , cls_time 
    , rmk_1 
    , rmk_2 
    , meet_clsf
    , nation_inout_cd
    , confnation
    , confarea
    , regst_syspayno 
    , regst_daytm
    ) 
VALUES (
     #{unslip_no} 
    ,#{unslip_odr} 
    ,#{expns_cd} 
    ,#{inout_clsf} 
    ,#{syspayno} 
    ,#{odr} 
    ,#{dept_nm} 
    ,#{nm} 
    ,#{title_nm} 
    ,#{plc_nm} 
    ,#{start_ymd} 
    ,#{cls_ymd} 
    ,#{start_time} 
    ,#{cls_time} 
    ,#{rmk_1} 
    ,#{rmk_2} 
    ,#{meet_clsf}
    ,#{nation_inout_cd}
    ,#{confnation}
    ,#{confarea}
    ,#{regst_syspayno}
    , CURRENT
)
</insert>

<!-- 이지바로 신연구비 증빙 삭제 -->
<delete id="deleteFspItmEvidDetls" parameterType="kr.re.kitech.biz.fin.pop.vo.FspItmEvidDetlsVo">
DELETE /* kr.re.kitech.biz.fin.spm.deleteFspItmEvidDetls */
  FROM fspitmeviddetls
 WHERE unslip_no = #{unslip_no}
    AND unslip_odr = #{unslip_odr}
    AND expns_cd = #{expns_cd}
</delete>
<!-- 결재신청시 이지바로과제 증빙등록 체크 -->
<select id="selectEvidDetlsCntPreApr" parameterType="kr.re.kitech.biz.fin.spm.vo.FinSlipSearchVo" resultType="kr.re.kitech.biz.fin.spm.vo.PreAprCheckVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectEvidDetlsCntPreApr */
       a.unslip_no
     , a.unslip_odr
     , a.accnt_no
     , a.expns_cd
     , b.expns_cd_nm
     , b.service_id
     , DECODE(NVL(c.cnt,0), 0, 'N', 'Y') AS chk_yn
FROM fspslipd a
JOIN xodfexpns b ON a.expns_cd = b.expns_cd
LEFT JOIN (SELECT unslip_no
                , unslip_odr
                , expns_cd
                , COUNT(1) AS cnt
             FROM fspitmeviddetls 
            WHERE unslip_no = #{unslip_no}
            GROUP BY unslip_no, unslip_odr, expns_cd
          )c ON c.unslip_no = a.unslip_no AND c.unslip_odr=a.unslip_odr AND c.expns_cd=a.expns_cd
WHERE a.unslip_no = #{unslip_no}
AND a.base_debit_cr = '1'
AND fun_res_prj_evid(a.accnt_no, a.expns_cd, 1) = 'Y'
</select>
<!-- 결재신청시 계산서 금액 체크 -->
<select id="selectBillAmtPreApr" parameterType="kr.re.kitech.biz.fin.spm.vo.KtxIssuMstrComVo" resultType="kr.re.kitech.biz.fin.spm.vo.KtxIssuMstrComVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectBillAmtPreApr */
       a.chrg_amt
     , a.tax_amt
     , a.totl_amt
     , SUM(b.unslip_amt) AS trans_amt
  FROM ktx_issu_mstr a
  JOIN fspslipd b ON b.unslip_no = a.unslip_no AND b.base_debit_cr= '1' AND a.issu_seqno = b.bill_no
 WHERE a.issu_seqno = #{issu_seqno}
 GROUP BY 1,2,3
</select>
<select id="selectCardAmtPreApr" resultType="kr.re.kitech.biz.fin.spm.vo.KtxIssuMstrComVo" parameterType="kr.re.kitech.biz.fin.com.vo.FspSlipDVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectCardAmtPreApr */
       a.chrg_amt
     , a.tax_amt
     , SUM(NVL(c.unslip_amt,0) + NVL(c.tax_amt,0)) AS trans_amt
  FROM (
       SELECT auth_amt - NVL(cnlamt, 0)-NVL(auth_tax, 0) AS chrg_amt
            , NVL(auth_tax, 0) AS tax_amt
            , cardno
         FROM fbcrndauth /* 연구비 BC */
        WHERE 1=1
        <if test='card_clsf != null and card_clsf !=""'> AND 'FAI003' = #{card_clsf} </if>
        <if test='card_knd != null and card_knd !=""'> AND 'FAJ002' = #{card_knd} </if>
          AND cardno = REPLACE(#{card_no},'-','')
          AND auth_date LIKE #{use_ymd} ||'%'
          AND use_no = #{apprvl_no} 
        UNION ALL
        /* 신한 연구비*/
       SELECT recamt - NVL(cnlamt,0) -NVL(exttax, 0) AS chrg_amt
       	 , NVL(exttax, 0) AS tax_amt
         , cardno
         FROM flgrnd_recogn
        WHERE 1=1
         <if test='card_clsf != null and card_clsf !=""'> AND 'FAI003' = #{card_clsf} </if>
         <if test='card_knd != null and card_knd !=""'> AND #{card_knd} IN ('FAJ003', 'FAJ006') </if>
          AND cardno = REPLACE(#{card_no},'-','')
          AND rectime LIKE #{use_ymd} ||'%'
          AND apprno = #{apprvl_no}
        UNION ALL
        /* 법인카드 OR BC(보탬e-예치) OR BC(보탬e-비예치) */
       SELECT recamt - NVL(cnlamt,0) - NVL(tax_amt, 0) AS chrg_amt
       	 , NVL(tax_amt, 0) AS tax_amt
         , cardno
         FROM fbc_recogn
        WHERE 1=1
         <if test='card_clsf != null and card_clsf !=""'> AND ('FAI001' = #{card_clsf} OR ('FAI003' = #{card_clsf} AND ('FAJ008' = #{card_knd} OR 'FAJ009' = #{card_knd}))) </if>
          AND cardno = REPLACE(#{card_no},'-','')
          AND rectime LIKE #{use_ymd} ||'%'
          AND apprno = #{apprvl_no} 
        UNION ALL
        /* 통합이지바로 */
       SELECT a.demcost - NVL(a.exttax, 0) - (NVL(d.demcost, 0) - NVL(d.exttax, 0)) AS supply_amt
       	 , NVL(a.exttax, 0) - NVL(d.exttax, 0) AS tax_amt
         , a.cardno
         FROM ezbaro_cardorgn a  
         LEFT JOIN (
       			 SELECT SUM(demcost) AS demcost
       				  , SUM(exttax) AS exttax 
       				  , MAX(purchdt) AS purchdt 
       				  , cardno
       				  , apprno 
       			   FROM ezbaro_cardorgn 
       			  WHERE purchdivcd = '02'
       			  GROUP BY cardno, apprno
       			) d ON a.cardno = d.cardno AND a.apprno = d.apprno
        WHERE a.purchdivcd = '01'
         <if test='card_clsf != null and card_clsf !=""'> AND 'FAI003' = #{card_clsf} </if>
         <if test='card_knd != null and card_knd !=""'> AND 'FAJ007' = #{card_knd} </if>
          AND a.cardno = REPLACE(#{card_no},'-','')
          AND a.rectime LIKE #{use_ymd} ||'%'
          AND a.apprno = #{apprvl_no}
     ) a
  JOIN fspsendreq b ON REPLACE(b.card_no,'-','') = a.cardno AND b.apprvl_no = #{apprvl_no}
  JOIN fspslipd c ON c.unslip_no = b.unslip_no AND c.unslip_odr = b.unslip_odr
GROUP BY a.chrg_amt, a.tax_amt
</select>
<select id="selectSmlItmCheckupAserReg" parameterType="java.lang.String" resultType="java.util.HashMap">
SELECT /* kr.re.kitech.biz.fin.spm.selectSmlItmCheckupAserReg */
        FIRST 1 NVL(a.aset_reg, '') AS aset_reg
      , CASE WHEN NVL(x.syspayno,'') = '' THEN c.empsn ELSE x.syspayno END AS aset_manager
  FROM fspsmlitmcheckuph a
  JOIN resbgacctm b ON a.accnt_no = b.accnt_no
  JOIN humbasicinfo h ON b.accnt_rspns = h.syspayno
  LEFT JOIN xodrdeptpurman x ON h.dept_cd = x.dept_cd AND h.dept_new_ymd = x.dept_new_ymd AND x.role_type = 'ASS'
  LEFT JOIN ( SELECT MAX(sb.empsn) as empsn
                FROM roleusertable sa 
                JOIN bpm:emptable sb ON sa.empcode = sb.empcode
               WHERE sa.rolecode = '1015208'
            ) c ON x.syspayno = c.empsn
 WHERE a.unslip_no = #{unslip_no}
</select>

<!-- 경비결의 디테일 조회 (결재)-->
<select id="selectSlipDAprList" parameterType="java.lang.String" resultType="kr.re.kitech.biz.fin.com.vo.FspSlipDAprVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectSlipDAprList */
       b.unslip_no 
     , b.unslip_odr  --순번
     , b.accnt_no  --계정번호
     , b.expns_cd
     , b.base_debit_cr
     , b.evid_cd
     , b.journ_cd
     , d.expns_cd_nm || '('||b.expns_cd||')' AS expns_cd_nm --비용
     , TRIM(b.ctrl_no) AS  ctrl_no --통제
     , DECODE(b.base_debit_cr,'1',b.unslip_amt) AS debit_amt --차변
     , DECODE(b.base_debit_cr,'2',b.unslip_amt) AS cr_amt --대변
     , b.rmk_1 --적요1
     , b.accnt_rspns
     , DECODE(b.accnt_no, 'FF030001', '재정운영실장', c.nm) AS accnt_rspns_nm --책임자
     , NVL(b.ramt_mngmt_1, fun_fin_get_mngmt(0, b.unslip_no, b.unslip_odr)) AS mngmt_detls_cd1
     , fun_fin_get_mngmt(1, b.unslip_no, b.unslip_odr) AS mngmt_detls_cd2
     , b.accnt_cd
     , e.accnt_cd_abbr||'('||b.accnt_cd||')' AS accnt_abbr_nm --계정코드
     , fun_fin_get_mngmt(2, b.unslip_no, b.unslip_odr) AS mngmt_detls_cd3 --관리항목3
     , b.rmk_2  --적요2
     , r.cls_ymd -- 계정종료일자     
     , fun_res_prj_evid(b.accnt_no, b.expns_cd, 1) AS evid_yn
     , fun_res_prj_evid(b.accnt_no, b.expns_cd, 2) AS service_id
     , y.itm_clsf
     , (SELECT MAX(unslip_amt) FROM fspslipd WHERE unslip_no = b.unslip_no AND base_debit_cr = '1') AS unslip_amt_max
     , NVL(y.itm_solve_base, '') AS itm_solve_base--비목해소기준
     , MAX(NVL(x1.key_val, '')) AS meet_req_no
FROM fspslipd b
LEFT JOIN humbasicinfo c ON b.accnt_rspns = c.syspayno
JOIN xodfexpns d ON b.expns_cd = d.expns_cd
JOIN xodfaccnt e ON b.accnt_cd = e.accnt_cd
JOIN resbgacctm r ON b.accnt_no = r.accnt_no
LEFT JOIN fbaitmaccnt y ON r.itm_solve_base = y.itm_solve_base AND b.accnt_cd = y.accnt_cd 
LEFT JOIN fspevidattach x0 ON x0.unslip_no = b.unslip_no AND x0.unslip_odr = b.unslip_odr AND x0.evid_item_cd = 'F014'
LEFT JOIN fspevidrptkey x1 ON x0.evid_mngmt_no = x1.evid_mngmt_no AND x0.evid_mngmt_seq = x1.evid_mngmt_seq AND x0.evid_item_cd = x1.evid_item_cd
WHERE b.unslip_no = #{unslip_no}
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26
ORDER BY b.unslip_odr
</select>

<!-- 경비결의 송금내역 조회 (결재)-->
<select id="selectFspSendReqApr" parameterType="java.lang.String" resultType="kr.re.kitech.biz.fin.com.vo.FspSendReqVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectFspSendReqApr */
       a.unslip_odr  --순번
     , a.send_odr  --순번
     , c.cd_nm AS pay_clsf --지급방법
     , a.use_ymd  --발생일자
     , d.empno AS syspayno--개인번호
     , d.nm AS emp_nm --개인번호
     , a.vend_cd  --거래처코드
     , a.apprvl_no  --승인번호
     , a.card_no  --카드번호
     , a.joinsto_nm  --가맹점명
     , e.cd_nm AS giro_cash_clsf --지로/현금구분
     , f.cd_nm AS bank --송금은행
     , a.bankaccnt_no  --송금계좌번호
     , a.depstr_nm  --송금예금주명
     , a.send_req_amt  --금액
  FROM fspsendreq a
  JOIN xodxcommst c ON a.pay_clsf = c.cd
  LEFT JOIN humbasicinfo d ON a.syspayno = d.syspayno
  LEFT JOIN xodxcommst e ON a.giro_cash_clsf = e.cd
  LEFT JOIN xodxcommst f ON a.bank = f.cd
 WHERE a.unslip_no = #{unslip_no}
</select>

<!-- 경비결의 첨부파일 조회 (결재)-->
<select id="selectXomxComAttachFileApr" parameterType="java.lang.String" resultType="kr.re.kitech.biz.xom.core.vo.AttachVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectXomxComAttachFileApr */
       a.attach_file_no 
     , a.seq 
     , a.file_nm 
     , a.extens_nm 
     , a.file_nm||'.'||extens_nm AS orgFile
     , a.file_size 
     , a.path 
     , a.path||a.attach_file_no||a.seq AS attachFullPath
     , b.unslip_no
     , b.unslip_odr
FROM fspslipd b
JOIN xomxcomattachfile a ON b.attach_file_no = a.attach_file_no
WHERE b.unslip_no = #{unslip_no}
</select>

<!-- 경비결의 이지바로 증빙내역 조회 (결재)-->
<select id="selectFspItmEvidDetlsApr" resultType="kr.re.kitech.biz.fin.pop.vo.FspItmEvidDetlsVo" parameterType="java.lang.String">
SELECT /* kr.re.kitech.biz.fin.spm.selectFspItmEvidDetlsApr */
       a.unslip_no
     , a.unslip_odr
     , a.expns_cd
     , c.accnt_no
     , b.expns_cd_nm
     , b.service_id
     , a.regst_syspayno AS syspayno
     , COUNT(1) AS cnt
  FROM fspitmeviddetls a
  JOIN xodfexpns b ON a.expns_cd = b.expns_cd
  JOIN fspslipd c ON a.unslip_no = c.unslip_no AND a.unslip_odr = c.unslip_odr
 WHERE a.unslip_no = #{unslip_no}
 GROUP BY 1,2, 3, 4, 5, 6, 7
 ORDER BY 2
</select>

<!-- 경비결의 전자증빙내역 조회 (결재)-->
<select id="selectFspEvidAttachApr" parameterType="java.lang.String" resultType="kr.re.kitech.biz.xom.core.vo.AttachVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectFspEvidAttachApr */
      a.attach_file_no
     , b.seq
     , b.file_nm
     , c.evid_item_nm AS fileName
FROM fspevidattach a
JOIN xomxcomattachfile b ON a.attach_file_no = b.attach_file_no
JOIN fbaevidmngmt c ON a.evid_item_cd = c.evid_item_cd
WHERE a.req_no = #{req_no}
</select>

<!-- 일반결의처리(결의서차변.대변 금액 일치여부) -->
<select id="selectSlipDAmtSum" parameterType="java.lang.String" resultType="kr.re.kitech.biz.fin.spm.vo.ExpnsAmtSummryVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectSlipDAmtSum */
    SUM(DECODE(base_debit_cr,1, unslip_amt, 0)) as dr_amt,
    SUM(DECODE(base_debit_cr,2, unslip_amt, 0)) as cr_amt,
    SUM(DECODE(base_debit_cr,1, unslip_amt, 2, -unslip_amt)) as check_amt 
FROM fspslipd
WHERE unslip_no = #{unslip_no}
</select>
<select id="selectXomxIntfaTabCnt" parameterType="java.lang.String" resultType="int">
SELECT /* kr.re.kitech.biz.fin.spm.selectXomxIntfaTabCnt */
       COUNT(*) AS cnt 
 FROM xomxintfatab
WHERE req_no = #{req_no}
</select>

<!-- 카드결의 회의록 정보 조회 -->
<select id="selectFspSlipMeetInfo" parameterType="java.lang.String" resultType="kr.re.kitech.biz.fin.com.vo.FspSlipDVo">
SELECT /* kr.re.kitech.biz.fin.spm.selectFspSlipMeetInfo */
       FIRST 1
       a.meet_req_no AS req_no
     , a.accnt_no
     , CASE WHEN b.accnt_clsf IN ('FAK011', 'FAK003') THEN d.mngmt_item_2 ELSE d.mngmt_item_1 END expns_cd /* FAK011 부서관리(DM)계정번호, FAK003 예산관리(BG)계정번호 */
     , c.evid_amt AS total_amt
     , '회의비 ('|| d.cd_nm || '/' || substr(a.meet_start_ymd, 5, 2)||'.'|| substr(a.meet_start_ymd, 7, 8) || ')' AS rmk_1
     , c.cardno AS card_no
     , c.evid_apprno AS apprvl_no
FROM fspmeetmnth a 
JOIN fspmeetevidh c ON a.meet_req_no = c.meet_req_no
JOIN resbgacctm b ON a.accnt_no = b.accnt_no
JOIN xodxcommst d ON c.expns_clsf = d.cd
WHERE a.meet_req_no = #{req_no}
</select>
</mapper>