<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head meta_programName="기념홍보물신청">
    	<w2:type>DEFAULT</w2:type>
        <w2:buildDate/>
        <xf:model>
        	<xf:instance>
        		<data xmlns="" />
        	</xf:instance>
        	<w2:dataCollection baseNode="map">
        		<w2:dataMap baseNode="map" id="dma_search">
        			<w2:keyInfo>
        				<w2:key id="req_no" name="req_no" dataType="text"></w2:key>
        				<w2:key id="prgds_nm" name="prgds_nm" dataType="text"></w2:key>
        				<w2:key id="use_yn" name="use_yn" dataType="text"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dma_param">
        			<w2:keyInfo>
        				<w2:key id="req_fr_ymd" name="req_fr_ymd" dataType="text"></w2:key>
        				<w2:key id="req_to_ymd" name="req_to_ymd" dataType="text"></w2:key>
        				<w2:key id="req_psn_dept_cd" name="req_psn_dept_cd" dataType="text"></w2:key>
        				<w2:key id="req_psn_syspayno" name="req_psn_syspayno" dataType="text"></w2:key>
        				<w2:key id="apr_state" name="apr_state" dataType="text"></w2:key>
        				<w2:key id="prgds_nm" name="prgds_nm" dataType="text"></w2:key>
        				<w2:key id="use_yn" name="use_yn" dataType="text"></w2:key>
        				<w2:key id="flag" name="flag" dataType="text"></w2:key>
        				<w2:key id="req_no" name="req_no" dataType="text"></w2:key>
        				<w2:key id="param4" name="param4" dataType="text"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dma_info">
        			<w2:keyInfo>
        				<w2:key id="req_no" name="req_no" dataType="text"></w2:key>
        				<w2:key id="req_clsf" name="req_clsf" dataType="text"></w2:key>
        				<w2:key id="req_ymd" name="신청일자" dataType="text"></w2:key>
        				<w2:key id="req_psn_empno" name="req_psn_empno" dataType="text"></w2:key>
        				<w2:key id="req_psn_syspayno" name="req_psn_syspayno" dataType="text"></w2:key>
        				<w2:key id="req_psn_nm" name="req_psn_nm" dataType="text"></w2:key>
        				<w2:key id="req_psn_dept_cd" name="req_psn_dept_cd" dataType="text"></w2:key>
        				<w2:key id="req_psn_dept_new_ymd" name="req_psn_dept_new_ymd" dataType="text"></w2:key>
        				<w2:key id="req_psn_dept_nm" name="req_psn_dept_nm" dataType="text"></w2:key>
        				<w2:key id="req_psn_posi_cd" name="req_psn_posi_cd" dataType="text"></w2:key>
        				<w2:key id="req_psn_posi_nm" name="req_psn_posi_nm" dataType="text"></w2:key>
        				<w2:key id="accnt_rspns_syspayno" name="accnt_rspns_syspayno" dataType="text"></w2:key>
        				<w2:key id="accnt_rspns_dept_cd" name="accnt_rspns_dept_cd" dataType="text"></w2:key>
        				<w2:key id="accnt_rspns_dept_nm" name="accnt_rspns_dept_nm" dataType="text"></w2:key>

        				<w2:key id="accnt_no" name="accnt_no" dataType="text"></w2:key>
        				<w2:key id="accntnm" name="accntnm" dataType="text"></w2:key>
        				<w2:key id="expns_cd" name="expns_cd" dataType="text"></w2:key>
        				<w2:key id="accnt_cd" name="accnt_cd" dataType="text"></w2:key>
        				<w2:key id="req_amt" name="req_amt" dataType="text"></w2:key>
        				<w2:key id="req_cause" name="신청사유" dataType="text"></w2:key>
        				<w2:key id="rmk" name="rmk" dataType="text"></w2:key>
        				<w2:key id="req_state" name="req_state" dataType="text"></w2:key>
        				<w2:key id="attach_file_no" name="attach_file_no" dataType="text"></w2:key>
        				<w2:key id="regst_psn_syspayno" name="regst_psn_syspayno" dataType="text"></w2:key>
        				<w2:key id="ctrl_no" name="ctrl_no" dataType="text"></w2:key>
        				<w2:key id="apr_state" name="apr_state" dataType="text"></w2:key>
        				<w2:key id="service_id" name="service_id" dataType="text"></w2:key>
        				<w2:key id="doc_id" name="doc_id" dataType="text"></w2:key>
        				<w2:key id="approval" name="approval" dataType="text"></w2:key>
        				<w2:key id="apr_total_sum" name="apr_total_sum" dataType="number"></w2:key>
        				<w2:key id="nm" name="nm" dataType="text"></w2:key>
        				<w2:key id="apr_req_ymd" name="apr_req_ymd" dataType="text"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataList baseNode="list" repeatNode="map" id="dlt_pr_gd_inv" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column id="prgds_nm" name="홍보물" dataType="text"></w2:column>
        				<w2:column id="inv_vol" name="재고수량" dataType="text"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataList baseNode="list" repeatNode="map" id="dlt_pr_gd_req" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column id="chk" name="chk" dataType="text"></w2:column>
        				<w2:column id="req_no" name="req_no" dataType="text"></w2:column>
        				<w2:column id="prgds_nm" name="홍보물" dataType="text"></w2:column>
        				<w2:column id="inv_vol_req" name="inv_vol_req" dataType="text"></w2:column>
        				<w2:column id="inv_vol" name="inv_vol" dataType="text"></w2:column>
        				<w2:column id="un_distr_vol" name="un_distr_vol" dataType="text"></w2:column>
        				<w2:column id="req_qty" name="신청수량" dataType="text"></w2:column>
        				<w2:column id="unit_price" name="단가" dataType="text"></w2:column>
        				<w2:column id="req_amt" name="총금액" dataType="text"></w2:column>
        				<w2:column id="distr_qty" name="distr_qty" dataType="text"></w2:column>
        				<w2:column id="distr_ymd" name="distr_ymd" dataType="text"></w2:column>
        				<w2:column id="regst_psn_syspayno" name="regst_psn_syspayno" dataType="text"></w2:column>
        				<w2:column id="recv_psn_syspayno" name="recv_psn_syspayno" dataType="text"></w2:column>
        				<w2:column id="regst_daytm" name="regst_daytm" dataType="text"></w2:column>
        				<w2:column id="updt_psn_syspayno" name="updt_psn_syspayno" dataType="text"></w2:column>
        				<w2:column id="updt_daytm" name="updt_daytm" dataType="text"></w2:column>
        				<w2:column id="sum_cost" name="sum_cost" dataType="text"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataList baseNode="list" repeatNode="map" id="dlt_goods_master" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column id="req_no" name="req_no" dataType="text"></w2:column>
        				<w2:column id="req_ymd" name="req_ymd" dataType="text"></w2:column>
        				<w2:column id="req_psn_nm" name="req_psn_nm" dataType="text"></w2:column>
        				<w2:column id="prgds_nm" name="prgds_nm" dataType="text"></w2:column>
        				<w2:column id="distr_ymd" name="distr_ymd" dataType="text"></w2:column>
        				<w2:column id="recv_psn_syspayno" name="recv_psn_syspayno" dataType="text"></w2:column>
        				<w2:column id="recv_psn_nm" name="recv_psn_nm" dataType="text"></w2:column>
        				<w2:column id="inv_vol" name="inv_vol" dataType="text"></w2:column>
        				<w2:column id="req_qty" name="req_qty" dataType="text"></w2:column>
        				<w2:column id="distr_qty" name="distr_qty" dataType="text"></w2:column>
        				<w2:column id="unit_price" name="unit_price" dataType="text"></w2:column>
        				<w2:column id="un_distr_vol" name="un_distr_vol" dataType="text"></w2:column>
        				<w2:column id="unit" name="unit" dataType="text"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataMap baseNode="map" id="dma_pr_goods_file">
        			<w2:keyInfo>
        				<w2:key id="attach_file_no" name="attach_file_no" dataType="text"></w2:key>
        				<w2:key id="fileinfo" name="fileinfo" dataType="text"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        	</w2:dataCollection>
        	<w2:workflowCollection></w2:workflowCollection>
        	<xf:submission id="sbm_selectLplLprPrGoodsReqInfo" ref="data:json,dma_search" target='data:json,{"id":"dma_info","key":"infoVo"}' action="SvcLPLLPRPRGDSR01.pwkjson"
        		method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_selectLplLprGoodsMaster" ref="data:json,dma_search" target="" action="SvcLPLLPRPRGDMR02.pwkjson"
        		method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_selectLplLprGoodsInv" ref="data:json,dma_search" target="" action="SvcLPLLPRPRGDSR02.pwkjson"
        		method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_saveLplLprPrGoodsReq"
        		ref='data:json,[{"id":"dma_info","key":"infoVo"},{"id":"dlt_pr_gd_req","key":"lplLprPrGoodsList"}]' target="data:json,dma_search"
        		action="SvcLPLLPRPRGDSI01.pwkjson" method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_deleteLplLprPrGoodsReq" ref="data:json,dma_info" target="" action="SvcLPLLPRPRGDSD01.pwkjson" method="post"
        		mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
        		processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_selectLplLprPrGoodsFile" ref="data:json,dma_search" target="" action="SvcLPLLPRPRGDSR03.pwkjson"
        		method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        </xf:model>
        <script src="/cm/js/biz/lpl.js" cache="false" />         
        <script type="text/javascript" lazy="false"><![CDATA[
 
    /****************************************************
 	 * 화면 설명 : 기념홍보물신청
 	 * 변경 이력 : 2023-09-13 	김상미	최초 작성
 	 * 서비스아이디 : L531
 	 ****************************************************/  
	
 	scwin.data = {};
 	
 	/**
	 * 페이지 로딩 이벤트
	 */  	            
	scwin.onpageload = function() {
		scwin.data.service_id = "L531";
		scwin.data.doc_id = "L36";	
		scwin.data.sel_row = 0;
		com.biz.disabledButtons(dma_info.get("apr_state"), dma_info.get("req_no"));	

		// dataMap 초기화
		com.initDataMap(dma_search);	
		com.initDataMap(dma_info);
		
		// 첨부파일 컴포넌트 초기화
		com.file.init();
		// 첨부파일
		com.file.create(upload_A.getID(), {fileKey: scwin.data.service_id, mode: 'edit'});
		
		var param = com.getParameter();
		scwin.initPage(param);	
	};
	
	scwin.onpageunload = function() {
		
	};
	
	/**
	 * 화면 초기화
	 */	
	scwin.initPage = function(param) {

		//달력세팅
		scwin.data.today = com.getServerDateTime();
		ica_req_ymd.setValue(scwin.data.today);	
		
		com.biz.checkRole({ serviceId : scwin.data.service_id, roleCodes : com.getLoginInfo('roleCode')}, function(e){
			scwin.data.isRoleYn = e.isRoleYn;
		});
		
		if (param != undefined) {
			dma_param.setJSON(param);
		}
		
		if(dma_param.get("req_no") !=""){
			dma_search.set("req_no", dma_param.get("req_no"));
		}else{
			tbx_req_emp_no.setValue(com.getLoginInfo("empno"));
			tbx_req_psn_nm.setValue(com.getLoginInfo("cn"));
			tbx_req_psn_dept_nm.setValue(com.getLoginInfo("deptName"));
			tbx_req_psn_posi_nm.setValue(com.getLoginInfo("posiName"));					
		}
		
		scwin.searchGoodsFile();
		
		scwin.searchGoodsInv();	
	};	

	/**
	 * 기념홍보물파일조회
	 */		
	scwin.searchGoodsFile = function() {
		com.execute(sbm_selectLplLprPrGoodsFile, {
			successCallback : function(e) {
				console.log(e.responseJSON.elData);
				dma_pr_goods_file.setJSON(e.responseJSON.elData);
			}
		});		
	};
	
	/**
	 * 기념홍보물 master조회
	 */		
	scwin.searchGoodsMaster = function(flag) {
		com.execute(sbm_selectLplLprGoodsMaster, {
			successCallback : function(e) {
				console.log(e.responseJSON);
				if(flag=="list"){
					dlt_goods_master.setJSON(e.responseJSON.lplLprPrGoodsReqInfoVoList, false);
					if(dma_search.get("req_no") !=""){
						scwin.search();
					}
				}else{
					var res = e.responseJSON.lplLprPrGoodsReqInfoVoList[0];
					console.log(res);
					dlt_pr_gd_req.setCellAllData(scwin.data.sel_row, "unit_price", res["unit_price"]);
					dlt_pr_gd_req.setCellAllData(scwin.data.sel_row, "inv_vol", res["inv_vol"]);	
					dlt_pr_gd_req.setCellData(scwin.data.sel_row, "req_amt", 0);
					grd_pr_gd_req.setFocusedCell(scwin.data.sel_row, "req_qty", true);					
					scwin.setTotalSum();				
				}
			}
		});	
	};
	
	/**
	 * 기념홍보물 재고조회
	 */		
	scwin.searchGoodsInv = function() {
		com.execute(sbm_selectLplLprGoodsInv, {
			successCallback : function(e) {
				console.log(e.responseJSON);
				dlt_pr_gd_inv.setJSON(e.responseJSON.lplLprPrGoodsReqInfoVoList, false);
				dma_search.set("use_yn", "Y");
				scwin.searchGoodsMaster("list");
			}
		});	
	};	

	/**
	 * 조회 실행
	 */		
	scwin.search = function() {
		com.execute(sbm_selectLplLprPrGoodsReqInfo, {
			successCallback : function(e) {
				console.log(e.responseJSON);

				//첨부파일 세팅
				var vMode = "edit";
				if (dma_info.get("apr_state") >= "XAD020") {
					vMode = "view";
				}else{
					if (tbx_req_emp_no.getValue() != com.getLoginInfo("empno")) {
						vMode = "view";
					}
				}
				var attachFileNo = dma_info.get("attach_file_no");
				com.file.create(upload_A.getID(), {fileKey: (attachFileNo == "") ? scwin.data.service_id :attachFileNo.trim(), mode: vMode});
				
				dlt_pr_gd_req.setJSON(e.responseJSON.elData.lplLprPrGoodsList, false);
				
				for (var i = 0; i < dlt_pr_gd_req.getRowCount();  i++) {
					var qty = dlt_pr_gd_req.getCellData(i, "req_qty");
					var price = dlt_pr_gd_req.getCellData(i, "unit_price");
					var sumCost = Number(qty) * Number(price);
					dlt_pr_gd_req.setCellData(i, "req_amt", sumCost);
				}
				var reqCause = txa_req_cause.getValue();
				reqCause = reqCause.replace(/(&)/g, "");
				reqCause = reqCause.replace(/(\n)/g, "<br/>");
				dma_info.set("reqCause", reqCause);

				var rmk = txa_rmk.getValue();
				if(rmk !=""){
					rmk = rmk.replace(/(\n)/g, "<br/>");	
					dma_info.set("rmk", rmk);	
				}
										
				scwin.setTotalSum();
				scwin.compControll();
								
			}
		});	
	};		
	
	/**
	 * 목록 버튼 클릭 이벤트
	 */		
	scwin.btn_list_onclick = function(e) {
		scwin.backToList();
	};
	
	/**
	 * 목록 페이지로 이동
	 */	
	scwin.backToList = function(){
		var data = dma_param.getJSON();
		com.moveList('L532', data);		
	};	
	
	/**
	 * 인쇄버튼 클릭 이벤트
	 */		
	scwin.btn_print_onclick = function(e) {
		com.oz.openPopup( {
		    formAlias : dma_info.get("req_no").substring(0,3),
		    reqNo : dma_info.get("req_no"),
		    snapFrame : grp_base_info.getID()
		});	
	};

	/**
	* 결재신청버튼 클릭 이벤트
	*/	
	scwin.btn_apr_onclick = function(e) {
		dma_info.set("approval", "true");
		dma_info.set("apr_req_ymd",com.formatDate(ica_req_ymd.getValue(), "date"));		
		dma_info.set("apr_total_sum", com.formatMoney(dma_info.get("req_amt")));
		
		if(!scwin.preSave())
		{
			return;
		}
		if(!scwin.checkInvQty())
		{
			return;
		}				
		com.confirm("결재신청을 하시려면 [확인]을 클릭하세요", function(ret) {
			if (ret) {
				scwin.save();				
			} 
		});			
	};

	/**
	* 물품재고수량 확인
	*/		
	scwin.checkInvQty = function() {
		var reqCnt = dlt_pr_gd_req.getRowCount(); // 신청정보 그리드 개수
		var invCnt = dlt_pr_gd_inv.getRowCount(); // 재고정보 그리드 개수

		// 재고량 검증로직(전제조건 : 한 건의 홍보물을 한 건 이상 등록하지 않았다)
		for (var i=0; i<reqCnt; i++) {
			var reqItem = dlt_pr_gd_req.getCellData(i, "prgds_nm");
			var reqQty = dlt_pr_gd_req.getCellData(i, "req_qty");

			for (var j=0; j<invCnt; j++) {
				if (reqItem.trim() == dlt_pr_gd_inv.getCellData(j, "prgds_nm")) {
					if (Number(reqQty) > Number(dlt_pr_gd_inv.getCellData(j, "inv_vol"))) {
						com.alert("[알림] " + reqItem+"의 재고량이 부족합니다. \n 신청수량을 조정해주세요.");

						return false;
					}
				}
			}
		}

		return true;	
	};

	/**
	* 물품신청정보 + 버튼 클릭 이벤트
	*/	
	scwin.btn_plus_onclick = function(e) {
		dlt_pr_gd_req.insertRow();
	};
	
	/**
	* 물품신청정보 - 버튼 클릭 이벤트
	*/		
	scwin.btn_mius_onclick = function(e) {
		var rows = grd_pr_gd_req.getCheckedIndex("chk");
		if (rows.length ==0) {
			com.alert("삭제할 데이터를 선택하세요");
			return;
		}
		dlt_pr_gd_req.removeRows(rows);
		com.alert("삭제후 저장을 하셔야 반영이 됩니다");
	};

	/**
	* 그리드 변경 이벤트
	*/		
	scwin.grd_pr_gd_req_onviewchange = function(info) {
		scwin.data.sel_row = info.rowIndex;
		
		var colId = grd_pr_gd_req.getColumnID(info.colIndex)
		if (colId == "prgds_nm") { //홍보물
			dlt_pr_gd_req.setCellData(info.rowIndex, "req_qty", "");
			dma_search.set("prgds_nm", info.newValue);
			grd_pr_gd_req.setCellReadOnly(info.rowIndex, "req_qty", false);
			
			//신청상세정보 제품을 중복으로 넣을 수 없기 때문에 선택하는 단계에서 중복입력을 제한하도록 처리
			var matchedIdx = dlt_pr_gd_req.getMatchedIndex("prgds_nm", info.newValue, true);
			matchedIdx.pop(info.rowIndex);
			if(matchedIdx.length > 0){
				com.alert("이미 선택되어있는 제품입니다.");
				dlt_pr_gd_req.setCellAllData(info.rowIndex, "prgds_nm", info.oldValue);
				return;
			}
			
			scwin.searchGoodsMaster("qty");
		} else if (colId == "req_qty") { //신청수량
			var invVol = info.newValue;
			if (invVol == "" || invVol == "0") {
				com.alert("신청수량을 1개 이상 입력하세요.", function(){
					grd_pr_gd_req.setFocusedCell(info.rowIndex, colId, true);
				});
				return;
			}

			var unitPrice = dlt_pr_gd_req.getCellData(info.rowIndex, "unit_price");
			var sum = Number(invVol) * Number(unitPrice);
			dlt_pr_gd_req.setCellData(info.rowIndex, "req_amt", sum);
			scwin.setTotalSum();
		}
	};
	
	/**
	* 총합계 세팅
	*/		
	scwin.setTotalSum = function() {
		var totalSum = 0;
		for (var i = 0; i <dlt_pr_gd_req.getRowCount(); i++) {
			totalSum = Number(totalSum) + Number(dlt_pr_gd_req.getCellData(i, "req_amt"));
		}
		tbx_total_sum.setValue(totalSum);
	};
	
	/**
	* 삭제버튼 클릭 이벤트
	*/		
	scwin.btn_del_onclick = function(e) {
		var msg = "기념홍보물신청서 : [" + tbx_req_no.getValue() + "] 의 모든 데이터를 삭제 하시려면 [확인]을 클릭하세요.";
		com.confirm(msg, function(ret) {
			if (ret) {
				scwin.remove();				
			} 		
		});
	};

	/**
	* 삭제실행
	*/	
	scwin.remove = function(){
		com.file.deleteAll(function(){
			com.execute(sbm_deleteLplLprPrGoodsReq, {
				successCallback : function(e) {
					var res = e.responseJSON.elData;
					if (res != undefined && res["count"] > 0) {
						com.alert("[기념홍보물신청]삭제 처리되었습니다.", function() {
							if (dma_param.get("param4") == "apr") {
								com.openTabMenu("A010", {});
							} else {
								scwin.backToList();							
							}
						});
					}
				}
			});	
		});
	};	
	
	/**
	* 저장버튼 클릭 이벤트
	*/	
	scwin.btn_save_onclick = function(e) {
		dma_info.set("approval", "false");
		if (!scwin.preSave()) {
			return;
		}
		
		com.confirm("message.xom.wq.017" /*저장 하시겠습니까?*/, function(ret) {
			if (ret) {
				scwin.save();				
			} 
		});	
	};
	
	/**
	 * 저장 실행
	 */	
	scwin.save = function(){
		dma_info.set("service_id",scwin.data.service_id);
		dma_info.set("doc_id",scwin.data.doc_id);
		dma_info.set("nm", com.getLoginInfo("cn"));
		dma_info.set("req_psn_empno", com.getLoginInfo("empno"));	
		dma_info.set("req_psn_syspayno", com.getLoginInfo("sn"))	
		com.initDataMap(dma_search);		
		com.file.transport(function(attachObj){	
			dma_info.set("attach_file_no", attachObj.upload_A);
			
			var attaches = [];
			if (attachObj.upload_A !="") {
				attaches.push(attachObj.upload_A);
			}					
			com.execute(sbm_saveLplLprPrGoodsReq, {
				successCallback : function(e) {
					if(dma_info.get("approval") == "true"){
						com.movePageMenu("A001", {"reqNo" :  dma_info.get("req_no")});						
					}else{
						com.alert("message.xom.wq.023"/*정상적으로 처리되었습니다.*/, function() {
							scwin.search();
						});			
					}
				}
			});	
		});
	};

	/**
     * 저장전 확인
     */
	scwin.preSave = function(){
		if (dlt_pr_gd_req.getRowCount() ==0) {
			com.alert("[알림] 물품신청정보가 등록되지 않았습니다. \n 물품신청정보를 등록해주세요.");
			return false;
		}
		
		if(!scwin.validate()){
			return false;	
		}
		
		if (com.file.action.getTotalFileCount(upload_A.getID()) < 1) {
			com.alert("첨부파일을 등록하세요!");
			return false;
		}		
		return true;
	};

	/**
     * 검증
     */
	scwin.validate = function() {
		var validData = [
			{dataObj :dma_info, 
				valInfoArr :[
					{ id : "req_ymd", mandatory : true},
					{ id : "req_cause", mandatory : true},			
				], isCheckModified : false
			},
			{dataObj :dlt_pr_gd_req, 
				valInfoArr :[
					{ id : "prgds_nm", mandatory : true},
					{ id : "req_qty", mandatory : true},			
				], isCheckModified : false
			},			
		];
		
		//필수 입력항목 검증
		if(!com.validateData(validData)){
			return false;
		}
		
		//날짜 유효성 검증
		if(!com.isDate(ica_req_ymd.getValue(), false)){
			return false;
		}		
		return true;
	};
			
	/**
	* 사용자 조회
	*/
	scwin.searchEmp = function(accnt_syspayno) {
		var data = { syspayno : accnt_syspayno, 
					 work_clsf : "HAG010", 
					 ref_yn : "N"
					}
		com.pop.open( com.pop.TYPE.HUM, data, function(ret){			
			dma_info.set("accnt_rspns_dept_cd", ret.dept_cd);
			dma_info.set("accnt_rspns_dept_nm", ret.dept_nm);
		});
	};
			
	/**
	 * 화면 콤포넌트 컨트롤
	 */
	scwin.compControll = function() {
	    com.biz.disabledButtons(dma_info.get("apr_state"), dma_info.get("req_no"));
	    
		if (dma_info.get("apr_state") >= "XAD020"){
			var disableArr = ["ica_req_ymd","txa_req_cause","txa_rmk","btn_plus","btn_mius"];
			scwin.setDisable(disableArr, true);	
			grd_pr_gd_req.setGridReadOnly(true);
			
			if(dma_info.get("apr_state") == "XAD100"){
				btn_print.setDisabled(false);
			}
		} else {
			if (tbx_req_emp_no.getValue() != com.getLoginInfo("empno")) {
				var disableArr = ["ica_req_ymd","txa_req_cause","txa_rmk","btn_plus","btn_mius","btn_save","btn_del","btn_apr"];
				grd_pr_gd_req.setGridReadOnly(true);
				scwin.setDisable(disableArr, true);				
			}
		}	
	};
	
	/**
     * 기념홍보물 다운로드버튼 클릭 이벤트
     */		
	scwin.btn_down_docu_onclick = function(e) {
		if (dma_pr_goods_file.get("attach_file_no") !="") {
			var file_nm ="홍보물리스트.hwp";
			scwin.downFileinfo(file_nm, dma_pr_goods_file.get("fileinfo"));
		}
	};

	/**
     * 파일 다운로드
     */
	scwin.downFileinfo = function downFileinfo(file_nm,file_no){
		var url = "/SvcAttachDown.do?fileName="+file_no+"&realName="+encodeURIComponent(file_nm)+"&bizKind=OLD";		
		window.open(url, '_blank').focus();
	};	
	

	/**
	* 컴포넌트 disable true/false 처리
	*/	
	scwin.setDisable = function(arr, flag) {
		for (var i =0; i<arr.length; i++) {
			$p.getComponentById(arr[i]).setDisabled(flag);
		}
	};	]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload" ev:onpageunload="scwin.onpageunload">
    	<w2:wframe id="wfm_wframe2" src="/cm/xml/contentTitle.xml" style=""></w2:wframe>
    	<xf:group class="pageWrap" id="grp_base_info" style="">
    		<xf:group class="searchSection step" id="" style="">
    			<xf:group class="le" id="">
    				<xf:trigger class="btn " id="btn_list" style="" type="button" ev:onclick="scwin.btn_list_onclick">
    					<xf:label><![CDATA[목록]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    			<xf:group class="btnbox" id="">
    				<xf:trigger class="btn icon print" id="btn_print" style="display:none;" type="button" ev:onclick="scwin.btn_print_onclick">
    					<xf:label><![CDATA[인쇄]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="btn blue" id="btn_apr" style="" type="button" ev:onclick="scwin.btn_apr_onclick">
    					<xf:label><![CDATA[결재신청]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    		</xf:group>
    		<xf:group class="titleSection" id="" style="">
    			<w2:textbox class="tit_tbl" id="" label="신청자 정보" style="" tagname="h3"></w2:textbox>
    		</xf:group>
    		<xf:group class="w2tb tbl" id="" style="" tagname="table">
    			<w2:attributes>
    				<w2:summary></w2:summary>
    			</w2:attributes>
    			<xf:group tagname="caption"></xf:group>
    			<xf:group tagname="colgroup">
    				<xf:group style="width:140px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    				<xf:group style="width:140px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    				<xf:group style="width:140px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    				<xf:group style="width:140px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    			</xf:group>
    			<xf:group tagname="tr" style="">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="신청자" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<w2:textbox class="txt" id="tbx_req_psn_nm" label="000" style="" tagname="span" ref="data:dma_info.req_psn_nm"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="개인번호" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<w2:textbox class="txt" id="tbx_req_emp_no" label="000" style="" tagname="span" ref="data:dma_info.req_psn_empno"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes></w2:attributes>
    					<w2:textbox id="" label="소속" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<w2:textbox class="txt" id="tbx_req_psn_dept_nm" label="000" style="" tagname="span" ref="data:dma_info.req_psn_dept_nm"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes></w2:attributes>
    					<w2:textbox id="" label="직급" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<w2:textbox class="txt" id="tbx_req_psn_posi_nm" label="000" style="" tagname="span" ref="data:dma_info.req_psn_posi_nm"></w2:textbox>
    				</xf:group>
    			</xf:group>
    		</xf:group>
    		<xf:group class="titleSection" id="" style="">
    			<w2:textbox class="tit_tbl" id="" label="신청정보" style="" tagname="h3"></w2:textbox>
    		</xf:group>
    		<xf:group class="w2tb tbl" id="" style="" tagname="table">
    			<w2:attributes>
    				<w2:summary></w2:summary>
    			</w2:attributes>
    			<xf:group tagname="caption"></xf:group>
    			<xf:group tagname="colgroup">
    				<xf:group style="width:140px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    				<xf:group style="width:140px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    				<xf:group style="width:140px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    				<xf:group style="width:140px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    			</xf:group>
    			<xf:group style="" tagname="tr">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="신청번호" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes>
    						<w2:colspan>3</w2:colspan>
    						<w2:rowspan>1</w2:rowspan>
    					</w2:attributes>
    					<w2:textbox class="txt" id="tbx_req_no" label="000" style="" tagname="span" ref="data:dma_info.req_no"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes></w2:attributes>
    					<w2:span class="bul_req" id="" label="[필수입력항목]" style=""></w2:span>
    					<w2:textbox class="blue" id="" label="신청일자" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes>
    						<w2:colspan>3</w2:colspan>
    						<w2:rowspan>1</w2:rowspan>
    					</w2:attributes>
    					<w2:inputCalendar calendarValueType="yearMonthDate" class="inpcal" focusOnDateSelect="false" footerDiv="false"
    						id="ica_req_ymd" placeholder="" renderDiv="true" rightAlign="false" style="max-width:200px;" ref="data:dma_info.req_ymd" readOnly="true">
    					</w2:inputCalendar>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group tagname="th" class="w2tb_th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:span class="bul_req" id="" label="[필수입력항목]" style=""></w2:span>
    					<w2:textbox class="blue" id="" label="신청사유" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group tagname="td" class="w2tb_td">
    					<w2:attributes>
    						<w2:colspan>7</w2:colspan>
    						<w2:rowspan>1</w2:rowspan>
    					</w2:attributes>
    					<xf:textarea class="" id="txa_req_cause" maxlength="133" style="height:80px;" title=""
    						placeholder="◈ 아래의 사항을 필수로 기입하여 주시기 바랍니다.&amp;#10;◈ 행사명: OO 행사&amp;#10;◈ 행사일시: 2016.08.23(월) 10:00~12:00&amp;#10;◈ 행사장소: 천안 본원 비즈센터 희망나눔홀&amp;#10;◈ 기념홍보물 수령자: 00기관 00부서 000(실명기재)" ref="data:dma_info.req_cause">
    					</xf:textarea>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group tagname="th" class="w2tb_th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="비고" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group tagname="td" class="w2tb_td">
    					<w2:attributes>
    						<w2:colspan>7</w2:colspan>
    						<w2:rowspan>1</w2:rowspan>
    					</w2:attributes>
    					<xf:textarea class="" id="txa_rmk" maxlength="133" style="height:80px;" title="" ref="data:dma_info.rmk"></xf:textarea>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group tagname="th" class="w2tb_th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:span class="bul_req" id="" label="[필수입력항목]" style=""></w2:span>
    					<w2:textbox class="blue" id="" label="첨부파일" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group tagname="td" class="w2tb_td">
    					<w2:attributes>
    						<w2:colspan>7</w2:colspan>
    						<w2:rowspan>1</w2:rowspan>
    					</w2:attributes>
    					<xf:group class="fileuploadBox" id="upload_A" style="height:150px;"></xf:group>
    				</xf:group>
    			</xf:group>
    		</xf:group>
    		<xf:group class="lybox" id="" style="">
    			<xf:group class="ly_column col_4" id="">
    				<xf:group class="titleSection" id="" style="">
    					<xf:group class="le" id="">
    						<w2:textbox class="tit_tbl" id="" label="물품재고정보" style="" tagname="h3"></w2:textbox>
    					</xf:group>
    					<xf:group class="ri" id="" style="">
    						<xf:trigger class="btn" id="btn_down_docu" style="" type="button" ev:onclick="scwin.btn_down_docu_onclick">
    							<xf:label><![CDATA[기념홍보물다운로드]]></xf:label>
    						</xf:trigger>
    					</xf:group>
    				</xf:group>
    				<w2:gridView autoFit="allColumn" class="grid" dataList="data:dlt_pr_gd_inv" defaultCellHeight="28"
    					evenRowBackgroundColor="#f7faff" id="grd_pr_gd_inv" noResultMessage="조회 결과가 없습니다." noResultMessageClass="noResult"
    					rowMouseOverColor="#e7f0fb" rowNumBackgroundColor="#fff" rowNumHeaderValue="No." rowNumVisible="true" rowNumWidth="60"
    					rowStatusHeaderValue="상태" rowStatusVisible="false" rowStatusWidth="50" scrollByColumn="false" scrollByColumnAdaptive="false"
    					selectedCellColor="#fbf2cd" selectedRowColor="#fbf2cd" style="height: 85px;" visibleRowNum="10">
    					<w2:caption id="caption1" style="" value="this is a grid caption."></w2:caption>
    					<w2:header id="header1" style="">
    						<w2:row id="row1" style="">
    							<w2:column displayMode="label" id="column9" inputType="text" style="height:28px;" value="홍보물" width="200">
    							</w2:column>
    							<w2:column displayMode="label" id="column7" inputType="text" style="height:28px;" value="재고수량"
    								width="100">
    							</w2:column>
    						</w2:row>
    					</w2:header>
    					<w2:gBody id="gBody1" style="">
    						<w2:row id="row2" style="">
    							<w2:column displayMode="label" id="prgds_nm" inputType="text" readOnly="true" style="height:28px;"
    								width="200">
    							</w2:column>
    							<w2:column displayMode="label" id="inv_vol" inputType="text" readOnly="true" style="height:28px;" value=""
    								width="100">
    							</w2:column>
    						</w2:row>
    					</w2:gBody>
    				</w2:gridView>
    			</xf:group>
    			<xf:group class="ly_column col_6" id="" style="">
    				<xf:group class="titleSection" id="" style="">
    					<xf:group class="le" id="">
    						<w2:textbox class="tit_tbl" id="" label="물품신청정보" style="" tagname="h3"></w2:textbox>
    						<xf:group class="result" id="">
    							<w2:span id="" label="*총합계 " style=""></w2:span>
    							<w2:span class="numtotal" id="tbx_total_sum" label="0" style="" displayFormat="###,###,###" ref="data:dma_info.req_amt"></w2:span>
    							<w2:span id="" label="원" style=""></w2:span>
    						</xf:group>
    					</xf:group>
    					<xf:group class="ri" id="">
    						<xf:group class="btnarea" id="" style="">
    							<xf:trigger class="bt_plus" id="btn_plus" style="" type="button" ev:onclick="scwin.btn_plus_onclick">
    								<xf:label><![CDATA[추가]]></xf:label>
    							</xf:trigger>
    							<xf:trigger class="bt_minus" id="btn_mius" style="" type="button" ev:onclick="scwin.btn_mius_onclick">
    								<xf:label><![CDATA[삭제]]></xf:label>
    							</xf:trigger>
    						</xf:group>
    					</xf:group>
    				</xf:group>
    				<w2:gridView autoFit="lastColumn" class="grid" dataList="data:dlt_pr_gd_req" defaultCellHeight="28"
    					evenRowBackgroundColor="#f7faff" id="grd_pr_gd_req" noResultMessage="조회 결과가 없습니다." noResultMessageClass="noResult"
    					rowMouseOverColor="#e7f0fb" rowNumBackgroundColor="#fff" rowNumHeaderValue="No." rowNumVisible="true" rowNumWidth="60"
    					rowStatusHeaderValue="상태" rowStatusVisible="false" rowStatusWidth="50" scrollByColumn="false" scrollByColumnAdaptive="false"
    					selectedCellColor="#fbf2cd" selectedRowColor="#fbf2cd" style="height: 85px;" visibleRowNum="10"
    					ev:onviewchange="scwin.grd_pr_gd_req_onviewchange">
    					<w2:caption id="caption1" style="" value="this is a grid caption."></w2:caption>
    					<w2:header id="header1" style="">
    						<w2:row id="row1" style="">
    							<w2:column width="45" inputType="checkbox" style="height:28px" id="column21" value="선택" displayMode="label"
    								checkboxLabel="전체선택">
    							</w2:column>
    							<w2:column width="70" inputType="text" style="height:28px" id="column31" value="신청번호" displayMode="label"
    								hidden="true">
    							</w2:column>
    							<w2:column displayMode="label" id="column7" inputType="text" style="height:28px;" value="홍보물" width="200">
    							</w2:column>
    							<w2:column width="157" inputType="text" style="height:28px" id="column27" value="재고수량" displayMode="label"
    								hidden="true">
    							</w2:column>
    							<w2:column width="70" inputType="text" style="height:28px" id="column25" value="재고량" displayMode="label"
    								hidden="true">
    							</w2:column>
    							<w2:column width="70" inputType="text" style="height:28px" id="column23" value="미배부량" displayMode="label"
    								hidden="true">
    							</w2:column>
    							<w2:column displayMode="label" id="column5" inputType="text" style="height:28px;" value="신청수량"
    								width="100">
    							</w2:column>
    							<w2:column displayMode="label" id="column3" inputType="text" sortable="true" style="height:28px;" value="단가"
    								width="120">
    							</w2:column>
    							<w2:column displayMode="label" id="column20" inputType="text" style="height:28px;" value="총금액"
    								width="150">
    							</w2:column>
    							<w2:column width="70" inputType="text" style="height:28px" id="column29" value="배부수량" displayMode="label"
    								hidden="true">
    							</w2:column>
    						</w2:row>
    					</w2:header>
    					<w2:gBody id="gBody1" style="">
    						<w2:row id="row2" style="">
    							<w2:column width="45" inputType="checkbox" style="height:28px" id="chk" value="" displayMode="label"
    								checkboxLabel="선택">
    							</w2:column>
    							<w2:column width="70" inputType="text" style="height:28px" id="req_no" value="" displayMode="label"></w2:column>
    							<w2:column displayMode="label" id="prgds_nm" inputType="select" style="height:28px;" value="" width="200"
    								allOption="" chooseOption="" ref="" editModeEvent="onclick">
    								<w2:choices>
    									<w2:itemset nodeset="data:dlt_goods_master">
    										<w2:label ref="prgds_nm"></w2:label>
    										<w2:value ref="prgds_nm"></w2:value>
    									</w2:itemset>
    								</w2:choices>
    							</w2:column>
    							<w2:column width="157" inputType="text" style="height:28px" id="inv_vol_req" value="" displayMode="label"></w2:column>
    							<w2:column width="70" inputType="text" style="height:28px" id="inv_vol" value="" displayMode="label"></w2:column>
    							<w2:column width="70" inputType="text" style="height:28px" id="un_distr_vol" value="" displayMode="label"></w2:column>
    							<w2:column class="ri" displayMode="label" escape="false" id="req_qty" inputType="text" style="height:28px;"
    								width="100" dataType="number" displayFormat="#,###">
    							</w2:column>
    							<w2:column displayMode="label" id="unit_price" inputType="text" readOnly="true" style="height:28px;"
    								width="120" class="ri" dataType="number" displayFormat="###,###,###">
    							</w2:column>
    							<w2:column displayMode="label" id="req_amt" inputType="text" readOnly="true" style="height:28px;"
    								width="150" dataType="number" displayFormat="###,###,###" class="ri">
    							</w2:column>
    							<w2:column width="70" inputType="text" style="height:28px" id="distr_qty" value="" displayMode="label"></w2:column>
    						</w2:row>
    					</w2:gBody>
    				</w2:gridView>
    			</xf:group>
    		</xf:group>
    		<xf:group class="btnGroup" id="" style="">
    			<xf:group class="le" id="" style=""></xf:group>
    			<xf:group class="ri" id="">
    				<xf:trigger class="btn pro" id="btn_del" style="" type="button" ev:onclick="scwin.btn_del_onclick">
    					<xf:label><![CDATA[삭제]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class=" btn pro conf" id="btn_save" style="" type="button" ev:onclick="scwin.btn_save_onclick">
    					<xf:label><![CDATA[저장]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    		</xf:group>
    	</xf:group>
    </body>
</html>
