<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head meta_programName="카드결제" meta_author="이영희" meta_date="2023.07.03">
    	<w2:type>DEFAULT</w2:type>
        <w2:buildDate/>
        <xf:model>
            <xf:instance>
                <data xmlns=""/>
            </xf:instance>
            <w2:dataCollection baseNode="map">
            	<w2:dataList baseNode="list" id="dlt_month" repeatNode="map" saveRemovedData="true" style="">
            		<w2:columnInfo>
            			<w2:column dataType="text" id="monthly_lab" name="할부라벨"></w2:column>
            			<w2:column id="monthly_val" name="할부값" dataType="text"></w2:column>
            		</w2:columnInfo>
            		<w2:data use="true">
            			<w2:row>
            				<monthly_lab><![CDATA[일시불]]></monthly_lab>
            				<monthly_val><![CDATA[00]]></monthly_val>
            			</w2:row>
            			<w2:row>
            				<monthly_lab><![CDATA[2개월]]></monthly_lab>
            				<monthly_val><![CDATA[02]]></monthly_val>
            			</w2:row>
            			<w2:row>
            				<monthly_lab><![CDATA[3개월]]></monthly_lab>
            				<monthly_val><![CDATA[03]]></monthly_val>
            			</w2:row>
            			<w2:row>
            				<monthly_lab><![CDATA[4개월]]></monthly_lab>
            				<monthly_val><![CDATA[04]]></monthly_val>
            			</w2:row>
            			<w2:row>
            				<monthly_lab><![CDATA[5개월]]></monthly_lab>
            				<monthly_val><![CDATA[05]]></monthly_val>
            			</w2:row>
            			<w2:row>
            				<monthly_lab><![CDATA[6개월]]></monthly_lab>
            				<monthly_val><![CDATA[06]]></monthly_val>
            			</w2:row>
            		</w2:data>
            	</w2:dataList>
            	<w2:dataMap baseNode="map" id="dma_appl">
            		<w2:keyInfo>
            			<w2:key id="kolas_no" name="기술지원접수번호" dataType="text"></w2:key>
            			<w2:key id="gubun_cd" name="승인취소구분" dataType="text"></w2:key>
            			<w2:key id="tech_supt_req_no" name="기술지원의뢰번호" dataType="text"></w2:key>
            			<w2:key id="cmpy_nm_krchar" name="고객명" dataType="text"></w2:key>
            			<w2:key id="bsns_psn_regst_no" name="사업자번호" dataType="text"></w2:key>
            			<w2:key id="reprs_psn" name="대표자명" dataType="text"></w2:key>
            			<w2:key id="addr" name="주소" dataType="text"></w2:key>
            			<w2:key id="cunsl_req_psn" name="의뢰자명" dataType="text"></w2:key>
            			<w2:key id="decsn_amt" name="확정금액" dataType="text"></w2:key>
            			<w2:key id="card_appl_no" name="카드승인번호" dataType="text"></w2:key>
            			<w2:key id="card_issu_ymd" name="카드승인일자" dataType="text"></w2:key>
            			<w2:key id="proof_yn" name="결제증빙구분" dataType="text"></w2:key>
            			<w2:key id="del_yn" name="삭제여부" dataType="text"></w2:key>
            			<w2:key id="prcs_state" name="처리상태" dataType="text"></w2:key>
            		</w2:keyInfo>
            	</w2:dataMap>
            	<w2:dataMap baseNode="map" id="dma_recv">
            		<w2:keyInfo>
            			<w2:key id="RQ01" name="전문구분" dataType="text"></w2:key>
            			<w2:key id="RQ02" name="단말기 번호" dataType="text"></w2:key>
            			<w2:key id="RQ03" name="카드입력구분" dataType="text"></w2:key>
            			<w2:key id="RQ04" name="카드 번호" dataType="text"></w2:key>
            			<w2:key id="RQ05" name="유효기간" dataType="text"></w2:key>
            			<w2:key id="RQ06" name="할부개월" dataType="text"></w2:key>
            			<w2:key id="RQ07" name="총금액" dataType="text"></w2:key>
            			<w2:key id="RQ08" name="현금영수증" dataType="text"></w2:key>
            			<w2:key id="RQ09" name="상품코드" dataType="text"></w2:key>
            			<w2:key id="RQ10" name="원승인번호" dataType="text"></w2:key>
            			<w2:key id="RQ11" name="원승인일자" dataType="text"></w2:key>
            			<w2:key id="RQ12" name="봉사료" dataType="text"></w2:key>
            			<w2:key id="RQ13" name="부가세" dataType="text"></w2:key>
            			<w2:key id="RQ14" name="시판매번호" dataType="text"></w2:key>
            			<w2:key id="RQ15" name="웹전송메시지" dataType="text"></w2:key>
            			<w2:key id="RQ16" name="단말기구분코드" dataType="text"></w2:key>
            			<w2:key id="RS01" name="응답1" dataType="text"></w2:key>
            			<w2:key id="RS02" name="응답2" dataType="text"></w2:key>
            			<w2:key id="RS03" name="응답3" dataType="text"></w2:key>
            			<w2:key id="RS04" name="응답4" dataType="text"></w2:key>
            			<w2:key id="RS05" name="응답5" dataType="text"></w2:key>
            			<w2:key id="RS06" name="응답6" dataType="text"></w2:key>
            			<w2:key id="RS07" name="응답7" dataType="text"></w2:key>
            			<w2:key id="RS08" name="응답8" dataType="text"></w2:key>
            			<w2:key id="RS09" name="응답9" dataType="text"></w2:key>
            			<w2:key id="RS10" name="응답10" dataType="text"></w2:key>
            			<w2:key id="RS11" name="응답11" dataType="text"></w2:key>
            			<w2:key id="RS12" name="응답12" dataType="text"></w2:key>
            			<w2:key id="RS13" name="응답13" dataType="text"></w2:key>
            			<w2:key id="RS14" name="응답14" dataType="text"></w2:key>
            			<w2:key id="RS15" name="응답15" dataType="text"></w2:key>
            			<w2:key id="RS16" name="응답16" dataType="text"></w2:key>
            			<w2:key id="RS17" name="응답17" dataType="text"></w2:key>
            			<w2:key id="RS18" name="응답18" dataType="text"></w2:key>
            			<w2:key id="RS19" name="응답19" dataType="text"></w2:key>
            			<w2:key id="RS20" name="응답20" dataType="text"></w2:key>
            		</w2:keyInfo>
            	</w2:dataMap>
            </w2:dataCollection>
            <w2:workflowCollection/>
            <!-- 저장 -->
    		<xf:submission id="sbm_saveData" ref='data:json,[{"id":"dma_appl","key":"rcptVo"},{"id":"dma_recv","key":"hisVo"}]' 
    			target='' action="SvcSPTTECM03.pwkjson" method="post"
    			mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
    			processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
    		</xf:submission>
        </xf:model>
         <script type="text/javascript" lazy="false"><![CDATA[
	/****************************************************
 	 * 화면 설명 : 기술지원 카드결제
 	 * 변경 이력 : 2023-07-03	이영희	최초 작성
 	 ****************************************************/          
	scwin.onpageload = function() {
		// parameter setting
		dma_appl.setJSON(com.getParameter());
		btn_cancel.hide();
		
		if(dma_appl.get("card_appl_no").trim() != ""){
			btn_print.setDisabled(false);
		}
		
		if(dma_appl.get("gubun_cd") == "D4"){
			btn_cancel.show("");
			btn_save.hide();
		}
	};
	
	scwin.onpageunload = function() {
		
	};	
	
	/**
	 * 카드결제 메시지 생성(전문의 각 항목은 ^로 구별)
	 */
	scwin.makeMsg = function(){
		var dcontrolno = ""; // PG거래일련번호 
		var comm_string = "";
		comm_string += rdo_gubun_cd.getValue() + "^";
		comm_string += "^"; // 현금영수증거래용도(00 개인현금, 01 사업자현금)
		comm_string += dma_appl.get("decsn_amt") + "^";
		comm_string += sbx_installmnt.getValue() + "^";
		comm_string += dma_appl.get("card_issu_ymd") + "^"; // 취소시 필요(승인일자)
		comm_string += dma_appl.get("card_appl_no") + "^"; // 취소시 필요(승인번호)
		comm_string += "^"; // 상품코드
		comm_string += "^"; // 임시판매번호
		comm_string += dma_appl.get("kolas_no") +"^"; // 웹전송메세지
		comm_string += "^"; // KEYIN 허용
		comm_string += "^"; // 단말기번호
		comm_string += "20^"; // 타임아웃
		comm_string += "A^"; // 부가세 (A 자동계산)
		comm_string += "OPON"+dma_appl.get("kolas_no")+"^"; // 추가필드(사용 가맹점만 대입)
		comm_string += "^"; // 수신핸들값
		comm_string += "^"; // 단말기 구분
		comm_string += "^"; // 할인/적립구분
		comm_string += "^"; // 거래확정옵션
		if(dcontrolno == "" && rdo_gubun_cd.getValue() == "D4" ){ // 취소 거래고유번호
			comm_string += "^" + dcontrolno;
		}else{
			comm_string += "^";
		}
		comm_string += "^";
		
		return comm_string;
	};
	
	/**
	 * 카드결제 또는 취소
	 */
	scwin.save = function(){
		if(rdo_gubun_cd.getValue() == "04"){ // 취소
			if(dma_appl.get("card_issu_ymd") != com.getServerDateTime()){
				alert("카드 결재 당일에만 취소가 가능합니다.\n 연구장비 운영실 담당자에게 문의 바랍니다.");
				return;
			}
		}
		
		var sendMsg = scwin.makeMsg();
		
		$.ajax({
			url : "http://127.0.0.1",
			dataType : "jsonp",
			jsonp : "callback",
			cache : true,
			contentType: "application/json; charset=EUC-KR",
			data : {"REQ" : encodeURI(sendMsg)},
			error : function(data){
				alert("카드 프로그램이 없습니다.");
			},
			success : function(data){
				debugger;
				dma_recv.setJSON(data);
	
				var msg = "";
				if(data.SUC != "00"){
					msg =data.RS16 + "로 결제 실패입니다.";
				}else{
					if(data.RS04 != "0000"){ // 0000 성공, 이외는 거절코드
						msg = "실패입니다.";
					}else{
						dma_appl.set("proof_yn", "STO020");
						
						if(rdo_gubun_cd.getValue() == "D1"){ // 승인
							dma_appl.set("card_appl_no", data.RS09);
							dma_appl.set("card_issu_ymd", "20"+ data.RS07.substring(0,6));
							dma_appl.set("prcs_state", "STE065");
							
							msg = "결제성공";
							
						}else if(rdo_gubun_cd.getValue() == "D4"){ // 취소
							dma_appl.set("card_appl_no", "");
							dma_appl.set("card_issu_ymd", "");
							dma_appl.set("prcs_state", "STE030");
							
							msg = "결제실패";
						}
					}
				}
				
				com.alert(msg, function(){
					com.execute(sbm_saveData, {
						successCallback : function(e){
							com.alert("message.xom.wq.023"/*정상적으로 처리되었습니다.*/, function() {								
								com.closePopup({}); // 팝업 닫기 (콜백 수행을 위해 빈 객체 넘김)
							});
						}
					});
				});
			}
		});
	};
	
	/**
	 * 닫기
	 */
	scwin.btn_close_onclick = function(e) {
		com.closePopup();
	};	
	
	/**
	 * 카드승인(취소)버튼 클릭 이벤트
	 */
	scwin.btn_save_onclick = function(e) {
		scwin.save();
	};
	
	/**
	 * 영수증 출력 버튼 클릭 이벤트
	 */
	scwin.btn_print_onclick = function(e) {
		var card_issu_ymd = dma_appl.get("card_issu_ymd");
		var node = "kolas_no=" + dma_appl.get("kolas_no")
		         + "&appl_no=" + dma_appl.get("card_appl_no")
		         + "&appl_ymd=" + card_issu_ymd.substr(2)
		         + "&gubun_cd=" + dma_appl.get("gubun_cd")
		         + "&serID=S301"
		         ;
		com.oz.openPopup({
			ozrCode : "S008",      
			param: node
        });
	};
	
	/**
	 * 카드취소 버튼 클릭 이벤트
	 */
	scwin.btn_cancel_onclick = function(e) {
		scwin.save();
	};
	]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload">
    <xf:group id="" class="pop_contents">
    	<xf:group class="titleSection pt0" id="" style="">
    		<xf:group class="le" id=""></xf:group>
    		<xf:group class="ri" id="" style="">
    			<xf:trigger class="btn icon print" id="btn_print" style="" type="button" ev:onclick="scwin.btn_print_onclick" disabled="true">
    				<xf:label><![CDATA[영수증]]></xf:label>
    			</xf:trigger>
    		</xf:group>
    	</xf:group>
    	<xf:group class="w2tb tbl" id="" style="" tagname="table">
    		<w2:attributes>
    			<w2:summary></w2:summary>
    		</w2:attributes>
    		<xf:group tagname="caption" text="특정물품(업체)구매사유서"></xf:group>
    		<xf:group tagname="colgroup">
    			<xf:group style="width:140px;" tagname="col"></xf:group>
    			<xf:group style="" tagname="col"></xf:group>
    			<xf:group style="width:140px;" tagname="col"></xf:group>
    			<xf:group style="" tagname="col"></xf:group>
    		</xf:group>
    		<xf:group tagname="tr">
    			<xf:group class="w2tb_th" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="승인 / 취소" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" tagname="td">
    				<w2:attributes></w2:attributes>
    				<xf:select1 appearance="full" class="radioGroup" cols="" id="rdo_gubun_cd" ref="data:dma_appl.gubun_cd"
    					renderType="radiogroup" rows="" selectedIndex="-1" style="" title="승인취소구분">
    					<xf:choices>
    						<xf:item>
    							<xf:label><![CDATA[승인]]></xf:label>
    							<xf:value><![CDATA[D1]]></xf:value>
    						</xf:item>
    						<xf:item>
    							<xf:label><![CDATA[취소]]></xf:label>
    							<xf:value><![CDATA[D4]]></xf:value>
    						</xf:item>
    					</xf:choices>
    				</xf:select1>
    			</xf:group>
    			<xf:group class="w2tb_th" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="결제금액" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" tagname="td">
    				<w2:attributes></w2:attributes>
    				<xf:input adjustMaxLength="false" class="inp full ri" id="" style="" title="결제금액" dataType="number"
    					displayFormat="#,###" ref="data:dma_appl.decsn_amt" disabled="true">
    				</xf:input>
    			</xf:group>
    		</xf:group>
    		<xf:group style="" tagname="tr">
    			<xf:group class="w2tb_th" style="" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="접수번호" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" style="" tagname="td">
    				<xf:input adjustMaxLength="false" class="inp full" id="" style="" title="구매요구부서" ref="data:dma_appl.kolas_no"></xf:input>
    			</xf:group>
    			<xf:group class="w2tb_th" style="" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="할부" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" style="" tagname="td">
    				<xf:select1 allOption="" appearance="minimal" chooseOption="" chooseOptionLabel="" class="sel full" direction="auto"
    					disabledClass="w2selectbox_disabled" id="sbx_installmnt" ref="data:dma_detl.depst_bank_cd" style=""
    					submenuSize="auto" title="입금은행">
    					<xf:choices>
    						<xf:itemset nodeset="data:dlt_month">
    							<xf:label ref="monthly_lab"></xf:label>
    							<xf:value ref="monthly_val"></xf:value>
    						</xf:itemset>
    					</xf:choices>
    				</xf:select1>
    			</xf:group>
    		</xf:group>
    		<xf:group style="" tagname="tr">
    			<xf:group class="w2tb_th" style="" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="승인번호(취소)" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" style="" tagname="td">
    				<xf:input adjustMaxLength="false" class="inp full" id="" style="" title="승인번호" disabled="true" ref="data:dma_appl.card_appl_no"></xf:input>
    			</xf:group>
    			<xf:group class="w2tb_th" style="" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="승인일자(취소)" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" style="" tagname="td">
    				<xf:input adjustMaxLength="false" class="inp full" id="" style="" title="승인일자" dataType="date"
    					displayFormat="yyyy-MM-dd" disabled="true" ref="data:dma_appl.card_issu_ymd">
    				</xf:input>
    			</xf:group>
    		</xf:group>
    	</xf:group>
    	<xf:group class="titleSection pt0" id="" style="">
    		<xf:group class="le" id="">
    			<w2:textbox class="tit_tbl" id="" label="고객정보" style="" tagname="h3"></w2:textbox>
    		</xf:group>
    		<xf:group class="ri" id="" style="">
    		</xf:group>
    	</xf:group>
    	<xf:group class="w2tb tbl" id="" style="" tagname="table">
    		<w2:attributes>
    			<w2:summary></w2:summary>
    		</w2:attributes>
    		<xf:group tagname="caption" text="특정물품(업체)구매사유서"></xf:group>
    		<xf:group tagname="colgroup">
    			<xf:group style="width:140px;" tagname="col"></xf:group>
    			<xf:group style="" tagname="col"></xf:group>
    			<xf:group style="width:140px;" tagname="col"></xf:group>
    			<xf:group style="" tagname="col"></xf:group>
    		</xf:group>
    		<xf:group tagname="tr">
    			<xf:group class="w2tb_th" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="고객명" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" tagname="td">
    				<w2:attributes></w2:attributes>
    				<w2:textbox class="txt" id="" label="00" ref="data:dma_appl.cmpy_nm_krchar" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_th" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="사업자번호" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" tagname="td">
    				<w2:attributes></w2:attributes>
    				<w2:textbox class="txt" id="" label="00" ref="data:dma_appl.bsns_psn_regst_no" style="" tagname="span" displayFormat="###-##-#####"></w2:textbox>
    			</xf:group>
    		</xf:group>
    		<xf:group style="" tagname="tr">
    			<xf:group class="w2tb_th" style="" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="대표자성명" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" style="" tagname="td">
    				<w2:textbox class="txt" id="" label="00" ref="data:dma_appl.reprs_psn" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_th" style="" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="의뢰자성명" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" style="" tagname="td">
    				<w2:textbox class="txt" id="" label="00" ref="data:dma_appl.cunsl_req_psn" style="" tagname="span"></w2:textbox>
    			</xf:group>
    		</xf:group>
    		<xf:group style="" tagname="tr">
    			<xf:group class="w2tb_th" style="" tagname="th">
    				<w2:attributes>
    					<w2:scope>row</w2:scope>
    				</w2:attributes>
    				<w2:textbox id="" label="회사주소" style="" tagname="span"></w2:textbox>
    			</xf:group>
    			<xf:group class="w2tb_td" style="" tagname="td">
    				<w2:attributes>
    					<w2:colspan>3</w2:colspan>
    					<w2:rowspan>1</w2:rowspan>
    				</w2:attributes>
    				<w2:textbox class="txt" id="" label="00" ref="data:dma_appl.addr" style="" tagname="span"></w2:textbox>
    			</xf:group>
    		</xf:group>
    	</xf:group>
    	<xf:group style="" id="" class="btnGroup">
    		<xf:group style="" id="" class="le"></xf:group>
    		<xf:group id="" class="ri">
    			<xf:trigger style="" id="btn_close" type="button" class="btn pro" ev:onclick="scwin.btn_close_onclick">
    				<xf:label><![CDATA[닫기]]></xf:label>
    			</xf:trigger>
    			<xf:trigger class=" btn pro conf" id="btn_cancel" style="" type="button" ev:onclick="scwin.btn_cancel_onclick">
    				<xf:label><![CDATA[카드취소]]></xf:label>
    			</xf:trigger>
    			<xf:trigger style="" id="btn_save" type="button" class=" btn pro conf" ev:onclick="scwin.btn_save_onclick">
    				<xf:label><![CDATA[카드승인]]></xf:label>
    			</xf:trigger>
    		</xf:group>
    	</xf:group>
    </xf:group></body>
</html>
