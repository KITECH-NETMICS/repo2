<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
	<head meta_programName="조직기여도 신청서">
		<w2:type>DEFAULT</w2:type>
		<w2:buildDate />
		<xf:model>
			<xf:instance> 
				<data xmlns="" /> 
			</xf:instance>
			<w2:dataCollection baseNode="map">
				<w2:dataMap baseNode="map" id="dma_ctrbtReq">
					<w2:keyInfo>
				       <w2:key id="req_nm" name="req_nm" dataType="text"></w2:key>
				       <w2:key id="req_empno" name="req_empno" dataType="text"></w2:key>
				       <w2:key id="req_dept_cd" name="req_dept_cd" dataType="text"></w2:key>
				       <w2:key id="req_dept_nm" name="req_dept_nm" dataType="text"></w2:key>
				       <w2:key id="req_posi_cd" name="req_posi_cd" dataType="text"></w2:key>
				       <w2:key id="req_posi_nm" name="req_posi_nm" dataType="text"></w2:key>
				       <w2:key id="req_psn_dept_new_ymd" name="req_psn_dept_new_ymd" dataType="text"></w2:key>
				       <w2:key id="req_ymd" name="제출일" dataType="text"></w2:key>
				       <w2:key id="apr_state" name="apr_state" dataType="text"></w2:key>
				       <w2:key id="apr_state_nm" name="apr_state_nm" dataType="text"></w2:key>
				       <w2:key id="rcpt_no" name="rcpt_no" dataType="text"></w2:key>
				       <w2:key id="content" name="주요내용" dataType="text"></w2:key>
				       <w2:key id="rcpt_psn_dept_nm" name="rcpt_psn_dept_nm" dataType="text"></w2:key>
				       <w2:key id="rcpt_empno" name="rcpt_empno" dataType="text"></w2:key>
				       <w2:key id="rcpt_psn_nm" name="rcpt_psn_nm" dataType="text"></w2:key>
				       <w2:key id="rcpt_psn_posi_nm" name="rcpt_psn_posi_nm" dataType="text"></w2:key>
				       <w2:key id="rate_syspayno" name="rate_syspayno" dataType="text"></w2:key>
				       <w2:key id="rate_empno" name="rate_empno" dataType="text"></w2:key>
				       <w2:key id="rate_nm" name="rate_nm" dataType="text"></w2:key>
				       <w2:key id="rate_posi_cd" name="rate_posi_cd" dataType="text"></w2:key>
				       <w2:key id="rate_posi_nm" name="rate_posi_nm" dataType="text"></w2:key>
				       <w2:key id="rate_division_cd" name="rate_division_cd" dataType="text"></w2:key>
				       <w2:key id="rate_division_nm" name="rate_division_nm" dataType="text"></w2:key>
				       <w2:key id="rate_dept_cd" name="rate_dept_cd" dataType="text"></w2:key>
				       <w2:key id="rate_dept_nm" name="rate_dept_nm" dataType="text"></w2:key>
				       <w2:key id="ctrbt_eval_index" name="성과지표 유형" dataType="text"></w2:key>
				       <w2:key id="points" name="points" dataType="text"></w2:key>
				       <w2:key id="approval" name="결재여부" dataType="text"></w2:key>
				       <w2:key id="attach_file_no" name="첨부파일" dataType="text"></w2:key>
				       <w2:key id="validAttachNo" name="validAttachNo" dataType="text"></w2:key>
				       <w2:key id="ind_type" name="ind_type" dataType="text"></w2:key>
				       <w2:key id="ind_type_nm" name="ind_type_nm" dataType="text"></w2:key>
				       <w2:key id="ind_cd" name="ind_cd" dataType="text"></w2:key>
				       <w2:key id="ind_cd_nm" name="ind_cd_nm" dataType="text"></w2:key>
				       <w2:key id="rcpt_syspayno" name="rcpt_syspayno" dataType="text"></w2:key>
				       <w2:key id="rcpt_psn" name="rcpt_psn" dataType="text"></w2:key>
				       <w2:key id="aply_yn" name="aply_yn" dataType="text"></w2:key>
				       <w2:key id="req_syspayno" name="req_syspayno" dataType="text"></w2:key>
				       <w2:key id="req_psn" name="req_psn" dataType="text"></w2:key>
				       <w2:key id="req_divsn_dept_nm" name="req_divsn_dept_nm" dataType="text"></w2:key>
				       <w2:key id="regst_syspayno" name="regst_syspayno" dataType="text"></w2:key>
				       <w2:key id="regst_daytm" name="regst_daytm" dataType="text"></w2:key>
				       <w2:key id="updt_syspayno" name="updt_syspayno" dataType="text"></w2:key>
				       <w2:key id="updt_daytm" name="updt_daytm" dataType="text"></w2:key>
				       <w2:key id="approval_temp" name="approval_temp" dataType="text"></w2:key>
				       <w2:key id="total_points" name="total_points" dataType="text"></w2:key>
				       <w2:key id="comments" name="반려의견" dataType="text"></w2:key>
				       <w2:key id="apr_info" name="결재정보" dataType="text"></w2:key>
				       <w2:key id="actvty_nm" name="활동명" dataType="text"></w2:key>
					</w2:keyInfo>
				</w2:dataMap>				
				<w2:dataList baseNode="list" repeatNode="map" id="dlt_ctrbtMember" saveRemovedData="true">
					<w2:columnInfo>
					   <w2:column id="odr" name="순번" dataType="text"></w2:column>
					   <w2:column id="rcpt_no" name="rcpt_no" dataType="text"></w2:column>
					   <w2:column id="rate_syspayno" name="rate_syspayno" dataType="text"></w2:column>
				       <w2:column id="rate_empno" name="rate_empno" dataType="text"></w2:column>
				       <w2:column id="rate_nm" name="기여자" dataType="text"></w2:column>
				       <w2:column id="rate_posi_cd" name="rate_posi_cd" dataType="text"></w2:column>
				       <w2:column id="rate_posi_nm" name="rate_posi_nm" dataType="text"></w2:column>
				       <w2:column id="rate_division_cd" name="rate_division_cd" dataType="text"></w2:column>
				       <w2:column id="rate_division_nm" name="rate_division_nm" dataType="text"></w2:column>
				       <w2:column id="rate_dept_cd" name="rate_dept_cd" dataType="text"></w2:column>
				       <w2:column id="rate_dept_nm" name="rate_dept_nm" dataType="text"></w2:column>
				       <w2:column id="points" name="points" dataType="text"></w2:column>
				       <w2:column id="chk" name="선택" dataType="text"></w2:column>
					</w2:columnInfo>
				</w2:dataList>	
			</w2:dataCollection>
			<w2:workflowCollection></w2:workflowCollection>	
			<!-- 조회 -->
    		<xf:submission id="sbm_selectData" ref="data:json,dma_ctrbtReq"
    			target='data:json,[{"id":"dma_ctrbtReq","key":"resOutCtrbtReqVo"},{"id":"dlt_ctrbtMember","key":"resOutCtrbtReqListVo"}]'
    			action="SvcCtrbtEvalReqR01.pwkjson" method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler=""
    			customHandler="" mode="asynchronous" processMsg="조회중..." ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
    		</xf:submission>		
			<!-- 저장 -->
    		<xf:submission id="sbm_saveCtrbtReq"
    			ref='data:json,[{"id":"dma_ctrbtReq","key":"resOutCtrbtReqVo"},{"id":"dlt_ctrbtMember","key":"resOutCtrbtReqListVo"}]'
    			target='data:json,dma_ctrbtReq' action="SvcCtrbtEvalReqC01.pwkjson" method="post" mediatype="application/json" encoding="UTF-8"
    			instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone=""
    			ev:submiterror="" abortTrigger="">
    		</xf:submission>
			<!-- 삭제 -->
    		<xf:submission id="sbm_deleteCtrbtReq" ref="data:json,dma_ctrbtReq"
    			target='' action="SvcCtrbtEvalReqD01.pwkjson" method="post" mediatype="application/json" encoding="UTF-8"
    			instance="" replace="" errorHandler="" customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone=""
    			ev:submiterror="" abortTrigger="">
    		</xf:submission>
     		<!-- 담당자 결재 -->
    		<xf:submission id="sbm_saveApr" ref="data:json,dma_ctrbtReq"
    		 target='data:json,dma_ctrbtReq' action="SvcCtrbtEvalReqU01.pwkjson"
				method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
				processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
			</xf:submission>	
    		<!-- 담당자 반려 -->
    		<xf:submission id="sbm_delApr" ref="data:json,dma_ctrbtReq"
    		 target='data:json,dma_ctrbtReq' action="SvcCtrbtEvalReqU02.pwkjson"
				method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
				processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
			</xf:submission>	
    		<!-- 결재 후 담당자 저장 -->
    		<xf:submission id="sbm_savePostApr" ref='data:json,[{"id":"dma_ctrbtReq","key":"resOutCtrbtReqVo"},{"id":"dlt_ctrbtMember","key":"resOutCtrbtReqListVo"}]'
    		 target='data:json,dma_ctrbtReq' action="SvcCtrbtEvalReqU03.pwkjson"
				method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
				processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
			</xf:submission>			
			
		</xf:model> 
        <script src="/cm/js/biz/ccs.js" cache="false" />
		<script type="text/javascript" lazy="false"><![CDATA[
		
	/****************************************************
	 * 화면 설명 : 조직기여도제출
	 * 변경 이력 : 2023-11 이윤민 최초생성
	 * serviceId : J666
	 ****************************************************
	     
	/**
	 * 페이지 로딩 이벤트
	 */      
	scwin.data = {
		isApproval : false,
		serviceId : "J666"
	}; 


	    
	scwin.onpageload = function() {
		// 첨부파일 컴포넌트 초기화
		com.file.init();
		
		//신청상태에 따른 담당자 버튼 숨김
		btn_cofm.setStyle("display", "none");
		btn_rejct.setStyle("display", "none");
		
		// 오늘 날짜
		scwin.data.today = com.getServerDateTime();

		// session
		var session = com.getLoginInfo();
		scwin.data.sn = session.sn;
		dma_ctrbtReq.set("regst_syspayno", scwin.data.sn);
		dma_ctrbtReq.set("updt_syspayno", scwin.data.sn);
		
		
		// 제출일자 기본 설정
		dma_ctrbtReq.set("req_ymd", scwin.data.today);
		
		com.pop.open(com.pop.TYPE.HUM, {empno : session.empno}, function(ret) {
			dma_ctrbtReq.set("req_syspayno", ret.syspayno);
			dma_ctrbtReq.set("req_empno", ret.empno);
			dma_ctrbtReq.set("req_nm", ret.nm);
			dma_ctrbtReq.set("req_dept_cd", ret.dept_cd);
			dma_ctrbtReq.set("req_dept_nm", ret.dept_nm);
			dma_ctrbtReq.set("req_posi_cd", ret.posi_cd);
			dma_ctrbtReq.set("req_posi_nm", ret.posi_nm);
			dma_ctrbtReq.set("req_psn_dept_new_ymd", ret.dept_new_ymd);
			
			scwin.data.fomat_unit = ret.fomat_unit;	
		});	
	
		// parameter 설정 (업무대기함, 작성중문서함 등에서 rcpt_no대신 req_no 사용)
		dma_ctrbtReq.setJSON(com.getParameter());
		if (com.getParameter("req_no")) {
			dma_ctrbtReq.set("rcpt_no", com.getParameter("req_no"));
		}
			
		
		if (dma_ctrbtReq.get("rcpt_no") != ""){
			scwin.search();				
		} else {
			// 신규신청
			btn_apr.setDisabled(true);
			com.file.create(upload_A.getID(), {fileKey: "J666", mode: 'edit'});				
		}
	};	
	
	/**
	 * 문서정보 조회
	 */
	scwin.search = function(){
	
		com.execute(sbm_selectData, {
		
			successCallback : function(e){							
				// 조회 후 셋팅
				
				var resInfo = e.responseJSON.elData.ResOutCtrbtReqIntegVo;
				scwin.setForm();	
			}
		});
	};
	
	/**
	 * 문서정보 조회 후 셋팅
	 */
	scwin.setForm = function(){
		// 결재상태 갱신 및 버튼컨트롤
		scwin.data.aprState = dma_ctrbtReq.get("apr_state");
		
		// 버튼 제어
		com.biz.disabledButtons(scwin.data.aprState, dma_ctrbtReq.get("rcpt_no"));		

		// 업무담당자 수정권한 부여(버튼제어)
		var vMode = "edit";
		debugger;
		if(dma_ctrbtReq.get("apr_state") >= "XAD020"){
			grp_page.setDisabled(true);
			btn_apr_view.setDisabled(false);
				
//			 담당자일 경우 첨부파일 업로드 가능하게 기능 추가
//			 1010102 시스템관리자(M), 1010101 시스템관리자(A), 1001001 연구관리관리자
			if (/1010102|1010101|1001001/.test(com.getLoginInfo('roleCode'))) {
//				btn_mngSave.show("");	// 담당자저장
//				btn_mngSave.setDisabled(false);
//				
//				req_ymd.setDisabled(false);			// 제출일
//				sbx_ctrbt_eval_index.setDisabled(false);				// 성과지표 유형
//				txt_content.setDisabled(false);				// 주요내용
//				rate_empno.setDisabled(false);			// 기여자
//				rate_nm.setDisabled(false);			// 기여자 성명
//								
//				bt_plus.setDisabled(false);		// 활동내역(+)
//				bt_minus.setDisabled(false);		// 활동내역(-)
//				grd_ctrbtMember.setDisabled(false);			// 활동내역
				btn_pre.setDisabled(false); // 목록 버튼
			if (dma_ctrbtReq.get("apr_state") == "XAD070") {
				btn_cofm.setStyle("display", "inline-block"); // 담당자 승인 버튼
				btn_rejct.setStyle("display", "inline-block"); // 담당자 반려 버튼
				btn_cofm.setDisabled(false); // 담당자 승인 버튼
				btn_rejct.setDisabled(false); // 담당자 반려 버튼
			}
				vMode = "view";	
			}else{
				vMode = "view";					
//				if(chk_accntNoUse.getValue() != "Y"){
//					scwin.setTripExpns();
//				}	
			}			
		}else{
			grp_page.setDisabled(false);
		}
		
		// 성과지표 유형 세팅
		if (dma_ctrbtReq.get("ind_type") == 'RPP009') {
			sbx_ctrbt_eval_index.setValue('tf');
		} else if (dma_ctrbtReq.get("ind_type") == 'RPP010') {
			sbx_ctrbt_eval_index.setValue('committee');
		} else if (dma_ctrbtReq.get("ind_type") == 'RPP011') {
			sbx_ctrbt_eval_index.setValue('evaluator');
		} 
		
		// 기여자 인원 세팅
		tbx_compn_cnt.setValue(dlt_ctrbtMember.getRowCount());

		// 첨부파일
		var attachFileNo = dma_ctrbtReq.get("attach_file_no");
		if(attachFileNo.trim() != ''){
			com.file.create(upload_A.getID(), {fileKey: attachFileNo, mode: vMode});
		}else{
			com.file.create(upload_A.getID(), {fileKey: "J666", mode: vMode})
		}
	}
	
	
	/**
	 * 저장버튼 클릭 이벤트
	 */
	
	scwin.btn_save_onclick = function(e) {
		scwin.data.isApproval = false;
		dma_ctrbtReq.set("approval", "false");
		// 필수입력값 체크
		if (!scwin.isCommonValid()) return;		
		if (dlt_ctrbtMember.getRowCount() == 0) {
			alert("기여자는 필수 입력 항목입니다.");
			return;
		}
		if(com.file.action.getTotalFileCount(upload_A.getID()) < 1){
			com.alert(com.getMsg("message.xom.co.com.0011", "첨부파일"));
			return;
		}		
		com.confirm("message.xom.wq.017"/*저장 하시겠습니까?*/, function( ret) {
			if (ret) {
				scwin.save();
			}
		});
	};
	

	/**
	 * 삭제버튼 이벤트
	 */ 
	scwin.btn_del_onclick = function(e) {
		com.confirm("message.xom.wq.022"/*삭제 하시겠습니까?*/, function(ret) {
			if (ret) {
				com.file.deleteAll( function(){
					com.execute(sbm_deleteCtrbtReq, {
						successCallback : function(e) { // 성공 콜백
							if ('apr' == com.getParameter('param4')) {
								com.movePageMenu("A010", {});
								let dummyModal= document.querySelector('.w2modal_popup');
								if (dummyModal) {
									dummyModal.style.display = 'none';
								}
							} else {
								com.alert("message.xom.wq.023"/*정상적으로 처리되었습니다.*/, function() {
									com.moveList("J665", {mod :"delete"});
								});
							}
						}
					});
				});	
			}
		});
	};
	
	/**
	* 승인 버튼 이벤트 (담당자용)
	*/
	scwin.btn_cofm_onclick = function(e) {
		dma_ctrbtReq.set("apr_state", "XAD020");
		dma_ctrbtReq.set("rcpt_syspayno", scwin.data.sn);
		
//		com.execute(sbm_saveApr, {
//			successCallback : function(e) {
//				com.openTabMenu("A004", {});
//			}
//		});
		
		com.execute(sbm_saveApr, {
			successCallback : function(e) {
				alert("승인처리 되었습니다");
				if (-1 < $p.top().wdc_layout.windows.findIndex( function( win) { return win.windowId.startsWith('A0'); })) {
					com.movePageMenu("A004", { sideYn : "Y"});
				}else{
					com.openTabMenu("A004", {});
				}
				gcm.util.changeTabColor();
			}
		});
		
	}
	
	/**
	* 반려 버튼 이벤트 (담당자용)
	*/
	scwin.btn_rejct_onclick = function(e) {
		//반려
//		dma_ctrbtReq.set("apr_state","XAD015");
//		com.execute(sbm_delApr, {
//			successCallback : function(e) {
//				com.openTabMenu("A004", {});
//			}
//		});
		
		var options = {
				id : "APR02P",
				popupName : "반려의견",
				width : 500, height: 300 
		};
		com.openPopup("/ui/apr/APR_C001_03P.xml", options, "", function(retObj) {
			if (retObj.comments != null) {
				dma_ctrbtReq.set("comments", retObj.comments);
				dma_ctrbtReq.set("apr_state","XAD015");
				com.execute(sbm_delApr, {
					successCallback : function(e) {
						alert("반려처리 되었습니다");
						if (-1 < $p.top().wdc_layout.windows.findIndex( function( win) { return win.windowId.startsWith('A0'); })) {
							com.movePageMenu("A004", { sideYn : "Y"});
						}else{
							com.openTabMenu("A004", {});
						}
						gcm.util.changeTabColor();
					}
				});
			}
		});
	}


	/** 읽기전용 상태 설정 */
	scwin.setReadOnly = function(){
		// iptHolidayDays.setReadOnly(true);
		ibx_req_psn_empno.setReadOnly(true);
		sbx_holiday_clsf.setReadOnly(true);
		iptHolidayCause.setReadOnly(true);
		ica_from_ymd.setReadOnly(true);
		ica_to_ymd.setReadOnly(true);
		sbx_holiday_start_hour.setReadOnly(true);
		sbx_holiday_cls_hour.setReadOnly(true);
		ibx_agent_empno.setReadOnly(true);	
		btn_req_psn.setDisabled(true);
		btn_agent.setDisabled(true);
		btn_Annual.setDisabled(true);
	};


	// 성과지표 유형에 따른 기여도 점수 세팅

	scwin.sbx_ctrbt_points_onchange = function(info) {
		dma_ctrbtReq.set("points", "");

		if (sbx_ctrbt_eval_index.getValue() == 'tf') {
			dma_ctrbtReq.set("points", "1.5");
			dma_ctrbtReq.set("ind_type", "RPP009");
			dma_ctrbtReq.set("ind_cd", "RPC997");
			
			// 성과지표 유형 변경에 따라 기여자그리드 기여도 변경
			for(let row = 0; row < dlt_ctrbtMember.getRowCount(); row++ ){		
				if(dlt_ctrbtMember.getCellData(row, "points") != ''){
					dlt_ctrbtMember.setCellData(row, "points", "1.5");
				}
			}			
		} else if (sbx_ctrbt_eval_index.getValue() == 'committee') {
			dma_ctrbtReq.set("points", "1.0");
			dma_ctrbtReq.set("ind_type", "RPP010");
			dma_ctrbtReq.set("ind_cd", "RPC998");
			
			// 성과지표 유형 변경에 따라 기여자그리드 기여도 변경
			for(let row = 0; row < dlt_ctrbtMember.getRowCount(); row++ ){		
				if(dlt_ctrbtMember.getCellData(row, "points") != ''){
					dlt_ctrbtMember.setCellData(row, "points", "1.0");
				}
			}
		} else if (sbx_ctrbt_eval_index.getValue() == 'evaluator') {
			dma_ctrbtReq.set("points", "0.5");
			dma_ctrbtReq.set("ind_type", "RPP011");
			dma_ctrbtReq.set("ind_cd", "RPC999");
			
			// 성과지표 유형 변경에 따라 기여자그리드 기여도 변경
			for(let row = 0; row < dlt_ctrbtMember.getRowCount(); row++ ){		
				if(dlt_ctrbtMember.getCellData(row, "points") != ''){
					dlt_ctrbtMember.setCellData(row, "points", "0.5");
				}
			}
		}
	};

	/**
	 * 기여자 추가 버튼 클릭 이벤트
	 */
	scwin.btn_plus_onclick = function(e) {
		var idx = com.addRow(grd_ctrbtMember);
		dlt_ctrbtMember.setCellData(idx);
	};


	/**
	 * 기여자 삭제 버튼 클릭 이벤트
	 */
	scwin.btn_compn_minus_onclick = function(e) {
		scwin.removeGridRows(grd_ctrbtMember, "Compn");
		tbx_compn_cnt.setValue(dlt_ctrbtMember.getRowCount());
	};
	
	
	scwin.removeGridRows = function(gridObj, type){
		var rows = gridObj.getCheckedIndex("chk");
		if(rows.length == 0){
			com.alert(com.getMsg("message.xom.co.com.0003", "삭제할 행"));
			return;
		}
		rows.reverse().forEach(function(rowIndex){
			if(type == "Compn"){ 
				dlt_ctrbtMember.removeRow(rowIndex);
			}
		});
		
		if(type == "Compn"){ 
			dlt_ctrbtMember.reform();	
		}
	}
	
	
	/**
	 * 사원검색 및 팝업호출
	 */
	 			 
	 scwin.getEmpInfo = function(row, data) {
				
				data == "img" ? data = { empno : ""} : data = { 
					empno : data,
					nm : data,
					work_clsf : "HAG010"
				};
				
	
				com.pop.open( com.pop.TYPE.HUM, data, function(ret) {
					if (ret) {
						
						// 기여자 그리드 중복 기여자 입력 검증
						var arr = dlt_ctrbtMember.getMatchedIndex("rate_syspayno", ret.syspayno, true);
						if(arr.length > 0){				
							com.alert(com.getMsg("message.xom.ui.ccs.006", ret.nm));
							tbx_compn_cnt.setValue(dlt_ctrbtMember.getRowCount() - 1);
							dlt_ctrbtMember.setCellData(row, "rate_syspayno", "");
							dlt_ctrbtMember.setCellData(row, "rate_empno", "");
							dlt_ctrbtMember.setCellData(row, "rate_nm", "");
							dlt_ctrbtMember.setCellData(row, "rate_dept_cd", "");
							dlt_ctrbtMember.setCellData(row, "rate_dept_new_ymd", "");
							dlt_ctrbtMember.setCellData(row, "rate_dept_nm", "");
							dlt_ctrbtMember.setCellData(row, "rate_division_cd", "");
							dlt_ctrbtMember.setCellData(row, "rate_division_nm", "");
							dlt_ctrbtMember.setCellData(row, "rate_posi_nm", "");
							dlt_ctrbtMember.setCellData(row, "rate_posi_cd", "");
							dlt_ctrbtMember.setCellData(row, "points", "");
							return;
						}
						
						tbx_compn_cnt.setValue(dlt_ctrbtMember.getRowCount());
						
						dlt_ctrbtMember.setCellData(row, "rate_syspayno", ret.syspayno);
						dlt_ctrbtMember.setCellData(row, "rate_empno", ret.empno);
						dlt_ctrbtMember.setCellData(row, "rate_nm", ret.nm);
						dlt_ctrbtMember.setCellData(row, "rate_dept_cd", ret.dept_cd);
						dlt_ctrbtMember.setCellData(row, "rate_dept_new_ymd", ret.dept_new_ymd);
						dlt_ctrbtMember.setCellData(row, "rate_dept_nm", ret.dept_nm);
						dlt_ctrbtMember.setCellData(row, "rate_division_cd", ret.divsn_dept);
						dlt_ctrbtMember.setCellData(row, "rate_division_nm", ret.divsn_dept_nm);
						dlt_ctrbtMember.setCellData(row, "rate_posi_nm", ret.posi_nm);
						dlt_ctrbtMember.setCellData(row, "rate_posi_cd", ret.posi_cd);
						dlt_ctrbtMember.setCellData(row, "points", dma_ctrbtReq.get("points"));
					}
				});
			};
	
	
	/**
	 * 기여자 그리드 textimage 클릭 이벤트
	 */
	 
	scwin.grd_ctrbtMember_ontextimageclick = function(row) {	
		if(dma_ctrbtReq.get("points") == "" ){
			alert('성과지표 유형을 먼저 선택해주세요.');
			dlt_ctrbtMember.setCellData(row, "rate_empno", "");
			return;
		}
		scwin.getEmpInfo(row, dlt_ctrbtMember.getCellData(row, "rate_empno"));
	};
			
	/**
	 * 기여자 그리드 변경 이벤트
	 */
	scwin.grd_ctrbtMember_onviewchange = function(info) {
		var row = info.rowIndex;
		if(!dma_ctrbtReq.get("points") || dma_ctrbtReq.get("points") == "" ){
			alert('성과지표 유형을 먼저 선택해주세요.');
			dlt_ctrbtMember.setCellData(row, "rate_empno", "");
			return;
		}
		
		if(info.colIndex == grd_ctrbtMember.getColumnIndex("rate_empno")){
			if(dlt_ctrbtMember.getCellData(row, "rate_empno") == ""){
				dlt_ctrbtMember.setCellData(row, "rate_syspayno", "");
				dlt_ctrbtMember.setCellData(row, "rate_nm", "");
				dlt_ctrbtMember.setCellData(row, "rate_posi_cd", "");
				dlt_ctrbtMember.setCellData(row, "rate_posi_nm", "");
				dlt_ctrbtMember.setCellData(row, "rate_dept_nm", "");
				dlt_ctrbtMember.setCellData(row, "rate_dept_cd", "");
				dlt_ctrbtMember.setCellData(row, "rate_division_cd", "");
				dlt_ctrbtMember.setCellData(row, "rate_division_nm", "");
				dlt_ctrbtMember.setCellData(row, "points", "");
			}else{
				scwin.getEmpInfo(row, dlt_ctrbtMember.getCellData(row, "rate_empno"));
			}			
		}		
	};
	
	
	
	/**
	 * 저장
	 */
	scwin.save = function() {

		com.file.transport( function( attachObj){
			dma_ctrbtReq.set("attach_file_no", attachObj.upload_A);
			dma_ctrbtReq.set("validAttachNo", attachObj.upload_A);
			
			// 총점 계산(스냅샷 용도)
			var totPointsSum = 0;
			for(var i=0; i<dlt_ctrbtMember.getRowCount(); i++){
				totPointsSum += Number(dlt_ctrbtMember.getCellData(i, "points"));
			}	
			dma_ctrbtReq.set("total_points", totPointsSum);
			
			com.execute(sbm_saveCtrbtReq, {
				successCallback : function(e) { // 성공 콜백
					if(scwin.data.isApproval){
						// 결재화면 이동
//						com.openTabMenu("A001", { "reqNo" :  dma_ctrbtReq.get("rcpt_no")}, function() {
//							scwin.search();
//						});
						com.movePageMenu("A001", { "reqNo" :  dma_ctrbtReq.get("rcpt_no")});
					}else{
						com.alert("message.xom.wq.023"/*정상적으로 처리되었습니다.*/, function() {
							scwin.search();
						});
					}
				} ,
				exceptionCallback : function(resObj) {
					var resultCd = gcm.sbm.getResCode(resObj);
					var msg = gcm.lang.getMsg(resultCd);
					var resJSON = resObj.responseJSON || null;
					var resultMsg = gcm.sbm.getResMsg(resObj); 
					
					if (gcm.util.isEmpty(msg) || msg == resultCd || msg.indexOf("{0}") != -1) { 
						// resultCd가 등록되지 않은 메시지 코드인 경우 resultMsg alert
						msg = resultMsg;
					}
					if (!com.isEmpty(resJSON.userHeader.errBusiness)) {
						msg = "["+ resJSON.userHeader.errBusiness +"] "+ msg;
					}
					if (resJSON.userHeader.errKind == "ALERT") {
						com.alert(msg);
					} else if (resJSON.userHeader.errKind == "ERROR") {
						com.error(msg);
					} else {
						com.warn(msg);
					}
					
				}
			});
		});
	};
	
	
	/** 공통 유효성 체크 */
	scwin.isCommonValid = function() {
		if (!com.validateData(dma_ctrbtReq,[
				{ id : "req_ymd", mandatory : true},
				{ id : "ctrbt_eval_index", mandatory : true},
				{ id : "content", mandatory : true},
			], false)
			) return false;
		if (!com.validateData(dlt_ctrbtMember,[
				{ id : "rate_nm", mandatory : true}
			], false)
			) return false;	
		return true;
	};
	

	/**
	 * 결재신청 버튼 클릭 이벤트
	 */
	scwin.btn_apr_onclick = function(e) {
		//결재신청 변수 설정
		var btnClickType = "apr";
		// 필수입력값 체크
		if (!scwin.isCommonValid()) return;
		if (dlt_ctrbtMember.getRowCount() == 0) {
			alert("기여자는 필수 입력 항목입니다.");
			return;
		}
		if(com.file.action.getTotalFileCount(upload_A.getID()) < 1){
			com.alert(com.getMsg("message.xom.co.com.0011", "첨부파일"));
			return;
		}		
		scwin.sendApr();
	};
	
	/**
	 * 결재
	 */
	scwin.sendApr = function(){
		scwin.data.isApproval = true;
		dma_ctrbtReq.set("approval", "true");
		dma_ctrbtReq.set("aply_yn", "N");
		
		// 결재 aprVo info_cd 정보
		var infoCd
		
		if (dlt_ctrbtMember.getRowCount() > 1) {
			infocd = dlt_ctrbtMember.getCellData(0, "rate_nm") + "(" + dlt_ctrbtMember.getCellData(0, "rate_empno") + ") 외 " + ( dlt_ctrbtMember.getRowCount() - 1 ) + "명 / " + dma_ctrbtReq.get("ind_type_nm");
		} else {
			infocd = dlt_ctrbtMember.getCellData(0, "rate_nm") + "(" + dlt_ctrbtMember.getCellData(0, "rate_empno") + ") / " + dma_ctrbtReq.get("ind_type_nm");
		}
				
		dma_ctrbtReq.set("apr_info", infocd);
		
		scwin.save();
	};

	/**
	 * 목록 버튼 클릭 이벤트
	 */	
	scwin.btn_pre_onclick = function(e) {
		com.moveList('J665');
	};
	
	/**
	 * 결재문서보기 클릭 이벤트
	 */
	scwin.btn_apr_view_onclick = function(e) {
		var url = "/ui/apr/layoutSimple.xml";
		var option = { type: "browserPopup", width: 1350, height: 1480, id: "snapshotPop", popupName: "결재문서"};
		var data = { reqNo: dma_ctrbtReq.get("rcpt_no")
		            , viewMode : "read"
		            , instStatus : (dma_ctrbtReq.get("apr_state") == "XAD100")? "Completed" : "Running"
		};
		 
		com.openPopup(url, option, data);
	};


	]]></script>
	</head>
	
	<style><![CDATA[
	]]></style>

	<body ev:onpageload="scwin.onpageload">
		<w2:wframe id="wfm_title" src="/cm/xml/contentTitle.xml" style=""></w2:wframe>
		<xf:group id="grp_page" class="pageWrap">
			<xf:group class="searchSection step" id="" style="">
				<xf:group class="le" id="" style="">
					<xf:trigger class="btn" ev:onclick="scwin.btn_pre_onclick" id="btn_pre" style="" type="button">
						<xf:label><![CDATA[목록]]></xf:label>
					</xf:trigger>
				</xf:group>
				<xf:group class="ri" id="" style="">
					<xf:group class="btnbox" id="">
						<xf:trigger class="btn" ev:onclick="scwin.btn_apr_view_onclick" id="btn_apr_view" style="" type="button"
							disabled="true">
							<xf:label><![CDATA[결재문서보기]]></xf:label>
						</xf:trigger>
						<xf:trigger class="btn blue" ev:onclick="scwin.btn_apr_onclick" id="btn_apr" style="" type="button" disabled="true">
							<xf:label><![CDATA[결재신청]]></xf:label>
						</xf:trigger>
					</xf:group>
				</xf:group>
			</xf:group>
			<xf:group class="w2tb tbl" id="grp_ctrbt_req_info" style="" tagname="table">
				<w2:attributes>
					<w2:summary></w2:summary>
				</w2:attributes>
				<xf:group tagname="caption" text="조직기여도신청자 정보"></xf:group>
				<xf:group tagname="colgroup">
					<xf:group style="width:160px;" tagname="col"></xf:group>
					<xf:group style="" tagname="col"></xf:group>
					<xf:group style="width:160px;" tagname="col"></xf:group>
					<xf:group style="" tagname="col"></xf:group>
				</xf:group>
    			<xf:group tagname="tr">
    				<xf:group tagname="th" class="w2tb_th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox tagname="span" style="" id="" label="제출자"></w2:textbox>
    				</xf:group>
    				<xf:group tagname="td" class="w2tb_td">
    					<w2:attributes></w2:attributes>
    					<w2:textbox class="txt" tagname="span" style="" id="req_nm" label="00" ref="data:dma_ctrbtReq.req_nm"></w2:textbox>
    				</xf:group>
    				<xf:group tagname="th" class="w2tb_th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox tagname="span" style="" id="" label="부서"></w2:textbox>
    				</xf:group>
    				<xf:group tagname="td" class="w2tb_td">
    					<w2:attributes></w2:attributes>
    					<w2:textbox class="txt" id="req_dept_nm" label="00" style="" tagname="span" ref="data:dma_ctrbtReq.req_dept_nm"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th" style="">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="직급" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td" style="">
    					<w2:attributes></w2:attributes>
    					<w2:textbox class="txt" id="req_posi_nm" label="00" style="" tagname="span" ref="data:dma_ctrbtReq.req_posi_nm"></w2:textbox>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr" style="">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:span class="bul_req" id="" label="[필수입력항목]" style=""></w2:span>
    					<w2:textbox id="" label="제출일" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:inputCalendar calendarValueType="yearMonthDate" class="inpcal req" focusOnDateSelect="false" footerDiv="false" 
    						id="req_ymd" placeholder="제출일" renderDiv="true" rightAlign="false" style="" title="신청일"
    						ref="data:dma_ctrbtReq.req_ymd">
    					</w2:inputCalendar>
    					<w2:attributes></w2:attributes>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="결재상태" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<w2:textbox class="txt" id="apr_state_nm" label="" style="" tagname="span" ref="data:dma_ctrbtReq.apr_state_nm"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_th" style="" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="접수번호" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" style="" tagname="td">
    					<w2:attributes></w2:attributes>
    					<w2:textbox class="txt" id="rcpt_no" label="" style="" tagname="span" ref="data:dma_ctrbtReq.rcpt_no"></w2:textbox>
    				</xf:group>
    			</xf:group>    							
			</xf:group>
			<xf:group class="w2tb tbl" id="grp_ctrbt_req_content" style="" tagname="table">
				<xf:group tagname="caption" text="조직기여도 제출]" style=""></xf:group>	
				<xf:group tagname="colgroup" style="">
					<xf:group style="width:160px;" tagname="col"></xf:group>
					<xf:group style="" tagname="col"></xf:group>
					<xf:group style="width:160px;" tagname="col"></xf:group>
					<xf:group style="" tagname="col"></xf:group>
				</xf:group>
				<xf:group tagname="tr" style="">
					<xf:group class="w2tb_th" tagname="th">
						<w2:attributes>
							<w2:scope>row</w2:scope>
						</w2:attributes>
						<w2:span class="bul_req" id="" label="[필수입력항목]" style=""></w2:span>
						<w2:textbox id="" label="성과지표 유형" style="" tagname="span"></w2:textbox>
					</xf:group>
					<xf:group class="w2tb_td" tagname="td">
						<w2:attributes></w2:attributes>
						<xf:select1 allOption="" appearance="minimal" chooseOption="true" chooseOptionLabel="-선택-" class="sel req full"
							direction="auto" disabled="false" disabledClass="w2selectbox_disabled" id="sbx_ctrbt_eval_index" ref="data:dma_ctrbtReq.ctrbt_eval_index"
							style="" submenuSize="auto" title="조직기여도 구분" textAlign="center" ev:onchange="scwin.sbx_ctrbt_points_onchange">
							<xf:choices>
								<xf:item>
									<xf:label><![CDATA[TF 참여 활동]]></xf:label>
									<xf:value><![CDATA[tf]]></xf:value>
								</xf:item>
								<xf:item>
									<xf:label><![CDATA[위원회 활동]]></xf:label>
									<xf:value><![CDATA[committee]]></xf:value>
								</xf:item>
								<xf:item>
									<xf:label><![CDATA[평가위원 활동]]></xf:label>
									<xf:value><![CDATA[evaluator]]></xf:value>
								</xf:item>
							</xf:choices>
						</xf:select1>
					</xf:group>
					<xf:group class="w2tb_th" tagname="th">
						<w2:attributes>
							<w2:scope>row</w2:scope>
						</w2:attributes>
						<w2:span class="bul_req" id="" label="[필수입력항목]" style=""></w2:span>
						<w2:textbox id="" label="활동명" style="" tagname="span"></w2:textbox>
					</xf:group>
					<xf:group class="w2tb_td" tagname="td">
						<w2:attributes>
							<w2:colspan>3</w2:colspan>
							<w2:rowspan>1</w2:rowspan>
						</w2:attributes>
						<xf:input adjustMaxLength="false" class="inp req full" id="actvty_nm" ref="data:dma_ctrbtReq.actvty_nm" style="" title="활동명" >
    					</xf:input>
					</xf:group>
				</xf:group>
				<xf:group tagname="tr" style="">
					<xf:group class="w2tb_th" tagname="th">
						<w2:attributes>
							<w2:scope>row</w2:scope>
						</w2:attributes>
						<w2:span class="bul_req" id="" label="[필수입력항목]" style=""></w2:span>
						<w2:textbox id="" label="주요내용(요약)" style="" tagname="span"></w2:textbox>
					</xf:group>
					<xf:group class="w2tb_td" tagname="td">
						<w2:attributes>
							<w2:colspan>5</w2:colspan>
							<w2:rowspan>1</w2:rowspan>
						</w2:attributes>
						<xf:group id="group" style="width:100%;height:80px;">
							<xf:textarea class="req" id="txt_content" maxlength="3000" style="height:80px;" title="" ref="data:dma_ctrbtReq.content"></xf:textarea>
						</xf:group>
					</xf:group>
				</xf:group>
			</xf:group>

			<xf:group class="titleSection" id="" style="">
    			<w2:textbox class="tit_tbl" id="" label="기여자" style="" tagname="h3"></w2:textbox>
    			<xf:group class="btnarea" id="" style="">
    				<xf:group class="result" id="" style="">
    					<w2:span id="" label="총" style=""></w2:span>
    					<w2:span class="numtotal" id="tbx_compn_cnt" label="0" style=""></w2:span>
    					<w2:span id="" label="건" style="margin-right:5px;"></w2:span>
    				</xf:group>
    				<xf:trigger class="bt_plus" ev:onclick="scwin.btn_plus_onclick" id="btn_plus" style="" type="button">
    					<xf:label><![CDATA[추가]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="bt_minus" id="btn_compn_minus" style="" type="button" ev:onclick="scwin.btn_compn_minus_onclick">
    					<xf:label><![CDATA[삭제]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    		</xf:group>
    		<w2:gridView autoFit="allColumn" class="grid" dataList="data:dlt_ctrbtMember" defaultCellHeight="28" evenRowBackgroundColor="#f7faff"
    			id="grd_ctrbtMember" noResultMessage="조회 결과가 없습니다." noResultMessageClass="noResult" rowMouseOverColor="#e7f0fb"
    			rowNumBackgroundColor="#fff" rowNumHeaderValue="No." rowNumVisible="true" rowNumWidth="40" rowStatusHeaderValue="상태"
    			rowStatusVisible="false" rowStatusWidth="50" scrollByColumn="false" scrollByColumnAdaptive="false" selectedCellColor="#fbf2cd"
    			selectedRowColor="#fbf2cd" style="height: 85px;" summaryAuto="true" visibleRowNum="5"
    			ev:ontextimageclick="scwin.grd_ctrbtMember_ontextimageclick" ev:onviewchange="scwin.grd_ctrbtMember_onviewchange">
    			<w2:caption id="caption1" style="" value="this is a grid caption."></w2:caption>
    			<w2:header id="header1" style="">
    				<w2:row id="row1" style="">
    					<w2:column displayMode="label" id="column7" inputType="text" style="height:28px;" value="선택" width="50"></w2:column>
    					<w2:column displayMode="label" id="column3" inputType="text" style="height:28px;" value="기여자" width="140" colSpan="2"
    						rowSpan="" class="req">
    					</w2:column>
    					<w2:column displayMode="label" id="column20" inputType="text" style="height:28px;" value="직급" width="100"></w2:column>
    					<w2:column displayMode="label" id="column29" inputType="text" style="height:28px;" value="본부" width="100"></w2:column>
    					<w2:column width="130" inputType="text" style="height:28px" id="column32" value="부서" displayMode="label"></w2:column>
    					<w2:column width="140" inputType="text" style="height:28px;" id="column30" value="기여도" displayMode="label"></w2:column>
    				</w2:row>
    			</w2:header>
    			<w2:gBody id="gBody1" style="">
    				<w2:row id="row2" style="">
    					<w2:column displayMode="label" id="chk" inputType="checkbox" style="height:28px;" width="50"
    						fixColumnWidth="true">
    					</w2:column>
    					<w2:column displayMode="label" escape="false" id="rate_empno" inputType="textImage" style="height:28px;"
    						width="70" editModeEvent="onclick" imageSrc="/cm/images/sample/btn_tbsearch02.png" class="req">
    					</w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="rate_nm" value="" displayMode="label"
    						readOnly="true" class="req">
    					</w2:column>
    					<w2:column class="" displayMode="label" id="rate_posi_nm" inputType="text" readOnly="true" style="height:28px;"
    						width="100">
    					</w2:column>
    					<w2:column class="" displayMode="label" id="rate_division_nm" inputType="text" readOnly="true" style="height:28px;"
    						width="100">
    					</w2:column>
    					<w2:column width="130" inputType="text" style="height:28px" id="rate_dept_nm" value="" displayMode="label"
    						readOnly="true">
    					</w2:column>
    					<w2:column class="" displayMode="label" id="points" inputType="text" readOnly="true" style="height:28px;"
    						width="100">
    					</w2:column>
    				</w2:row>
    			</w2:gBody>
    		</w2:gridView>

    		<xf:group class="w2tb tbl" id="grp_attach" style="" tagname="table">
    			<xf:group style="" tagname="caption" text="첨부파일"></xf:group><xf:group style="" tagname="colgroup">
    				<xf:group style="width:160px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    				<xf:group style="width:160px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    			</xf:group><xf:group tagname="tr" style="">
    				<xf:group class="w2tb_th" style="" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:span class="bul_req" id="" label="[필수입력항목]" style=""></w2:span>
    					<w2:textbox id="" label="첨부파일" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" style="" tagname="td">
    					<w2:attributes>
    						<w2:colspan>5</w2:colspan>
    						<w2:rowspan>1</w2:rowspan>
    					</w2:attributes>
    					<xf:group class="full" ev:onclick="scwin.upload_A_onclick" id="upload_A" style="height:150px;"></xf:group>
    				</xf:group>
    			</xf:group>
    		</xf:group>
			<xf:group class="w2tb tbl" id="tb_rcpt_info" style="" tagname="table">
				<w2:attributes>
					<w2:summary></w2:summary>
				</w2:attributes>
				<xf:group tagname="caption" text="접수정보"></xf:group>
				<xf:group tagname="colgroup">
					<xf:group style="width:160px;" tagname="col"></xf:group>
					<xf:group style="" tagname="col"></xf:group>
					<xf:group style="width:160px;" tagname="col"></xf:group>
					<xf:group style="" tagname="col"></xf:group>
				</xf:group>
    		</xf:group>
    		<xf:group style="" id="" class="btnGroup">
				<xf:group style="" id="" class="le"></xf:group>
				<xf:group id="" class="ri">

					<xf:trigger class=" btn pro conf" ev:onclick="scwin.btn_cofm_onclick" id="btn_cofm" style="" type="button">
						<xf:label><![CDATA[승인]]></xf:label>
					</xf:trigger>
					<xf:trigger class=" btn pro conf" ev:onclick="scwin.btn_rejct_onclick" id="btn_rejct" style="" type="button">
						<xf:label><![CDATA[반려]]></xf:label>
					</xf:trigger>
					<xf:trigger style="" id="btn_del" type="button" class=" btn pro" ev:onclick="scwin.btn_del_onclick" disabled="true">
						<xf:label><![CDATA[삭제]]></xf:label>
					</xf:trigger>
					<xf:trigger class=" btn pro conf" ev:onclick="scwin.btn_save_onclick" id="btn_save" style="" type="button">
						<xf:label><![CDATA[저장]]></xf:label>
					</xf:trigger>


				</xf:group>
    		</xf:group>
		</xf:group>
	</body>
</html>
