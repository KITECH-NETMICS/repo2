<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head meta_programName="제안심사 상세">
    	<w2:type>DEFAULT</w2:type>
        <w2:buildDate/>
        <xf:model>
            <xf:instance>
                <data xmlns=""/>
            </xf:instance>
            <w2:dataCollection baseNode="map">
				<w2:dataMap baseNode="map" id="dma_search">
					<w2:keyInfo>
						<w2:key id="eval_clsf_cd" name="eval_clsf_cd" dataType="text"></w2:key>
						<w2:key id="bid_ord_no" name="bid_ord_no" dataType="text"></w2:key>
						<w2:key id="ord_chg_no" name="ord_chg_no" dataType="text"></w2:key>
						<w2:key id="tech_eval_doc_no" name="tech_eval_doc_no" dataType="text"></w2:key>
						<w2:key id="tech_eval_assist_doc_no" name="tech_eval_assist_doc_no" dataType="text"></w2:key>
						<w2:key id="bid_noti_no" name="bid_noti_no" dataType="text"></w2:key>
						<w2:key id="chg_no" name="chg_no" dataType="text"></w2:key>
						<w2:key id="key8" name="eval_clsf_cd" dataType="text"></w2:key>
					</w2:keyInfo>
				</w2:dataMap>
				<w2:dataMap baseNode="map" id="dma_info">
					<w2:keyInfo>
						<w2:key id="bid_noti_no" name="bid_noti_no" dataType="text"></w2:key>
						<w2:key id="chg_no" name="chg_no" dataType="text"></w2:key>
						<w2:key id="assist_yn" name="assist_yn" dataType="text"></w2:key>
						<w2:key id="assist_charger_cd" name="assist_charger_cd" dataType="text"></w2:key>
						<w2:key id="eval_state" name="eval_state" dataType="text"></w2:key>
						<w2:key id="assist_charger_nm" name="assist_charger_nm" dataType="text"></w2:key>
						<w2:key id="bid_val_score" name="bid_val_score" dataType="text"></w2:key>
						<w2:key id="tech_eval_doc_no" name="tech_eval_doc_no" dataType="text"></w2:key>
						<w2:key id="eval_clsf_cd" name="eval_clsf_cd" dataType="text"></w2:key>
						<w2:key id="bid_ord_no" name="bid_ord_no" dataType="text"></w2:key>
						<w2:key id="bid_title" name="bid_title" dataType="text"></w2:key>
						<w2:key id="ord_chg_no" name="ord_chg_no" dataType="text"></w2:key>
						<w2:key id="tech_eval_assist_doc_no" name="tech_eval_assist_doc_no" dataType="text"></w2:key>
						<w2:key id="tech_nego_yn_cd" name="tech_nego_yn_cd" dataType="text"></w2:key>
						<w2:key id="sys_pay_no" name="sys_pay_no" dataType="text"></w2:key>
						<w2:key id="pur_clsf_cd" name="pur_clsf_cd" dataType="text"></w2:key>
						<w2:key id="cd_nm" name="cd_nm" dataType="text"></w2:key>
						<w2:key id="bid_clsf_cd" name="bid_clsf_cd" dataType="text"></w2:key>
						<w2:key id="charger_cd" name="charger_cd" dataType="text"></w2:key>
						<w2:key id="charger_nm" name="charger_nm" dataType="text"></w2:key>
						<w2:key id="pur_req_no" name="pur_req_no" dataType="text"></w2:key>
						<w2:key id="pq_score" name="pq_score" dataType="text"></w2:key>
						<w2:key id="eval_attach_file_no" name="eval_attach_file_no" dataType="text"></w2:key>
						<w2:key id="endpoints" name="endpoints" dataType="text"></w2:key>
						<w2:key id="endpoints_assist" name="endpoints_assist" dataType="text"></w2:key>
						<w2:key id="noti_progress_status" name="noti_progress_status" dataType="text"></w2:key>
						<w2:key id="org_bid_ord_no" name="org_bid_ord_no" dataType="text"></w2:key>
						<w2:key id="org_chg_no" name="org_chg_no" dataType="text"></w2:key>
						<w2:key id="eval_assist_attach_file_no" name="eval_assist_attach_file_no" dataType="text"></w2:key>
						<w2:key id="charge_nm" name="charge_nm" dataType="text"></w2:key>
						<w2:key id="ext_no" name="ext_no" dataType="text"></w2:key>
						<w2:key id="renoti_after_yn" name="renoti_after_yn" dataType="text"></w2:key>
						<w2:key id="rmk" name="rmk" dataType="text"></w2:key>
						<w2:key id="ui_id" name="ui_id" dataType="text"></w2:key>
						<w2:key id="syspayno" name="syspayno" dataType="text"></w2:key>
						<w2:key id="approvalCheck" name="approvalCheck" dataType="text"></w2:key>
						<w2:key id="apr_state" name="apr_state" dataType="text"></w2:key>
						<w2:key id="comments" name="comments" dataType="text"></w2:key>
					</w2:keyInfo>
				</w2:dataMap>
				<w2:dataList baseNode="list" repeatNode="map" id="dlt_list" saveRemovedData="true">
					<w2:columnInfo>
						<w2:column id="odr" name="odr" dataType="text"></w2:column>
						<w2:column id="vend_no" name="vend_no" dataType="text"></w2:column>
						<w2:column id="bsns_psn_regst_no" name="bsns_psn_regst_no" dataType="text"></w2:column>
						<w2:column id="vend_nm" name="vend_nm" dataType="text"></w2:column>
						<w2:column id="ceo_nm" name="ceo_nm" dataType="text"></w2:column>
						<w2:column id="tot_score" name="tot_score" dataType="text"></w2:column>
						<w2:column id="succ_yn" name="succ_yn" dataType="text"></w2:column>
						<w2:column id="eval_clsf_cd" name="eval_clsf_cd" dataType="text"></w2:column>
						<w2:column id="vend_cd" name="vend_cd" dataType="text"></w2:column>
						<w2:column id="new_odr" name="new_odr" dataType="text"></w2:column>
						<w2:column id="eval_state" name="eval_state" dataType="text"></w2:column>
						<w2:column id="bid_noti_no" name="bid_noti_no" dataType="text"></w2:column>
						<w2:column id="chg_no" name="chg_no" dataType="text"></w2:column>
					</w2:columnInfo>
				</w2:dataList>
            </w2:dataCollection>
            <w2:workflowCollection>
            </w2:workflowCollection>
            
    		<!-- 상세조회. 입찰개요 -->
    		<xf:submission id="sbm_outEpuBidTechEvalMasInfo" ref="data:json,dma_search" encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALMASR01.pwkjson" method="post" mediatype="application/json">
			</xf:submission>
    		<!-- 상세조회. 업체조회(규격심사평가등록) -->
    		<xf:submission id="sbm_outEpuBidTechEvalComInfo" ref="data:json,dma_search" encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALCOMR01.pwkjson" method="post" mediatype="application/json">
			</xf:submission>
            
    		<!-- 신청서 저장 -->
    		<xf:submission id="sbm_insertData" ref='data:json,[{"id":"dma_info","key":"epuBidTechEvalInfoVo"},{"id":"dlt_list","key":"epuBidTechEvalInfoVoList"}]' encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALINFOI01.pwkjson" method="post" mediatype="application/json">
    		</xf:submission>
    		<!-- 신청서 수정 -->
    		<xf:submission id="sbm_updateData" ref='data:json,[{"id":"dma_info","key":"epuBidTechEvalInfoVo"},{"id":"dlt_list","key":"epuBidTechEvalInfoVoList"}]' encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALINFOU01.pwkjson" method="post" mediatype="application/json">
    		</xf:submission>
            
    		<!-- 결재신청 -->
    		<xf:submission id="sbm_aprData" ref='data:json,dma_info' encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALAPRM01.pwkjson" method="post" mediatype="application/json">
    		</xf:submission>
    		<!-- 결재승인 -->
    		<xf:submission id="sbm_aprAgr" ref='data:json,dma_info' encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALACM01.pwkjson" method="post" mediatype="application/json">
    		</xf:submission>
    		<!-- 결재반려 -->
    		<xf:submission id="sbm_aprReject" ref='data:json,dma_info' encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALRJM01.pwkjson" method="post" mediatype="application/json">
    		</xf:submission>
            
        </xf:model>
         <script type="text/javascript" lazy="false"><![CDATA[
   	/****************************************************
	 * 화면 설명 : 기술평가요청(협상) -> 전체메뉴"기술평가관리"검색, 신청서양식함 검색, P313(목록) 통해서 들어와짐
	 * 변경 이력 : 2023-10-25 swt 최초생성
	 * serviceId : P379
	 ****************************************************/
	scwin.data={};
    /*************************************************************************************************************
     *
     *	페이지 이벤트 함수
     *
     *************************************************************************************************************/
	/**
	 * 페이지 열기
	 */   
	scwin.onpageload = function() {
		//권한
		com.biz.checkRole({ serviceId : "P379", roleCodes : com.getLoginInfo('roleCode')}, function(e){
			scwin.data.isRoleYn = e.isRoleYn;
		});
		
		//첨부파일 초기화  *필수*
		com.file.init();
		
		//숨김처리
		inp_assist_charger_empno.hide();	//평가 담당자 사번

		//엔터키 이벤트
		com.setEnterKeyEvent(grp_rspns, scwin.btn_rspns_onclick);	//평가 담당자 입력 후 엔터 -> 이름 사번 세팅
		
		var bid_noti_no 		= com.getParameter("bid_noti_no"); 
		var chg_no 				= com.getParameter("chg_no"); 
		var bid_ord_no 			= com.getParameter("bid_ord_no");
		var ord_chg_no 			= com.getParameter("ord_chg_no"); 
		var eval_clsf_cd 		= com.getParameter("eval_clsf_cd");
		scwin.data.eval_state	= com.getParameter("eval_state");			//상태 값 - 1 : 처리중, 2 : 처리완료, 3 : 조달청 전송 완료
	
		//결재 관련 변수
		var param2 = com.getParameter("req_no"); //req_no		
		var param3 = com.getParameter("param3"); //apr_state
		var param4 = com.getParameter("param4"); //apr
		var param2Arr = param2.split("-");
		var param2Apr = param2.substring(0,3);

		if (param4 == "apr") {   // 양식함

			if ( param2Apr == "P89") {
				dma_search.set("bid_ord_no"					, "");				//발주번호
				dma_search.set("ord_chg_no"					, "");				//정정차수
				dma_search.set("tech_eval_doc_no"			, param2);			//협조요청결재 문서번호
				
			} else {
				dma_search.set("bid_ord_no"					, param2Arr[0]);	//발주번호
				dma_search.set("ord_chg_no"					, param2Arr[1]);	//정정차수
				dma_search.set("tech_eval_doc_no"			, "");				//협조요청결재 문서번호
			}
		} else {
			dma_search.set("bid_ord_no"					, bid_ord_no);			//발주번호
			dma_search.set("ord_chg_no"					, ord_chg_no);			//정정차수
			dma_search.set("tech_eval_doc_no"			, "");					//협조요청결재 문서번호
		}
		
		dma_search.set("eval_clsf_cd"				, "PRC020");	//심사구분
		dma_search.set("tech_eval_assist_doc_no"	, "");			//협조내용결재 문서번호
		
		
		//목록에서 들어온 경우
		if (bid_noti_no != "") {
			scwin.search();	//조회
			
		//대기함에서 들어온 경우
		} else if (param2 != "") {
			scwin.search();	//조회
			
		//양식함에서 들어온 경우 작동X -> 버튼들 비활성화 처리
		} else {
			grp_rspns.setDisabled(true);		//평가 담당자 조회 버튼
			cbx_renoti_after_yn.setDisabled(true);	//수의계약 chkbox
			inp_bid_val_score.setDisabled(true);	//입찰가격배점
			inp_rmk.setDisabled(true);			//비고
			noti_text_area.hide();				//안내 텍스트 숨김
			btn_re_noti.setDisabled(true);		//재공고
			btn_oz_prnt_02.setDisabled(true);	//기술평가 요청서
			btn_apr.setDisabled(true);			//결재신청
			btn_vend_del.setDisabled(true);		//규격심사평가등록 추가 버튼
			btn_vend_add.setDisabled(true);		//규격심사평가등록 삭제 버튼
			btn_save.setDisabled(true);			//저장
			btn_prt_2.hide();					//승인, 반려 그룹영역 숨김
			
			//첨부파일 -> "구매부서 요청 첨부서류" upload_A.하단
			var attachFileNo = dma_info.get("eval_attach_file_no");
			com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo) ? attachFileNo : 'H379', mode: "view"});
		}
		
	};

	/**
	 * 페이지 닫기
	 */   
	scwin.onpageunload = function() {
		
	};

    /**
     * 상세 조회
     */	
	scwin.search = function() {

		//신청전 기본 데이터 조회
		com.execute(sbm_outEpuBidTechEvalMasInfo, {
			successCallback : function(e) {

				//상세정보 데이터 세팅
				dma_info.setJSON(e.responseJSON.elData);
				
				//작성, 수정 시 -> eval_state 전역변수 데이터 변경
				scwin.data.eval_state = dma_info.get("eval_state");
				
				//심사구분  세팅
				var eval_clsf_cd = dma_info.get("eval_clsf_cd");
				switch (eval_clsf_cd) {
					//기술용역
					case "PRC010" : inp_eval_type.setValue( "PQ심사" ); 
									break;
					case "PRC020" : inp_eval_type.setValue( "제안심사" ); 
									break;
					case "PRC030" : inp_eval_type.setValue( "규격심사" ); 
									break;
					case "PRC040" : inp_eval_type.setValue( "적격심사" ); 
									break;
					default 		: inp_eval_type.setValue( "PQ심사" ); 
									break;
				}
				
				//업체 조회(규격심사평가등록) 조회조건 세팅
				var bid_noti_no 			= dma_info.get("bid_noti_no"); 
				var chg_no 					= dma_info.get("chg_no"); 
				var eval_clsf_cd 			= dma_info.get("eval_clsf_cd");

				dma_search.set("bid_noti_no"	, bid_noti_no);		//공고번호
				dma_search.set("chg_no"			, chg_no);			//공고차수
				dma_search.set("eval_clsf_cd"	, eval_clsf_cd);	//심사구분
				
				//업체 조회(규격심사평가등록)
				com.execute(sbm_outEpuBidTechEvalComInfo, {
					successCallback : function(e) {
						
						//구격심사평가등록 -> 업체 데이터 세팅
						dlt_list.setJSON(e.responseJSON.epuBidTechEvalInfoVoList);
						
						//재공고버튼 처리
						var noti_progress_status = dma_info.get("noti_progress_status");
						if (noti_progress_status == "PRA100") {
							btn_re_noti.setDisabled(false);
						} else {
							btn_re_noti.setDisabled(true);
						}
						
						//상태 값에 따른 버튼 컨트롤
						scwin.hideButton();		//버튼
						scwin.checkLabelNm();	//텍스트문구
						
					}
				});	
				
			}
		});	
	
	};
	
    /**
     * 상태 값에 따른 버튼 컨트롤
     */
	scwin.hideButton = function() {

		var bid_noti_no 	= dma_info.get("bid_noti_no"); 
		var chg_no 			= dma_info.get("chg_no"); 
		var bid_ord_no 		= dma_info.get("bid_ord_no");
		var ord_chg_no 		= dma_info.get("ord_chg_no"); 
		var eval_clsf_cd 	= dma_info.get("eval_clsf_cd");
		var eval_state 		= dma_info.get("eval_state");			//상태 값 - 1 : 처리중, 2 : 처리완료, 3 : 조달청 전송 완료
		
		//첨부파일 -> "구매부서 요청 첨부서류" upload_A.하단
		var attachFileNo = dma_info.get("eval_attach_file_no");
		
		//심사대기
		if (eval_state == '' || eval_state== "PRD010") {
			//저장 활성화, 협조요청/결재 비활성화
			btn_apr.setDisabled(true);			//결재신청 버튼
			btn_prt_2.hide();					//승인, 반려 버튼(그룹영역)
			btn_oz_prnt_02.setDisabled(true);	//기술평가 요청서
			com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo) ? attachFileNo : 'H382', mode: "edit"});
			
		//작성중
		} else if (eval_state == "PRD020") {
			btn_apr.setDisabled(false);			//결재신청 버튼
			btn_prt_2.hide();					//승인, 반려 버튼(그룹영역)
			btn_oz_prnt_02.setDisabled(false);	//기술평가 요청서
			com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo) ? attachFileNo : 'H382', mode: "edit"});
//			scwin.checkId();					//사용자에 따른 버튼 컨트롤
			
		//요청결재중
		} else if (eval_state == "PRD030") {
			btn_apr.setDisabled(true);				//결재신청 버튼
			btn_vend_add.setDisabled(true);			//업체 추가 + 버튼
			btn_vend_del.setDisabled(true);			//업체 삭제 - 버튼
			grp_rspns.setDisabled(true);			//평가 담당자
			btn_prt_2.show();						//승인, 반려 버튼(그룹영역)
			btn_prt_1.hide();						//저장 버튼(그룹영역)
			inp_bid_val_score.setReadOnly(true);	//입찰가격배점
			inp_rmk.setReadOnly(true);				//비고
			cbx_renoti_after_yn.setDisabled(true);	//수의계약 체크박스
			com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo) ? attachFileNo : 'H382', mode: "view"});
//			scwin.checkId();						//사용자에 따른 버튼 컨트롤
			
		} else {
			btn_apr.setDisabled(true);				//결재신청 버튼
			btn_save.setDisabled(true);				//저장 버튼
			btn_vend_add.setDisabled(true);			//업체 추가 + 버튼
			btn_vend_del.setDisabled(true);			//업체 추가 - 버튼
			btn_confirm.setDisabled(true);			//결재승인
			btn_ret.setDisabled(true);				//결재반려
			cbx_renoti_after_yn.setDisabled(true);	//수의계약 체크박스
		
		} 

	};
	
    /**
     * 사용자에 따른 버튼 컨트롤
     */
	scwin.checkId = function() {
		
		var endpoints	= dma_info.get("endpoints");
		var uid			= com.getLoginInfo("uid");
		
		endpoints = endpoints.replace(";", "");
		
		if ( endpoints != uid ) {
			btn_apr.setDisabled(true);			//결재신청
			btn_save.setDisabled(true);			//저장
			btn_vend_add.setDisabled(true);		//업체 추가 + 버튼
			btn_vend_del.setDisabled(true);		//업체 추가 - 버튼
			btn_confirm.setDisabled(true);		//결재승인
			btn_ret.setDisabled(true);			//결재반려
		}
		
	};
	
    /**
     *  사용자 조회(돋보기) 버튼 클릭 이벤트
     */
	scwin.btn_rspns_onclick = function(e) {
		var data = { empno : inp_assist_charger_cd.getValue().trim(), work_clsf : "HAG010" }
		com.pop.open( com.pop.TYPE.HUM, data, function(ret){
			
			inp_assist_charger_cd.setValue(ret.syspayno);	//평가 담당자 개인번호
			inp_assist_charger_nm.setValue(ret.nm);			//평가 담당자 성명
			inp_assist_charger_empno.setValue(ret.empno);	//평가 담당자 사원번호
			
		});
	};
	
    /**
     * 목록 버튼 클릭 이벤트
     */
	scwin.btn_list_onclick = function(e) {
		com.moveList("P313", "");
	};
	
    /**
     * 재공고 버튼 클릭 이벤트
     */
	scwin.btn_re_noti_onclick = function(e) {
		
		var pur_clsf_cd = dma_info.get("pur_clsf_cd");
		var bid_noti_no = dma_info.get("bid_noti_no");
		
		com.confirm("본 입찰을 재공고하시겠습니까?", function(ret){
			if(ret){
				//이동시 넘겨야할 인자 값 정의
				var param = { 	 
								ord_flag : 'renoti',
								bid_ord_no : dma_info.get("bid_ord_no"),			//발주번호
								chg_no : dma_info.get("ord_chg_no"),				//변경차수
								vend_no : dlt_list.getCellData( 0 , "vend_no" ),	//번호
								vend_nm : dlt_list.getCellData( 0 , "vend_nm" ),	//업체명
								bsns_psn_regst_no : dlt_list.getCellData( 0 , "bsns_psn_regst_no" ),	//사업자 등록번호
								ceo_nm : dlt_list.getCellData( 0 , "bsns_psn_regst_no" )	//대표자
							};				
				
				var svrId = pur_clsf_cd ="EGF010"?"P302":pur_clsf_cd=="EGF020"?"P345":"P303";
				
				com.openTabMenu(svrId, param);
			}
		});
		
	};
	
    /**
     * 기술평가 요청서 버튼 클릭 이벤트(OzReport)
     */
	scwin.btn_oz_prnt_02_onclick = function(e) {
		//EpuTechEvalReq.ozr
		var node =  "BidOrdNo="	 + inp_bid_ord_no.getValue()
				  +"&BidNotiNo=" + inp_bid_noti_no.getValue()
				  +"&ChgNo="	 + dma_info.get("chg_no")
				  +"&BidTitle="	 + dma_info.get("bid_title")
				  +"&PurReqNo="	 + dma_info.get("pur_req_no")
				  +"&EvalClsfCd="+ dma_info.get("eval_clsf_cd")
				  +"&EmpNo="	 + dma_info.get("assist_charger_cd")
				  +"&SysPayNo="	 + com.getLoginInfo("sn")
					
		com.oz.openPopup({
			ozrCode: "P037",    
			param: node
		});	
	};
	
    /**
     * 규격심사평가등록 "+" 버튼 클릭 이벤트 (업체 추가)
     */
	scwin.btn_vend_add_onclick = function(e) {
		
		biz.epu.pop.open(biz.epu.pop.TYPE.EPU_BID_G2B, {}, function(ret) {
			var rowCnt = dlt_list.getRowCount();
			var cnt = 0;
			for (var i = 0; i < ret.length; i++) {
				var rowData = ret[i];
				rowData.cud_type = "C";
				
				if (rowCnt == 0) {
					dlt_list.setRowJSON(i, rowData);
					dlt_list.setCellData(i, "vend_no", rowData.vend_cd);
				} else {
					//중복체크
					if (scwin.checkVendAdd(rowData)) {
						dlt_list.setRowJSON(rowCnt+cnt, rowData);
						dlt_list.setCellData(rowCnt+cnt, "vend_no", rowData.vend_cd);
						cnt++;
					}
				}
			}
		});
		
	};
	
    /**
     * 규격심사평가등록 내 "-" 버튼 클릭 이벤트 (업체 삭제)
     */
	scwin.btn_vend_del_onclick = function(e) {

		var row = grid1.getFocusedRowIndex();
		if (row < 0) {
			com.alert("삭제할 행을 선택하여 주십시오.");
			return;
		}
		dlt_list.removeRow(row);
		
	};
	
    /**
     * 지명업체 중복여부 체크
     */
	scwin.checkVendAdd = function(rowData) {
	
		for (var j=0; j < dlt_list.getRowCount(); j++) {
			if (dlt_list.getCellData(j, "bsns_psn_regst_no") == rowData.bsns_psn_regst_no) {
				com.alert(rowData.vend_nm + "는 이미 지명업체에 추가 되었습니다.");
				return;
			}			
		}
		
		return true;
	};
	
    /**
     * 저장, 결재신청 전 필수값체크
     */
	scwin.preSave = function() {
	
		//평가 담당자가 없는 경우
		if (inp_assist_charger_nm.getValue() == "" || inp_assist_charger_cd.getValue().trim() == "") {
			com.alert("평가 담당자를 등록하여 주십시오.");
			return;
		}
		//기술평가목록이 없는 경우
		if (grid1.getRowCount() <= 0) {
			com.alert("심사평가 업체를 등록하여 주십시오.");
			return;
		}
		//입찰가격배점이 없는 경우
		if (inp_bid_val_score.getValue().trim() == "") {
			com.alert("입찰가격배점을 입력하여 주십시오.");
			return;
		}
		
		return true;
	};

    /**
     * 저장 버튼 클릭 이벤트
     */
	scwin.btn_save_onclick = function(e) {
		
		//필수값체크 실행
		if (!scwin.preSave()) {
			return false;
		}
		
		com.confirm("message.xom.wq.017"/*저장 하시겠습니까?*/, function(ret) {
			if (ret) {
				
				//저장로직 실행
				scwin.save();
				
			}
		});
		
	};
	
    /**
     * 결재신청 버튼 클릭 이벤트
     */
	scwin.btn_apr_onclick = function(e) {
		
		//필수값체크 실행
		if (!scwin.preSave()) {
			return false;
		}
	
		//결재신청 로직
		com.confirm("결재신청 하시겠습니까?", function(ret){
			if (ret) {
				
				//저장로직 실행
				scwin.save("apr");
			}
		});
		
	};
	
    /**
     * 저장, 수정, 결재신청 로직
     */	
	scwin.save = function(saveType) {
		
		var eval_state = dma_info.get("eval_state");
		
		//신규, 수정
		if (saveType != "apr") {
		
			//"PRD010"심사대기 상태 -> 신규 작성
			if (eval_state == "PRD010") {
				
				com.file.transport( function(attachObj){
				
					//추가 데이터 세팅
					dma_info.set("eval_state"				, "PRD020");				//"작성중" 진행상태(query는 update 사용함. 기존에 존재하는 데이터에 새로운 진행상태 update로 확인)
					dma_info.set("ui_id"					, "P382");					//serviceId
					dma_info.set("eval_attach_file_no"		, attachObj.upload_A);		//첨부파일
					dma_info.set("charger_cd"				, com.getLoginInfo("sn"));	//평가 담당자 개인번호
					dma_info.set("charger_nm"				, com.getLoginInfo("cn"));	//평가 담당자 이름
					
					dma_info.set("renoti_after_yn"			, cbx_renoti_after_yn.getValue() == "Y" ? "Y" : "N"); // 수의계약을 위한 제안서 적합성 평가
					
					//dlt_list에 new_odr 추가해주기 위함
					for(var i = 0; i < dlt_list.getRowCount(); i++){
						dlt_list.setCellData(i, "bid_noti_no"	, dma_info.get("bid_noti_no"));
						dlt_list.setCellData(i, "chg_no"		, dma_info.get("chg_no"));
						dlt_list.setCellData(i, "eval_clsf_cd"	, dma_info.get("eval_clsf_cd"));
						dlt_list.setCellData(i, "new_odr" 		, i+1);
						dlt_list.setCellData(i, "eval_state" 	, eval_state);
					}
					
					//저장
					com.execute(sbm_insertData, {
						successCallback : function(e) { // 성공 콜백					
							com.alert("message.xom.wq.023"/*정상적으로 처리되었습니다.*/, function() {
							
								//리턴받은 신청번호로 상세조회
								scwin.search();
								
							});		
						}
					});
					
				});
				
				
			//"PRD020"작성중 상태 -> 수정
			} else if (eval_state == "PRD020") {
				
				com.file.transport( function(attachObj){
				
					//추가 데이터 세팅
					dma_info.set("eval_state"				, dma_info.get("eval_state"));			//현재 진행상태
					dma_info.set("ui_id"					, "P382");								//serviceId
					dma_info.set("eval_attach_file_no"		, attachObj.upload_A);					//첨부파일
					dma_info.set("charger_cd"				, com.getLoginInfo("sn"));				//
					dma_info.set("charger_nm"				, com.getLoginInfo("cn"));				//
					
					dma_info.set("tech_eval_doc_no"			, dma_info.get("tech_eval_doc_no"));	//신청번호
					
					dma_info.set("renoti_after_yn"			, cbx_renoti_after_yn.getValue() == "Y" ? "Y" : "N"); // 수의계약을 위한 제안서 적합성 평가
					dma_info.set("syspayno"					, com.getLoginInfo("sn"));	//
					
					//dlt_list에 new_odr 추가해주기 위함
					for(var i = 0; i < dlt_list.getRowCount(); i++){
						dlt_list.setCellData(i, "bid_noti_no"	, dma_info.get("bid_noti_no"));
						dlt_list.setCellData(i, "chg_no"		, dma_info.get("chg_no"));
						dlt_list.setCellData(i, "eval_clsf_cd"	, dma_info.get("eval_clsf_cd"));
						dlt_list.setCellData(i, "new_odr" 		, i+1);
						dlt_list.setCellData(i, "odr" 			, i+1);
						dlt_list.setCellData(i, "eval_state" 	, eval_state);
					}
					
					//수정
					com.execute(sbm_updateData, {
						successCallback : function(e) { // 성공 콜백					
							com.alert("message.xom.wq.023"/*정상적으로 처리되었습니다.*/, function() {
							
								//재조회
								scwin.search();
								
							});		
						}
					});
					
				});
				
			} else {
				com.alert("결재신청건은 수정할 수 없습니다.");
				return;
			}

			
		//결재신청
		} else if (saveType == "apr") {
			//스냅샷
			
			//추가 데이터 세팅
			dma_info.set("eval_state"				, "PRD030");	//PRD030 요청결재중
			dma_info.set("ui_id"					, "P382");		//serviceId
			
			//결재신청
			com.execute(sbm_aprData, {
				successCallback : function(e) { // 성공 콜백					
					//com.alert("message.xom.wq.023"/*정상적으로 처리되었습니다.*/, function() {
					com.alert("제안심사를 요청 하였습니다.", function() {
					
						//to-be : 결재진행함으로 이동해야하는거같기도하고 근데 일단은 재조회로 해둠
						//com.openTabMenu("A005", {});
						
						//재조회
						scwin.search();
					});		
				}
			});
			
		}
		
	};
	
    /**
     * 승인 버튼 클릭 이벤트
     */
	scwin.btn_confirm_onclick = function(e) {
		
//		if(!scwin.data.isRoleYn){
//			com.alert("관리자외에는 처리를 하실 수 없습니다.");
//			return;
//		}
		
		//추가 필요 데이터 세팅		
		dma_info.set("approvalCheck", "0");
		dma_info.set("ui_id"		, "P453");	//"결재진행함" -> "신청서 상세조회"로 들어가면 "P453"로 serviceId가 정의되어있음. "P379"로 하면 workList 에러 발생
		
		//승인
		com.confirm("승인처리 하시겠습니까?", function(ret) { 		
			if(ret) {
				com.execute(sbm_aprAgr, {
					successCallback : function(e) {
						com.alert("제안심사요청이 승인되었습니다.");
						com.openTabMenu("A004", {});
					}
				});
			}
		});
		
	};
	
    /**
     * 반려 버튼 클릭 이벤트
     */
	scwin.btn_ret_onclick = function(e) {
		
//		if(!scwin.data.isRoleYn){
//			com.alert("관리자외에는 반려를 하실 수 없습니다.");
//			return;
//		}
		
		var options = {
		    id: "APR02P",
		    popupName: "반려의견",
		    width: 500,
		    height: 300
		};
		
		//추가 필요 데이터 세팅		
		dma_info.set("approvalCheck", "2");
		dma_info.set("ui_id"		, "P453");	//"결재진행함" -> "신청서 상세조회"로 들어가면 "P452"로 serviceId가 정의되어있음. "P382"로 하면 workList 에러 발생
		dma_info.set("eval_state"	, "PRD020");//반려시 작성중으로 변경하기 위함
		
		//반려		
		com.openPopup("/ui/apr/APR_C001_03P.xml", options, "", function(retObj) {
		    if (retObj.comments != null) {
		        dma_info.set("comments", retObj.comments);
		        com.execute(sbm_aprReject, {
		            successCallback: function(e) {
		                com.alert("제안심사요청이 반려되었습니다.");
		                com.openTabMenu("A004", {});
		            }
		        });
		    }
		});
		
	};
	
    /**
     * 수의계약 chkbox 변경 이벤트_1
     */
	scwin.cbx_renoti_after_yn_oncheckboxclick = function(index,checked,value) {
		if (scwin.data.eval_state == "PRD010" || scwin.data.eval_state == "PRD020")	{
			inp_bid_val_score.setValue("");
		}
		scwin.checkLabelNm();
	};

    /**
     * 수의계약 chkbox 변경 이벤트_2
     */
	scwin.cbx_renoti_after_yn_onlabelclick = function(index,checked,value) {
		if (scwin.data.eval_state == "PRD010" || scwin.data.eval_state == "PRD020")	{
			inp_bid_val_score.setValue("");
		}
		scwin.checkLabelNm();
	};
	
    /**
     * [입찰가격배점] text란 이름 변경 이벤트
     */
	scwin.checkLabelNm = function() {
	
		if (cbx_renoti_after_yn.getValue() == "Y") {
			textbox10.setLabel("적합성평가 총점");	//입찰가격배점 -> 적합성평가 총점으로 변경
			
			if (inp_bid_val_score.getValue() != "" && inp_bid_val_score.getValue() != null) {
				var bidVal = Math.round(inp_bid_val_score.getValue()* 0.85 * 1000)/1000;
				tb_info_score.setValue("※ 수의계약 가능여부 확인을 위하여, 제안서 적합성 평가를 진행하여 주시기 바랍니다. 총 배점은 "+inp_bid_val_score.getValue()+"점이며, "+bidVal+"점 이상일 경우 수의계약 가능합니다.");
				
			} else {
				tb_info_score.setValue("");
			}
			
		} else {
			textbox10.setLabel("입찰가격배점");
			tb_info_score.setValue("");
		}
		
	};
	
    /**
     * [입찰가격배점] 배점 입력 시 발생
     */
	scwin.inp_bid_val_score_onblur = function(e) {
	
		if (inp_bid_val_score.getValue() != "" && inp_bid_val_score.getValue() != null) {
			var bidVal = Math.round(inp_bid_val_score.getValue()* 0.85 * 1000)/1000;
			tb_info_score.setValue("※ 수의계약 가능여부 확인을 위하여, 제안서 적합성 평가를 진행하여 주시기 바랍니다. 총 배점은 "+inp_bid_val_score.getValue()+"점이며, "+bidVal+"점 이상일 경우 수의계약 가능합니다.");
		} else {
			tb_info_score.setValue("");
		}
		
	};
	]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload" ev:onpageunload="scwin.onpageunload">
    	<w2:wframe id="wfm_title" src="/cm/xml/contentTitle.xml" style=""></w2:wframe>
    	<xf:group class="pageWrap" id="" style="">
    		<xf:group class="searchSection step" id="" style="">
    			<xf:group class="le" id="">
    				<xf:trigger class="btn " id="btn_list" style="" type="button" ev:onclick="scwin.btn_list_onclick">
    					<xf:label><![CDATA[목록]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    			<xf:group class="btnbox" id="">
    				<xf:trigger class="btn " id="btn_re_noti" style="" type="button" ev:onclick="scwin.btn_re_noti_onclick">
    					<xf:label><![CDATA[재공고]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="btn " id="btn_oz_prnt_02" style="" type="button" ev:onclick="scwin.btn_oz_prnt_02_onclick">
    					<xf:label><![CDATA[기술평가 요청서]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="btn blue" id="btn_apr" style="" type="button" ev:onclick="scwin.btn_apr_onclick">
    					<xf:label><![CDATA[결재신청]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    		</xf:group>
    		<xf:group class="w2tb tbl" id="" style="" tagname="table">
    			<w2:attributes>
    				<w2:summary></w2:summary>
    			</w2:attributes>
    			<xf:group tagname="caption"></xf:group>
    			<xf:group tagname="colgroup">
    				<xf:group style="width:200px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    				<xf:group style="width:200px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    			</xf:group>
    			<xf:group style="" tagname="tr">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="입찰공고번호" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_bid_noti_no" style="max-width:200px;" title="입찰공고번호"
    						disabled="true" ref="data:dma_info.bid_noti_no">
    					</xf:input>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="발주계획번호" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_bid_ord_no" style="max-width:200px;" title="발주계획번호"
    						disabled="true" ref="data:dma_info.bid_ord_no">
    					</xf:input>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="공고명" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_bid_title" style="" title="공고명" disabled="true"
    						ref="data:dma_info.bid_title">
    					</xf:input>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="심사구분" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_eval_type" style="max-width:200px;" title="심사구분"
    						disabled="true">
    					</xf:input>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="평가 담당자" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:group class="flex" id="" style="">
    						<xf:group class="inpSch fix" id="grp_rspns" style="width:120px;">
    							<xf:input adjustMaxLength="false" class="inp" id="inp_assist_charger_cd" style="" title="개인번호"
    								ref="data:dma_info.assist_charger_cd" trim="true">
    							</xf:input>
    							<xf:trigger class="btn" id="btn_rspns" style="" type="button" ev:onclick="scwin.btn_rspns_onclick">
    								<xf:label><![CDATA[검색]]></xf:label>
    							</xf:trigger>
    						</xf:group>
    						<xf:input adjustMaxLength="false" class="inp full" id="inp_assist_charger_nm" style="max-width: 120px;"
    							title="평가 담당자" disabled="true" ref="data:dma_info.assist_charger_nm">
    						</xf:input>
    						<xf:input adjustMaxLength="false" class="inp full" disabled="true" id="inp_assist_charger_empno"
    							style="max-width: 10px;" title="평가 담당자">
    						</xf:input>
    					</xf:group>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="textbox10" label="입찰가격배점" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_bid_val_score" style="max-width:200px;" title="입찰가격배점"
    						ref="data:dma_info.bid_val_score" dataType="number" ev:onblur="scwin.inp_bid_val_score_onblur">
    					</xf:input>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    						<w2:colspan>4</w2:colspan>
    						<w2:rowspan>1</w2:rowspan>
    					</w2:attributes>
    					<xf:select appearance="full" class="chkGroup" cols="" id="cbx_renoti_after_yn" ref="data:dma_info.renoti_after_yn"
    						renderType="checkboxgroup" rows="" selectedindex="-1" style="" ev:onlabelclick="scwin.cbx_renoti_after_yn_onlabelclick" ev:oncheckboxclick="scwin.cbx_renoti_after_yn_oncheckboxclick">
    						<xf:choices>
    							<xf:item>
    								<xf:label><![CDATA[수의계약을 위한 제안서 적합성 평가]]></xf:label>
    								<xf:value><![CDATA[Y]]></xf:value>
    							</xf:item>
    						</xf:choices>
    					</xf:select>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="비고" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes>
    						<w2:colspan>3</w2:colspan>
    						<w2:rowspan>1</w2:rowspan>
    					</w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_rmk" style="" title="비고" ref="data:dma_info.rmk"></xf:input>
    				</xf:group>
    			</xf:group>
    			
    		</xf:group>
    		<xf:group class="helparea" id="noti_text_area" style="">
    				<xf:group id="" style="" tagname="ol">
    					<xf:group id="" tagname="li">
    						<w2:textbox class="red" id="tb_info_score" label="수의계약 가능여부 확인을 위하여, 제안서 적합성 평가를 진행하여 주시기 바랍니다. 총 배점은 100점이며, 85점 이상일 경우 수의계약 가능합니다." style="" tagname="span"></w2:textbox>
    					</xf:group>
    				</xf:group>
    			</xf:group><xf:group class="titleSection" id="" style=""><xf:group class="le" id="" style="">
    				<w2:textbox class="tit_tbl" id="" label="제안심사평가등록" style="" tagname="h3"></w2:textbox>
    			</xf:group>
    			<xf:group class="ri" id="" style="">
    				<xf:trigger class="btn" ev:onclick="scwin.btn_vend_add_onclick" id="btn_vend_add" style="" type="button">
    					<xf:label><![CDATA[추가]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="btn" ev:onclick="scwin.btn_vend_del_onclick" id="btn_vend_del" style="" type="button">
    					<xf:label><![CDATA[삭제]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    			
    		</xf:group>
    		<w2:gridView autoFit="allColumn" class="grid" dataList="data:dlt_list" defaultCellHeight="28"
    			evenRowBackgroundColor="#f7faff" id="grid1" noResultMessage="조회 결과가 없습니다." noResultMessageClass="noResult" rowMouseOverColor="#e7f0fb"
    			rowNumBackgroundColor="#fff" rowNumHeaderValue="No." rowNumVisible="true" rowNumWidth="60" rowStatusHeaderValue="상태"
    			rowStatusVisible="false" rowStatusWidth="50" scrollByColumn="false" scrollByColumnAdaptive="false" selectedCellColor="#fbf2cd"
    			selectedRowColor="#fbf2cd" style="height: 150px;" visibleRowNum="10">
    			<w2:caption id="caption1" style="" value="this is a grid caption."></w2:caption>
    			<w2:header id="header1" style="">
    				<w2:row id="row1" style="">
    					<w2:column displayMode="label" id="column10" inputType="text" style="height:28px" value="사업자등록번호" width="150"></w2:column>
    					<w2:column displayMode="label" id="column18" inputType="text" style="height:28px" value="상호명" width="300"></w2:column>
    					<w2:column displayMode="label" id="column16" inputType="text" style="height:28px" value="대표자명" width="150"></w2:column>
    				</w2:row>
    			</w2:header>
    			<w2:gBody id="gBody1" style="">
    				<w2:row id="row2" style="">
    					<w2:column displayMode="label" id="bsns_psn_regst_no" inputType="text" style="height:28px" value="" width="150" displayFormat="###-##-#####" readOnly="true"></w2:column>
    					<w2:column class="" displayMode="label" id="vend_nm" inputType="text" style="height:28px" textAlign="left"
    						value="" width="300" readOnly="true">
    					</w2:column>
    					<w2:column displayMode="label" id="ceo_nm" inputType="text" style="height:28px" value="" width="150" readOnly="true"></w2:column>
    				</w2:row>
    			</w2:gBody>
    		</w2:gridView>
    		<xf:group class="titleSection" id="" style="">
    			<w2:textbox class="tit_tbl" id="" label="평가요청 첨부서류" style="" tagname="h3"></w2:textbox>
    		</xf:group>
    		<xf:group class="w2tb tbl" id="" style="width:100%;" tagname="table">
    			<w2:attributes>
    				<w2:summary></w2:summary>
    			</w2:attributes>
    			<xf:group tagname="caption"></xf:group>
    			<xf:group tagname="colgroup">
    				<xf:group style="width:180px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    			</xf:group>
    			<xf:group style="" tagname="tr">
    				<xf:group class="w2tb_th" style="" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="첨부파일" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" style="" tagname="td">
    					<xf:group class="fileuploadBox" id="upload_A" style="height:150px;"></xf:group>
    				</xf:group>
    			</xf:group>
    		</xf:group>
    		<xf:group class="btnGroup" id="btn_prt_1" style="">
    			<xf:group class="le" id="" style=""></xf:group>
    			<xf:group class="ri" id="">
    				<xf:trigger class=" btn pro conf" id="btn_save" style="" type="button" ev:onclick="scwin.btn_save_onclick">
    					<xf:label><![CDATA[저장]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    			
    		</xf:group><xf:group class="btnGroup" id="btn_prt_2" style="">
    				<xf:group class="le" id="" style=""></xf:group>
    				<xf:group class="ri" id="">
    					<xf:trigger class="btn pro" id="btn_confirm" style="" type="button" ev:onclick="scwin.btn_confirm_onclick">
    						<xf:label><![CDATA[승인]]></xf:label>
    					</xf:trigger>
    					<xf:trigger class="btn pro" id="btn_ret" style="" type="button" ev:onclick="scwin.btn_ret_onclick">
    						<xf:label><![CDATA[반려]]></xf:label>
    					</xf:trigger>
    				</xf:group>
    			</xf:group>
    	</xf:group>
    </body>
</html>
