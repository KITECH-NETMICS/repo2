<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head meta_programName="(구매입찰) 제안심사평가 수요부서">
    	<w2:type>DEFAULT</w2:type>
        <w2:buildDate/>
        <xf:model>
            <xf:instance>
                <data xmlns=""/>
            </xf:instance>
            <w2:dataCollection baseNode="map">
				<w2:dataMap baseNode="map" id="dma_search">
					<w2:keyInfo>
						<w2:key id="eval_clsf_cd" name="eval_clsf_cd" dataType="text"></w2:key>
						<w2:key id="bid_ord_no" name="bid_ord_no" dataType="text"></w2:key>
						<w2:key id="ord_chg_no" name="ord_chg_no" dataType="text"></w2:key>
						<w2:key id="tech_eval_doc_no" name="tech_eval_doc_no" dataType="text"></w2:key>
						<w2:key id="tech_eval_assist_doc_no" name="tech_eval_assist_doc_no" dataType="text"></w2:key>
						<w2:key id="bid_noti_no" name="bid_noti_no" dataType="text"></w2:key>
						<w2:key id="chg_no" name="chg_no" dataType="text"></w2:key>
						<w2:key id="syspayno" name="syspayno" dataType="text"></w2:key>
						<w2:key id="role_type" name="role_type" dataType="text"></w2:key>
						<w2:key id="defname" name="defname" dataType="text"></w2:key>
						<w2:key id="title" name="title" dataType="text"></w2:key>
						<w2:key id="name" name="name" dataType="text"></w2:key>
					</w2:keyInfo>
				</w2:dataMap>
				<w2:dataMap baseNode="map" id="dma_info">
					<w2:keyInfo>
						<w2:key id="bid_noti_no" name="bid_noti_no" dataType="text"></w2:key>
						<w2:key id="chg_no" name="chg_no" dataType="text"></w2:key>
						<w2:key id="assist_yn" name="assist_yn" dataType="text"></w2:key>
						<w2:key id="assist_charger_cd" name="assist_charger_cd" dataType="text"></w2:key>
						<w2:key id="eval_state" name="eval_state" dataType="text"></w2:key>
						<w2:key id="assist_charger_nm" name="assist_charger_nm" dataType="text"></w2:key>
						<w2:key id="bid_val_score" name="bid_val_score" dataType="text"></w2:key>
						<w2:key id="tech_eval_doc_no" name="tech_eval_doc_no" dataType="text"></w2:key>
						<w2:key id="eval_clsf_cd" name="eval_clsf_cd" dataType="text"></w2:key>
						<w2:key id="bid_ord_no" name="bid_ord_no" dataType="text"></w2:key>
						<w2:key id="bid_title" name="bid_title" dataType="text"></w2:key>
						<w2:key id="ord_chg_no" name="ord_chg_no" dataType="text"></w2:key>
						<w2:key id="tech_eval_assist_doc_no" name="tech_eval_assist_doc_no" dataType="text"></w2:key>
						<w2:key id="tech_nego_yn_cd" name="tech_nego_yn_cd" dataType="text"></w2:key>
						<w2:key id="sys_pay_no" name="sys_pay_no" dataType="text"></w2:key>
						<w2:key id="pur_clsf_cd" name="pur_clsf_cd" dataType="text"></w2:key>
						<w2:key id="cd_nm" name="cd_nm" dataType="text"></w2:key>
						<w2:key id="bid_clsf_cd" name="bid_clsf_cd" dataType="text"></w2:key>
						<w2:key id="charger_cd" name="charger_cd" dataType="text"></w2:key>
						<w2:key id="charger_nm" name="charger_nm" dataType="text"></w2:key>
						<w2:key id="pur_req_no" name="pur_req_no" dataType="text"></w2:key>
						<w2:key id="pq_score" name="pq_score" dataType="text"></w2:key>
						<w2:key id="eval_attach_file_no" name="eval_attach_file_no" dataType="text"></w2:key>
						<w2:key id="endpoints" name="endpoints" dataType="text"></w2:key>
						<w2:key id="endpoints_assist" name="endpoints_assist" dataType="text"></w2:key>
						<w2:key id="noti_progress_status" name="noti_progress_status" dataType="text"></w2:key>
						<w2:key id="org_bid_ord_no" name="org_bid_ord_no" dataType="text"></w2:key>
						<w2:key id="org_chg_no" name="org_chg_no" dataType="text"></w2:key>
						<w2:key id="eval_assist_attach_file_no" name="eval_assist_attach_file_no" dataType="text"></w2:key>
						<w2:key id="charge_nm" name="charge_nm" dataType="text"></w2:key>
						<w2:key id="ext_no" name="ext_no" dataType="text"></w2:key>
						<w2:key id="renoti_after_yn" name="renoti_after_yn" dataType="text"></w2:key>
						<w2:key id="rmk" name="rmk" dataType="text"></w2:key>
						<w2:key id="ui_id" name="ui_id" dataType="text"></w2:key>
						<w2:key id="syspayno" name="syspayno" dataType="text"></w2:key>
						<w2:key id="approvalCheck" name="approvalCheck" dataType="text"></w2:key>
						<w2:key id="apr_state" name="apr_state" dataType="text"></w2:key>
						<w2:key id="comments" name="comments" dataType="text"></w2:key>
						<w2:key id="approval" name="approval" dataType="text"></w2:key>
						<w2:key id="empno" name="empno" dataType="text"></w2:key>
						<w2:key id="nm" name="nm" dataType="text"></w2:key>
						<w2:key id="endpoint" name="endpoint" dataType="text"></w2:key>
					</w2:keyInfo>
				</w2:dataMap>
				<w2:dataList baseNode="list" repeatNode="map" id="dlt_list" saveRemovedData="true">
					<w2:columnInfo>
						<w2:column id="odr" name="odr" dataType="text"></w2:column>
						<w2:column id="vend_no" name="vend_no" dataType="text"></w2:column>
						<w2:column id="bsns_psn_regst_no" name="bsns_psn_regst_no" dataType="text"></w2:column>
						<w2:column id="vend_nm" name="vend_nm" dataType="text"></w2:column>
						<w2:column id="ceo_nm" name="ceo_nm" dataType="text"></w2:column>
						<w2:column id="tot_score" name="tot_score" dataType="text"></w2:column>
						<w2:column id="succ_yn" name="succ_yn" dataType="text"></w2:column>
						<w2:column id="eval_clsf_cd" name="eval_clsf_cd" dataType="text"></w2:column>
						<w2:column id="vend_cd" name="vend_cd" dataType="text"></w2:column>
						<w2:column id="new_odr" name="new_odr" dataType="text"></w2:column>
						<w2:column id="eval_state" name="eval_state" dataType="text"></w2:column>
						<w2:column id="bid_noti_no" name="bid_noti_no" dataType="text"></w2:column>
						<w2:column id="chg_no" name="chg_no" dataType="text"></w2:column>
					</w2:columnInfo>
				</w2:dataList>
            </w2:dataCollection>
            <w2:workflowCollection>
            </w2:workflowCollection>
            
    		<!-- 상세조회. 입찰개요 -->
    		<xf:submission id="sbm_outEpuBidTechEvalMasInfo" ref="data:json,dma_search" encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALMASR01.pwkjson" method="post" mediatype="application/json">
			</xf:submission>
    		<!-- 상세조회. 업체조회(규격심사평가등록) -->
    		<xf:submission id="sbm_outEpuBidTechEvalComInfo" ref="data:json,dma_search" encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALCOMR01.pwkjson" method="post" mediatype="application/json">
			</xf:submission>
    		<!-- 결재 최종담당자 정보 조회 -->
    		<xf:submission id="sbm_outEpuBidTechEvalEndPoint" ref="data:json,dma_search" encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALENDPNTR01.pwkjson" method="post" mediatype="application/json">
			</xf:submission>
            
    		<!-- 결재승인(접수버튼) -->
    		<xf:submission id="sbm_aprAgr" ref='data:json,dma_info' encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALACM01.pwkjson" method="post" mediatype="application/json">
    		</xf:submission>
    		<!-- 신청서 수정 -->
    		<xf:submission id="sbm_updateData" ref='data:json,[{"id":"dma_info","key":"epuBidTechEvalInfoVo"},{"id":"dlt_list","key":"epuBidTechEvalInfoVoList"}]' encoding="UTF-8" mode="asynchronous"
    			 action="SvcEPUBIDTECHEVALINFOU01.pwkjson" method="post" mediatype="application/json">
    		</xf:submission>
            
        </xf:model>
         <script type="text/javascript" lazy="false"><![CDATA[
   	/****************************************************
	 * 화면 설명 : 기술평가요청(협상) -> 전체메뉴"기술평가"검색, P440(목록) 통해서 들어와짐 
	 * 변경 이력 : 2023-10-26 swt 최초생성
	 * serviceId : P450
	 ****************************************************/
	scwin.data={};
    /*************************************************************************************************************
     *
     *	페이지 이벤트 함수
     *
     *************************************************************************************************************/
	/**
	 * 페이지 열기
	 */   
	scwin.onpageload = function() {
		
		//첨부파일 초기화  *필수*
		com.file.init();
		
		var bid_noti_no 		= com.getParameter("bid_noti_no"); 
		var chg_no 				= com.getParameter("chg_no"); 
		var bid_ord_no 			= com.getParameter("bid_ord_no");
		var ord_chg_no 			= com.getParameter("ord_chg_no"); 
		var eval_clsf_cd 		= com.getParameter("eval_clsf_cd");
		scwin.data.eval_state	= com.getParameter("eval_state");			//상태 값 - 1 : 처리중, 2 : 처리완료, 3 : 조달청 전송 완료
		
		//결재 관련 변수
		var param2 = com.getParameter("req_no"); //req_no		
		var param3 = com.getParameter("param3"); //apr_state
		var param4 = com.getParameter("param4"); //apr
		var param2Arr = param2.split("-");
		var param2Apr = param2.substring(0,3);
		
		//전역변수 설정
		scwin.data.param2 = param2;
		scwin.data.param3 = param3;
		scwin.data.param4 = param4;
		scwin.data.param2Arr = param2Arr;
		scwin.data.param2Apr = param2Apr;
		
		if(param4 == "apr"){   // 양식함
			if ( param2Apr == "P89") {
				dma_search.set("bid_ord_no"					, "");			//발주번호
				dma_search.set("ord_chg_no"					, "");			//정정차수
				dma_search.set("tech_eval_doc_no"			, param2);		//협조요청결재 문서번호
				dma_search.set("tech_eval_assist_doc_no"	, "");			//협조내용결재 문서번호
				
			} else if ( param2Apr == "P87") {
				dma_search.set("bid_ord_no"					, "");			//발주번호
				dma_search.set("ord_chg_no"					, "");			//정정차수
				dma_search.set("tech_eval_doc_no"			, "");			//협조요청결재 문서번호
				dma_search.set("tech_eval_assist_doc_no"	, param2);		//협조내용결재 문서번호
				
			} else {
				dma_search.set("bid_ord_no"					, param2Arr[0]);	//발주번호
				dma_search.set("ord_chg_no"					, param2Arr[1]);	//정정차수
				dma_search.set("tech_eval_doc_no"			, "");				//협조요청결재 문서번호
				dma_search.set("tech_eval_assist_doc_no"	, "");				//협조내용결재 문서번호
			}
		} else {
			dma_search.set("bid_ord_no"					, bid_ord_no);		//발주번호
			dma_search.set("ord_chg_no"					, ord_chg_no);		//정정차수
			dma_search.set("tech_eval_doc_no"			, "");				//협조요청결재 문서번호
			dma_search.set("tech_eval_assist_doc_no"	, "");				//협조내용결재 문서번호
		}
		
		dma_search.set("eval_clsf_cd"				, "PRC020");	//심사구분
		
		if (bid_noti_no != "") {	//목록에서 들어온 경우
			//조회
			scwin.search();
		} else if (param2 != "") {	//대기함에서 들어온 경우
			//조회
			scwin.search();
		} else {					//양식함에서 들어온 경우 -> 작동X
			//아무것도 작동X
		}
		
	};

	/**
	 * 페이지 닫기
	 */   
	scwin.onpageunload = function() {
		
	};
	
    /**
     * 상세 조회
     */	
	scwin.search = function() {
	
		//신청전 기본 데이터 조회
		com.execute(sbm_outEpuBidTechEvalMasInfo, {
			successCallback : function(e) {
				
				//상세정보 데이터 세팅
				dma_info.setJSON(e.responseJSON.elData);
				
				//작성, 수정 시 -> eval_state 전역변수 데이터 변경
				scwin.data.eval_state = dma_info.get("eval_state");
				
				//심사구분  세팅
				var eval_clsf_cd = dma_info.get("eval_clsf_cd");
				switch(eval_clsf_cd){
					//기술용역
					case "PRC010" : inp_eval_type.setValue( "PQ심사" ); 
									break;
					case "PRC020" : inp_eval_type.setValue( "제안심사" ); 
									break;
					case "PRC030" : inp_eval_type.setValue( "규격심사" ); 
									break;
					case "PRC040" : inp_eval_type.setValue( "적격심사" ); 
									break;
					default 		: inp_eval_type.setValue( "PQ심사" ); 
									break;
				}
				
				//안내문구 show,hide 처리
				if (dma_info.get("renoti_after_yn").trim() == "Y") {
					noti_text_area.show();
				} else {
					noti_text_area.hide();
				}
				
				if (dma_info.get("renoti_after_yn").trim() == "Y") {
				
					tb_info_score.show();
					textbox10.setLabel("적합성평가 총점");	//입찰가격배점 -> 적합성평가 총점으로 변경
					
					if (inp_bid_val_score.getValue() != "" && inp_bid_val_score.getValue() != null) {
						var bidVal = Math.round(inp_bid_val_score.getValue()* 0.85 * 1000)/1000;
						tb_info_score.setValue("※ 수의계약 가능여부 확인을 위하여, 제안서 적합성 평가를 진행하여 주시기 바랍니다. 총 배점은 "+inp_bid_val_score.getValue()+"점이며, "+bidVal+"점 이상일 경우 수의계약 가능합니다.");
					} else {
						tb_info_score.setValue("");
					}
				}

				//업체 조회(규격심사평가등록) 조회조건 세팅
				var bid_noti_no 			= dma_info.get("bid_noti_no"); 
				var chg_no 					= dma_info.get("chg_no"); 
				var eval_clsf_cd 			= dma_info.get("eval_clsf_cd");

				dma_search.set("bid_noti_no"	, bid_noti_no);		//공고번호
				dma_search.set("chg_no"			, chg_no);			//공고차수
				dma_search.set("eval_clsf_cd"	, eval_clsf_cd);	//심사구분
				
				//업체 조회(규격심사평가등록)
				com.execute(sbm_outEpuBidTechEvalComInfo, {
					successCallback : function(e) {
						
						//구격심사평가등록 -> 업체 데이터 세팅
						dlt_list.setJSON(e.responseJSON.epuBidTechEvalInfoVoList);
						
						//상태 값에 따른 버튼 컨트롤
						scwin.hideButton();
						
					}
				});	
				
			}
		});	
	
	};
	
    /**
     * 상태 값에 따른 버튼 컨트롤
     */
	scwin.hideButton = function() {

		var bid_noti_no 	= dma_info.get("bid_noti_no"); 
		var chg_no 			= dma_info.get("chg_no"); 
		var bid_ord_no 		= dma_info.get("bid_ord_no");
		var ord_chg_no 		= dma_info.get("ord_chg_no"); 
		var eval_clsf_cd 	= dma_info.get("eval_clsf_cd");
		var eval_state 		= dma_info.get("eval_state");			//상태 값 - 1 : 처리중, 2 : 처리완료, 3 : 조달청 전송 완료
		
		//결재 관련 변수
		var param2 = com.getParameter("req_no"); //req_no		
		var param3 = com.getParameter("param3"); //apr_state
		var param4 = com.getParameter("param4"); //apr
		var param2Arr = param2.split("-");
		var param2Apr = param2.substring(0,3);
		
		//첨부파일 -> "첨부서류" upload_B.상단
		var attachFileNo_1 = dma_info.get("eval_assist_attach_file_no");
		//첨부파일 -> "구매부서 요청 첨부서류" upload_A.하단
		var attachFileNo_2 = dma_info.get("eval_attach_file_no");
		
		if (param2Apr == "P87") {
			scwin.data.eval_state = "PRD050";
			btn_new.setDisabled(true);		//접수
			
			com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo_2) ? attachFileNo_2 : 'H450', mode: "view"});
			com.file.create(upload_B.getID(), {fileKey: com.isNotEmpty(attachFileNo_1) ? attachFileNo_1 : 'H450', mode: "edit"});
			
			scwin.checkIdAsssit();//사용자 비교해서 버튼 제어
			
		} else {
			
			//요청결재중
			if (eval_state == "PRD030") {	// 접수이전
				btn_apr.setDisabled(true);			//결재신청
				btn_oz_prnt_03.setDisabled(true);	//기술평가 결과서
				btn_save.setDisabled(true);			//저장
				
				com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo_2) ? attachFileNo_2 : 'H450', mode: "view"});
				com.file.create(upload_B.getID(), {fileKey: com.isNotEmpty(attachFileNo_1) ? attachFileNo_1 : 'H450', mode: "view"});				
				
				grid1.setReadOnly(true);
				grid1.setDisabled(true);
				
				scwin.checkId();//사용자 비교해서 버튼 제어
				
				
			//협조심사대기
			} else if (eval_state == "PRD040") {	// 접수 및 최초저장
				btn_apr.setDisabled(true);			//결재신청
				btn_new.setDisabled(true);			//접수
				btn_oz_prnt_03.setDisabled(true);	//기술평가 결과서
				btn_save.setDisabled(false);		//저장
				
				com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo_2) ? attachFileNo_2 : 'H450', mode: "view"});
				com.file.create(upload_B.getID(), {fileKey: com.isNotEmpty(attachFileNo_1) ? attachFileNo_1 : 'H450', mode: "edit"});
				
				scwin.checkId();//사용자 비교해서 버튼 제어
				
				
			//협조심사중
			} else if (eval_state == "PRD050") {	// 저장
				btn_apr.setDisabled(false);			//결재신청
				btn_new.setDisabled(true);			//접수
				btn_oz_prnt_03.setDisabled(false);	//기술평가 결과서
				
				com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo_2) ? attachFileNo_2 : 'H450', mode: "view"});
				com.file.create(upload_B.getID(), {fileKey: com.isNotEmpty(attachFileNo_1) ? attachFileNo_1 : 'H450', mode: "edit"});
				
				scwin.checkIdAsssit();//사용자 비교해서 버튼 제어
				
				
			//협조심사결재중
			} else if (eval_state == "PRD060") {
				
				dma_search.set("name"	, dma_info.get("bid_ord_no") + "-" + dma_info.get("ord_chg_no"));
				
				if (dma_info.get("bid_ord_no").substring(0, 3) == "P81") {
					dma_search.set("defname", "내자구매 통합프로세스");
					
				} else {
					dma_search.set("defname", "외자구매 통합프로세스");
				}
				
				if (dma_info.get("bid_clsf_cd") == "PRB040") {
					dma_search.set("title"	, "제안심사결과서 확정");	
					
				} else if (dma_info.get("bid_clsf_cd") == "PRB010") {
					dma_search.set("title"	, "제안심사결과서 전송");
				}
				
				//결재 최종담당자 정보 조회
				com.execute(sbm_outEpuBidTechEvalEndPoint, {
					successCallback : function(e) {
						
						btn_apr.setDisabled(true);			//결재신청
						btn_new.setDisabled(true);			//접수
						btn_save.setDisabled(true);			//저장
						
						//text와 data변경
						textbox12.setLabel("평가 담당자");		//"평가 요청자" -> "평가 담당자"로 변경
						inp_charger_nm.setValue(dma_info.get("assist_charger_nm"));

						com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo_2) ? attachFileNo_2 : 'H450', mode: "view"});
						com.file.create(upload_B.getID(), {fileKey: com.isNotEmpty(attachFileNo_1) ? attachFileNo_1 : 'H450', mode: "view"});
           				
						grid1.setReadOnly(true);
						grid1.setDisabled(true);
						
						//결재 최종담당자 조회 data로 버튼 추가 처리
						var endpointsBpm = "";
						var uid			 = com.getLoginInfo("uid");

						if (e.responseJSON.elData != null || e.responseJSON.elData != "") {
							endpointsBpm = e.responseJSON.elData;						
						}
						
						if (endpointsBpm != uid) {
							btn_oz_prnt_02.setDisabled(true);		//기술평가 요청서
						}
						
					}
				});	
				
				
			//심사확정
			} else if (eval_state == "PRD070") {
				btn_apr.setDisabled(true);		//결재신청
				btn_new.setDisabled(true);		//접수
				btn_save.setDisabled(true);		//저장
				textbox12.setLabel("평가 담당자");
				inp_charger_nm.setValue(dma_info.get("assist_charger_nm"));
				
				com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo_2) ? attachFileNo_2 : 'H450', mode: "edit"});
				com.file.create(upload_B.getID(), {fileKey: com.isNotEmpty(attachFileNo_1) ? attachFileNo_1 : 'H450', mode: "edit"});
				
				grid1.setReadOnly(true);
				grid1.setDisabled(true);
				

			//to-be 추가 : PRD010(심사대기), PRD020(작성중)이 해당. 본 화면에서 저장 불가능하기에 저장,수정 관련 로직 버튼 비활성화 추가
			} else {
				btn_apr.setDisabled(true);		//결재신청
				btn_new.setDisabled(true);		//접수
				btn_save.setDisabled(true);		//저장
				
				btn_oz_prnt_02.setDisabled(true);	//기술평가 요청서
				btn_oz_prnt_03.setDisabled(true);	//기술평가 결과서
				
				//PRD020인 경우에만 기술평가 요청서 활성화
				if (eval_state == "PRD020") {
					btn_oz_prnt_02.setDisabled(false);	//기술평가 요청서	
				}
				
				com.file.create(upload_A.getID(), {fileKey: com.isNotEmpty(attachFileNo_2) ? attachFileNo_2 : 'H450', mode: "view"});
				com.file.create(upload_B.getID(), {fileKey: com.isNotEmpty(attachFileNo_1) ? attachFileNo_1 : 'H450', mode: "view"});			
				
				grid1.setReadOnly(true);
				grid1.setDisabled(true);
			}
			
		}
		
	};

    /**
     * 사용자에 따른 버튼 컨트롤_1 (endpoints 사용)
     */
	scwin.checkId = function() {
		
		var endpoints	= dma_info.get("endpoints");
		var uid			= com.getLoginInfo("uid");
		
		if (endpoints != uid) {
			btn_apr.setDisabled(true);		//결재신청
			btn_new.setDisabled(true);		//접수
			btn_save.setDisabled(true);		//저장
		}
		
	};
	
    /**
     * 사용자에 따른 버튼 컨트롤_2 (endpoints_assist 사용)
     */
	scwin.checkIdAsssit = function() {
		
		var endpoints_assist	= dma_info.get("endpoints_assist");
		var uid					= com.getLoginInfo("uid");
		
		if (endpoints_assist != uid) {
			btn_apr.setDisabled(true);		//결재신청
			btn_new.setDisabled(true);		//접수
			btn_save.setDisabled(true);		//저장
		}
		
	};
	
    /**
     * 기술평가 요청서 버튼 클릭 이벤트(OzReport)
     */
	scwin.btn_oz_prnt_02_onclick = function(e) {
		//EpuTechEvalReq.ozr
		var node =  "BidOrdNo="	 + inp_bid_ord_no.getValue()
				  +"&BidNotiNo=" + inp_bid_noti_no.getValue()
				  +"&ChgNo="	 + dma_info.get("chg_no")
				  +"&BidTitle="	 + dma_info.get("bid_title")
				  +"&PurReqNo="	 + dma_info.get("pur_req_no")
				  +"&EvalClsfCd="+ dma_info.get("eval_clsf_cd")
				  +"&EmpNo="	 + dma_info.get("assist_charger_cd")
				  +"&SysPayNo="	 + com.getLoginInfo("sn")
					
		com.oz.openPopup({
			ozrCode: "P037",    
			param: node
		});	
	};

    /**
     * 기술평가 결과서 버튼 클릭 이벤트(OzReport)
     */	
	scwin.btn_oz_prnt_03_onclick = function(e) {
	
		//첨부파일 -> "구매부서 요청 첨부서류" upload_A.하단
		var attachFileNo_2 = dma_info.get("eval_attach_file_no");
		
		//EpuTechEvalCoop.ozr
		var node =  "BidOrdNo="	 + inp_bid_ord_no.getValue()
				  +"&BidNotiNo=" + inp_bid_noti_no.getValue()
				  +"&ChgNo="	 + dma_info.get("chg_no")
				  +"&BidTitle="	 + dma_info.get("bid_title")
				  +"&PurReqNo="	 + dma_info.get("pur_req_no")
				  +"&EvalClsfCd="+ dma_info.get("eval_clsf_cd")
				  +"&EmpNo="	 + dma_info.get("assist_charger_cd")
				  +"&SysPayNo="	 + com.getLoginInfo("sn")
				  +"&AttachFileNoP="		+ attachFileNo_2
				  +"&TechEvalAssistDocNo="	+ dma_info.get("tech_eval_assist_doc_no")
					
		com.oz.openPopup({
			ozrCode: "P038",    
			param: node
		});	
	};
	
    /**
     * 목록 버튼 클릭 이벤트
     */
	scwin.btn_list_onclick = function(e) {
		com.moveList("P440", "");
	};
	
    /**
     * 결재신청 버튼 클릭 이벤트
     */
	scwin.btn_apr_onclick = function(e) {
		
		
		
		
		
	};
	
    /**
     * 접수 버튼 클릭 이벤트
     */
	scwin.btn_new_onclick = function(e) {
		
		//추가 필요 데이터 세팅		
		dma_info.set("ui_id"			, "P450");
		dma_info.set("eval_state"		, "PRD040");	//PRD040 협조심사대기
		
		//접수(=결재승인 로직)
		com.confirm("접수 하시겠습니까?", function(ret) { 		
			if(ret) {
				com.execute(sbm_aprAgr, {
					successCallback : function(e) {
						com.alert("접수 완료 되었습니다.");
						com.openTabMenu("A004", {});
					}
				});
			}
		});
		
	};
	
    /**
     * 저장, 결재신청 전 필수값체크
     */
	scwin.preSave = function() {

		var eval_state = dma_info.get("eval_state");
		
		// 기술평가목록이 없는 경우
		if (grid1.getRowCount() <= 0) {
			com.alert("심사평가 업체를 등록하여 주십시오.");
			return;
		}
		
		if (eval_state == "PRD040" || eval_state == "PRD050") {	// 협조요청 후에는 평가 점수 필수
		
			var score = 100 - parseInt(inp_bid_val_score.getValue());
			
			// 기술평가점수가 없는 경우
			for(var i = 0; i < grid1.getRowCount(); i++){
			
				if (dlt_list.getCellData( i , "tot_score" ) == "") {
						com.alert("심사평가점수를 입력하여 주십시오." );
						return;
				}

				if (dma_info.get("renoti_after_yn").trim() == "Y") {
				
					if (WebSquare.util.getNumber(dlt_list.getCellData( i, "tot_score")) > inp_bid_val_score.getValue()) {
						com.alert( "적합성평가 총점 " + inp_bid_val_score.getValue() + "점을 넘길 수 없습니다." );
						dlt_list.setCellData(i , "tot_score" , "");
						return;
					}
					
				} else {
					
					if (WebSquare.util.getNumber(dlt_list.getCellData( i , "tot_score")) > score) {
						com.alert( "평가점수가 " + score + "점을 넘길 수 없습니다." );
						dlt_list.setCellData( i , "tot_score" , 0 );
						dlt_list.setFocusedCell( i, "tot_score", true);
						return;
					}
					
				}
				
				//적합여부가 없는 경우
				if (dlt_list.getCellData( i , "succ_yn").trim() == "") {
					com.alert("적합여부를 선택하여 주십시오." );
					return;
				}
				
			}
		}
		
		return true;
	};
	
    /**
     * 저장 버튼 클릭 이벤트
     */
	scwin.btn_save_onclick = function(e) {
		
		//필수값체크 실행
		if (!scwin.preSave()) {
			return false;
		}
		
		com.confirm("message.xom.wq.017"/*저장 하시겠습니까?*/, function(ret) {
			if (ret) {
				
				//저장로직 실행
				scwin.save("save");
				
			}
		});
		
	};
	
    /**
     * 저장, 수정, 결재신청 로직
     */	
	scwin.save = function(saveType) {

		var eval_state = dma_info.get("eval_state");
		
		//수정
		if (saveType == "save") {
		
			//"PRD040"협조심사대기 상태
			if (eval_state == "PRD040") {

				com.file.transport( function(attachObj){

					//추가 데이터 세팅
					dma_info.set("eval_state"					, dma_info.get("eval_state"));			//현재 진행상태
					dma_info.set("ui_id"						, "P450");								//serviceId
					dma_info.set("eval_attach_file_no"			, attachObj.upload_A);					//첨부파일(하단)
					dma_info.set("eval_assist_attach_file_no"	, attachObj.upload_B);					//첨부파일(상단)
					
					//dlt_list에 new_odr 추가해주기 위함
					for(var i = 0; i < dlt_list.getRowCount(); i++){
						dlt_list.setCellData(i, "bid_noti_no"	, dma_info.get("bid_noti_no"));
						dlt_list.setCellData(i, "chg_no"		, dma_info.get("chg_no"));
						dlt_list.setCellData(i, "eval_clsf_cd"	, dma_info.get("eval_clsf_cd"));
						dlt_list.setCellData(i, "new_odr" 		, i+1);
						dlt_list.setCellData(i, "odr" 			, i+1);
						dlt_list.setCellData(i, "eval_state" 	, eval_state);
					}
					
					//수정
					com.execute(sbm_updateData, {
						successCallback : function(e) { // 성공 콜백					
							com.alert("message.xom.wq.023"/*정상적으로 처리되었습니다.*/, function() {
								
								//재조회
								scwin.search();
								
							});		
						}
					});
					
				});
				
				
			//"PRD050"협조심사중 상태 -> 수정
			} else if (eval_state == "PRD050") {

				com.file.transport( function(attachObj){

					//추가 데이터 세팅
					dma_info.set("eval_state"					, dma_info.get("eval_state"));			//현재 진행상태
					dma_info.set("ui_id"						, "P450");								//serviceId
					
					dma_info.set("eval_attach_file_no"			, attachObj.upload_A);					//첨부파일(하단)
					dma_info.set("eval_assist_attach_file_no"	, attachObj.upload_B);					//첨부파일(상단)
					dma_info.set("tech_eval_assist_doc_no"		, dma_info.get("tech_eval_assist_doc_no"));		//협조내용결재 문서번호
					
					//dlt_list에 new_odr 추가해주기 위함
					for(var i = 0; i < dlt_list.getRowCount(); i++){
						dlt_list.setCellData(i, "bid_noti_no"	, dma_info.get("bid_noti_no"));
						dlt_list.setCellData(i, "chg_no"		, dma_info.get("chg_no"));
						dlt_list.setCellData(i, "eval_clsf_cd"	, dma_info.get("eval_clsf_cd"));
						dlt_list.setCellData(i, "new_odr" 		, i+1);
						dlt_list.setCellData(i, "odr" 			, i+1);
						dlt_list.setCellData(i, "eval_state" 	, eval_state);
					}
					
					//수정
					com.execute(sbm_updateData, {
						successCallback : function(e) { // 성공 콜백					
							com.alert("message.xom.wq.023"/*정상적으로 처리되었습니다.*/, function() {
								
								//재조회
								scwin.search();
								
							});		
						}
					});
					
				});
				
				
			//"PRD070"심사확정 상태 -> 수정불가alert
			} else if (eval_state == "PRD070") {
				com.alert("결재신청건은 수정할 수 없습니다.");
				return;
			}

			
		//결재신청
		} else if (saveType == "apr") {
			//스냅샷 결재신청

		}
		
	};
	
    /**
     * 제안심사평가등록 grid. 평가점수 변경 시 이벤트
     */	
	scwin.grid1_onviewchange = function(info) {
		
		var row = info.rowIndex;
		var col = info.colIndex;
		
		if (col == "3") {	//평가점수

			if (dma_info.get("renoti_after_yn") == "Y") {
				
				var scoreCal = Math.round(WebSquare.util.getNumber(dlt_list.getCellData(row, "tot_score"))/parseInt(inp_bid_val_score.getValue())*100*10000); 
				var score = scoreCal/10000;

				if (WebSquare.util.getNumber(dlt_list.getCellData(row, "tot_score")) > inp_bid_val_score.getValue()) {
					com.alert( "적합성평가 총점 " + inp_bid_val_score.getValue() + "점을 넘길 수 없습니다." );
					dlt_list.setCellData(row , "tot_score" , "");
					dlt_list.setCellData(row , "succ_yn" , "N");
					return;
				}

				if (score >= 85) {
					dlt_list.setCellData(row , "succ_yn" , "Y");
				} else {
					dlt_list.setCellData(row , "succ_yn" , "N");
				}
				
			} else {

				var score = 100 - parseInt(inp_bid_val_score.getValue());
				var baseScore = Math.round(score * 0.85*10)/10;

				if (WebSquare.util.getNumber(dlt_list.getCellData(row, "tot_score")) > score) {
					com.alert("평가점수가 " + score + "점을 넘길 수 없습니다.");
					dlt_list.setCellData(row , "tot_score", "");
					dlt_list.setCellData(row , "succ_yn" , "N");
					return;
				}
				
				if (WebSquare.util.getNumber(dlt_list.getCellData(row, "tot_score")) >= baseScore) {
					dlt_list.setCellData(row , "succ_yn" , "Y");
				} else {
					dlt_list.setCellData(row , "succ_yn" , "N");
				}
				
			}
		}
		
	};
	]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload" ev:onpageunload="scwin.onpageunload">
    	<w2:wframe id="wfm_title" src="/cm/xml/contentTitle.xml" style=""></w2:wframe>
    	<xf:group class="pageWrap" id="" style="">
    		<xf:group class="searchSection step" id="" style="">
    			<xf:group class="le" id="">
    				<xf:trigger class="btn " id="btn_list" style="" type="button" ev:onclick="scwin.btn_list_onclick">
    					<xf:label><![CDATA[목록]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    			<xf:group class="btnbox" id="">
    				<xf:trigger class="btn " id="btn_oz_prnt_02" style="" type="button" ev:onclick="scwin.btn_oz_prnt_02_onclick">
    					<xf:label><![CDATA[기술평가 요청서]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="btn " id="btn_oz_prnt_03" style="" type="button" ev:onclick="scwin.btn_oz_prnt_03_onclick">
    					<xf:label><![CDATA[기술평가 결과서]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="btn blue" id="btn_apr" style="" type="button" ev:onclick="scwin.btn_apr_onclick">
    					<xf:label><![CDATA[결재신청]]></xf:label>
    				</xf:trigger>
    				<xf:trigger class="btn " id="btn_new" style="" type="button" ev:onclick="scwin.btn_new_onclick">
    					<xf:label><![CDATA[접수]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    		</xf:group>
    		<xf:group class="titleSection" id="" style="">
    			<w2:textbox class="tit_tbl" id="" label="입찰개요" style="" tagname="h3"></w2:textbox>
    		</xf:group>
    		<xf:group class="w2tb tbl" id="" style="" tagname="table">
    			<w2:attributes>
    				<w2:summary></w2:summary>
    			</w2:attributes>
    			<xf:group tagname="caption"></xf:group>
    			<xf:group tagname="colgroup">
    				<xf:group style="width:200px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    				<xf:group style="width:200px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    			</xf:group>
    			<xf:group style="" tagname="tr">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="입찰공고번호" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_bid_noti_no" style="max-width:200px;" title="입찰공고번호" disabled="true" ref="data:dma_info.bid_noti_no"></xf:input>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="발주계획번호" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_bid_ord_no" style="max-width:200px;" title="발주계획번호" disabled="true" ref="data:dma_info.bid_ord_no"></xf:input>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="공고명" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_bid_title" style="" title="공고명" disabled="true" ref="data:dma_info.bid_title"></xf:input>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="심사구분" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_eval_type" style="max-width:200px;" title="심사구분" disabled="true"></xf:input>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="textbox12" label="평가 요청자" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_charger_nm" style="max-width:200px;" title="평가 담당자" disabled="true" ref="data:dma_info.charger_nm"></xf:input>
    				</xf:group>
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="textbox10" label="입찰가격배점" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes></w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_bid_val_score" style="max-width:200px;" title="입찰가격배점" disabled="true" ref="data:dma_info.bid_val_score"></xf:input>
    				</xf:group>
    			</xf:group>
    			<xf:group tagname="tr">
    				<xf:group class="w2tb_th" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="비고" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" tagname="td">
    					<w2:attributes>
    						<w2:colspan>3</w2:colspan>
    						<w2:rowspan>1</w2:rowspan>
    					</w2:attributes>
    					<xf:input adjustMaxLength="false" class="inp full" id="inp_rmk" style="" title="비고" disabled="true" ref="data:dma_info.rmk"></xf:input>
    				</xf:group>
    			</xf:group>
    			
    		</xf:group>
    		<xf:group class="helparea" id="noti_text_area" style="">
    				<xf:group id="" style="" tagname="ol">
    					<xf:group id="" tagname="li">
    						<w2:textbox class="red" id="tb_info_score" label="수의계약 가능여부 확인을 위하여, 제안서 적합성 평가를 진행하여 주시기 바랍니다. 총 배점은 100점이며, 85점 이상일 경우 수의계약 가능합니다." style="" tagname="span">
    						</w2:textbox>
    					</xf:group>
    				</xf:group>
    			</xf:group><xf:group class="titleSection" id="" style="">
    			<w2:textbox class="tit_tbl" id="" label="제안심사평가등록" style="" tagname="h3"></w2:textbox>
    		</xf:group>
    		<w2:gridView autoFit="allColumn" class="grid" dataList="data:dlt_list" defaultCellHeight="28"
    			evenRowBackgroundColor="#f7faff" id="grid1" noResultMessage="조회 결과가 없습니다." noResultMessageClass="noResult" rowMouseOverColor="#e7f0fb"
    			rowNumBackgroundColor="#fff" rowNumHeaderValue="No." rowNumVisible="true" rowNumWidth="60" rowStatusHeaderValue="상태"
    			rowStatusVisible="false" rowStatusWidth="50" scrollByColumn="false" scrollByColumnAdaptive="false" selectedCellColor="#fbf2cd"
    			selectedRowColor="#fbf2cd" style="height: 150px;" visibleRowNum="10" ev:onviewchange="scwin.grid1_onviewchange">
    			<w2:caption id="caption1" style="" value="this is a grid caption."></w2:caption>
    			<w2:header id="header1" style="">
    				<w2:row id="row1" style="">
    					<w2:column displayMode="label" id="column10" inputType="text" style="height:28px" value="사업자등록번호" width="150"></w2:column>
    					<w2:column displayMode="label" id="column18" inputType="text" style="height:28px" value="상호명" width="300"></w2:column>
    					<w2:column displayMode="label" id="column16" inputType="text" style="height:28px" value="대표자명" width="150"></w2:column>
    					<w2:column displayMode="label" id="column12" inputType="text" style="height:28px" value="평가점수" width="120"></w2:column>
    					<w2:column displayMode="label" id="column14" inputType="text" style="height:28px" value="적합여부" width="100"></w2:column>
    				</w2:row>
    			</w2:header>
    			<w2:gBody id="gBody1" style="">
    				<w2:row id="row2" style="">
    					<w2:column displayMode="label" id="bsns_psn_regst_no" inputType="text" style="height:28px" value="" width="150" readOnly="true"></w2:column>
    					<w2:column class="le" displayMode="label" id="vend_nm" inputType="text" style="height:28px" textAlign="left"
    						value="" width="300" readOnly="true">
    					</w2:column>
    					<w2:column displayMode="label" id="ceo_nm" inputType="text" style="height:28px" value="" width="150" readOnly="true"></w2:column>
    					<w2:column class="ri" displayMode="label" id="tot_score" inputType="text" style="height:28px" textAlign="right"
    						value="" width="120">
    					</w2:column>
    					<w2:column displayMode="label" editModeEventIcon="onclick" id="succ_yn" inputType="select" style="height:28px"
    						value="" viewType="icon" width="100" allOption="" chooseOption="" ref="">
    						<w2:choices>
    							<w2:item>
    								<w2:label><![CDATA[적합]]></w2:label>
    								<w2:value><![CDATA[Y]]></w2:value>
    							</w2:item>
    							<w2:item>
    								<w2:label><![CDATA[부적합]]></w2:label>
    								<w2:value><![CDATA[N]]></w2:value>
    							</w2:item>
    						</w2:choices>
    					</w2:column>
    				</w2:row>
    			</w2:gBody>
    		</w2:gridView>
    		<xf:group class="titleSection" id="" style="">
    			<w2:textbox class="tit_tbl" id="" label="첨부서류" style="" tagname="h3"></w2:textbox>
    		</xf:group>
    		<xf:group class="w2tb tbl" id="" style="width:100%;" tagname="table">
    			<w2:attributes>
    				<w2:summary></w2:summary>
    			</w2:attributes>
    			<xf:group tagname="caption"></xf:group>
    			<xf:group tagname="colgroup">
    				<xf:group style="width:180px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    			</xf:group>
    			<xf:group style="" tagname="tr">
    				<xf:group class="w2tb_th" style="" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="첨부파일" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" style="" tagname="td">
    					<xf:group class="fileuploadBox" id="upload_B" style="height:150px;"></xf:group>
    				</xf:group>
    			</xf:group>
    		</xf:group>
    		<xf:group class="titleSection" id="" style="">
    			<w2:textbox class="tit_tbl" id="" label="구매부서 요청 첨부서류" style="" tagname="h3"></w2:textbox>
    		</xf:group><xf:group class="w2tb tbl" id="" style="width:100%;" tagname="table">
    			<w2:attributes>
    				<w2:summary></w2:summary>
    			</w2:attributes>
    			<xf:group tagname="caption"></xf:group>
    			<xf:group tagname="colgroup">
    				<xf:group style="width:180px;" tagname="col"></xf:group>
    				<xf:group style="" tagname="col"></xf:group>
    			</xf:group>
    			<xf:group style="" tagname="tr">
    				<xf:group class="w2tb_th" style="" tagname="th">
    					<w2:attributes>
    						<w2:scope>row</w2:scope>
    					</w2:attributes>
    					<w2:textbox id="" label="첨부파일" style="" tagname="span"></w2:textbox>
    				</xf:group>
    				<xf:group class="w2tb_td" style="" tagname="td">
    					<xf:group class="fileuploadBox" id="upload_A" style="height:150px;"></xf:group>
    				</xf:group>
    			</xf:group>
    			
    		</xf:group><xf:group class="btnGroup" id="" style="">
    				<xf:group class="le" id="" style=""></xf:group>
    				<xf:group class="ri" id="">
    					<xf:trigger class=" btn pro conf" id="btn_save" style="" type="button" ev:onclick="scwin.btn_save_onclick">
    						<xf:label><![CDATA[저장]]></xf:label>
    					</xf:trigger>
    				</xf:group>
    			</xf:group>
    		
    	</xf:group>
    </body>
</html>
