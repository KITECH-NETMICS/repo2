<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head meta_programName="화학제품폐기관리" meta_vertical_guides="502" meta_horizontal_guides="">
    	<w2:type>DEFAULT</w2:type>
        <w2:buildDate/>
        <xf:model>
        	<xf:instance>
        		<data xmlns="" />
        	</xf:instance>
        	<w2:dataCollection baseNode="map">
        		<w2:dataMap baseNode="map" id="dma_search">
        			<w2:keyInfo>
        				<w2:key id="search_date" name="search_date" dataType="text"></w2:key>
        				<w2:key id="start_ymd" name="start_ymd" dataType="text"></w2:key>
        				<w2:key id="end_ymd" name="end_ymd" dataType="text"></w2:key>
        				<w2:key id="prduct_nm" name="prduct_nm" dataType="text"></w2:key>
        				<w2:key id="lab_nm" name="lab_nm" dataType="text"></w2:key>
        				<w2:key id="centr_cd" name="centr_cd" dataType="text"></w2:key>
        				<w2:key id="req_syspayno" name="req_syspayno" dataType="text"></w2:key>
        				<w2:key id="main_syspayno" name="main_syspayno" dataType="text"></w2:key>
        				<w2:key id="makr_cmpny" name="makr_cmpny" dataType="text"></w2:key>
        				<w2:key id="dsuse_req_no" name="dsuse_req_no" dataType="text"></w2:key>
        				<w2:key id="manager_yn" name="manager_yn" dataType="text"></w2:key>
        				<w2:key id="syspayno" name="syspayno" dataType="text"></w2:key>
        				<w2:key id="use_req_no" name="use_req_no" dataType="text"></w2:key>
        				<w2:key id="disposal_state" name="disposal_state" dataType="text"></w2:key>
        				<w2:key id="apr_state" name="apr_state" dataType="text"></w2:key>
        				<w2:key id="wste_exhst_ymd" name="wste_exhst_ymd" dataType="text"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataList baseNode="list" repeatNode="map" id="dlt_deuse_req" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column id="chk" name="chk" dataType="text"></w2:column>
        				<w2:column id="use_req_no" name="use_req_no" dataType="text"></w2:column>
        				<w2:column id="dsuse_req_no" name="dsuse_req_no" dataType="text"></w2:column>
        				<w2:column id="prduct_nm" name="prduct_nm" dataType="text"></w2:column>
        				<w2:column id="lab_nm" name="lab_nm" dataType="text"></w2:column>
        				<w2:column id="wste_clsf_nm" name="wste_clsf_nm" dataType="text"></w2:column>
        				<w2:column id="reqst_nm" name="reqst_nm" dataType="text"></w2:column>
        				<w2:column id="reqst_ymd" name="reqst_ymd" dataType="text"></w2:column>
        				<w2:column id="wste_exhst_ymd" name="wste_exhst_ymd" dataType="text"></w2:column>
        				<w2:column id="disposal_state" name="disposal_state" dataType="text"></w2:column>
        				<w2:column id="disposal_state_nm" name="disposal_state_nm" dataType="text"></w2:column>
        				<w2:column id="deuse_apr_state" name="deuse_apr_state" dataType="text"></w2:column>
        				<w2:column id="deuse_apr_state_nm" name="deuse_apr_state_nm" dataType="text"></w2:column>
        				<w2:column id="dcsn_daytm" name="dcsn_daytm" dataType="text"></w2:column>
        				<w2:column id="space_cd" name="space_cd" dataType="text"></w2:column>
        				<w2:column id="unslip_no" name="unslip_no" dataType="text"></w2:column>
        				<w2:column id="unslip_write_ymd" name="unslip_write_ymd" dataType="text"></w2:column>
        				<w2:column id="reqst_syspayno" name="reqst_syspayno" dataType="text"></w2:column>
        				<w2:column id="lab_no" name="lab_no" dataType="text"></w2:column>
        				<w2:column id="wste_clsf" name="wste_clsf" dataType="text"></w2:column>
        				<w2:column id="email" name="email" dataType="text"></w2:column>
        				<w2:column id="dcsn_no" name="dcsn_no" dataType="text"></w2:column>
        				<w2:column id="companion_rs" name="companion_rs" dataType="text"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataMap baseNode="map" id="dma_result">
        			<w2:keyInfo></w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataMap baseNode="map" id="dma_req_param">
        			<w2:keyInfo>
        				<w2:key id="prdu_state_new" name="prdu_state_new" dataType="text"></w2:key>
        				<w2:key id="use_req_no" name="use_req_no" dataType="text"></w2:key>
        				<w2:key id="space_cd" name="space_cd" dataType="text"></w2:key>
        				<w2:key id="companion_rs" name="companion_rs" dataType="text"></w2:key>
        				<w2:key id="syspayno" name="syspayno" dataType="text"></w2:key>
        				<w2:key id="dsuse_req_no" name="dsuse_req_no" dataType="text"></w2:key>
        				<w2:key id="uid" name="uid" dataType="text"></w2:key>
        				<w2:key id="cn" name="cn" dataType="text"></w2:key>
        				<w2:key id="updt_psn_syspayno" name="updt_psn_syspayno" dataType="text"></w2:key>
        				<w2:key id="disposal_state" name="disposal_state" dataType="text"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataList baseNode="list" repeatNode="map" id="dlt_deuse_disposal" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column id="chk" name="chk" dataType="text"></w2:column>
        				<w2:column id="use_req_no" name="use_req_no" dataType="text"></w2:column>
        				<w2:column id="dsuse_req_no" name="dsuse_req_no" dataType="text"></w2:column>
        				<w2:column id="prduct_nm" name="prduct_nm" dataType="text"></w2:column>
        				<w2:column id="lab_nm" name="lab_nm" dataType="text"></w2:column>
        				<w2:column id="wste_clsf_nm" name="wste_clsf_nm" dataType="text"></w2:column>
        				<w2:column id="reqst_nm" name="reqst_nm" dataType="text"></w2:column>
        				<w2:column id="reqst_ymd" name="reqst_ymd" dataType="text"></w2:column>
        				<w2:column id="wste_exhst_ymd" name="wste_exhst_ymd" dataType="text"></w2:column>
        				<w2:column id="disposal_state" name="disposal_state" dataType="text"></w2:column>
        				<w2:column id="disposal_state_nm" name="disposal_state_nm" dataType="text"></w2:column>
        				<w2:column id="deuse_apr_state" name="deuse_apr_state" dataType="text"></w2:column>
        				<w2:column id="deuse_apr_state_nm" name="deuse_apr_state_nm" dataType="text"></w2:column>
        				<w2:column id="dcsn_daytm" name="dcsn_daytm" dataType="text"></w2:column>
        				<w2:column id="space_cd" name="space_cd" dataType="text"></w2:column>
        				<w2:column id="unslip_no" name="unslip_no" dataType="text"></w2:column>
        				<w2:column id="unslip_write_ymd" name="unslip_write_ymd" dataType="text"></w2:column>
        				<w2:column id="reqst_syspayno" name="reqst_syspayno" dataType="text"></w2:column>
        				<w2:column id="lab_no" name="lab_no" dataType="text"></w2:column>
        				<w2:column id="wste_clsf" name="wste_clsf" dataType="text"></w2:column>
        				<w2:column id="email" name="email" dataType="text"></w2:column>
        				<w2:column id="dcsn_no" name="dcsn_no" dataType="text"></w2:column>
        				<w2:column id="companion_rs" name="companion_rs" dataType="text"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataMap baseNode="map" id="dma_dept">
        			<w2:keyInfo>
        				<w2:key id="dept_typ" name="dept_typ" dataType="text"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        	</w2:dataCollection>
        	<w2:workflowCollection></w2:workflowCollection>
        	<xf:submission id="sbm_selectDeuseSearch" ref="data:json,dma_search" target="" action="SvcSAFCHEPRDUMR01.pwkjson" method="post"
        		mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
        		processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_saveProdDeuseDisposal" ref='data:json,[{"id":"dma_req_param","key":"safChePrdDsuseInfoVo"},{"id":"dlt_deuse_disposal","key":"dsuseReqInfoList"}]' target="" action="SvcSAFCHEPRDUMI02.pwkjson"
        		method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_saveCompleteDeuse" ref="data:json,dma_req_param" target="" action="SvcSAFCHEPRDUMI01.pwkjson" method="post"
        		mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
        		processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_selectSfaCheProdDeuseList" ref="data:json,dma_search" target="" action="SvcSAFCHEPRDUMR01.pwkjson"
        		method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_selectDept" ref="data:json,dma_search" target="data:json,dma_dept" action="SvcSAFCHEPRDUMR02.pwkjson" method="post"
        		mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
        		processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        </xf:model>
        <script src="/cm/js/biz/saf.js" cache="false" />        
        <script type="text/javascript" lazy="false"><![CDATA[
    /****************************************************
 	 * 화면 설명 : 화학제품폐기관리
 	 * 변경 이력 : 2023-09-06	김상미	최초 작성
 	 * 서비스아이디 : D311
 	 ****************************************************/ 

	scwin.data={};
 
 	/**
	 * 페이지 로딩 이벤트
	 */  	        	         
	scwin.onpageload = function() {
		var param = com.getParameter();
		scwin.data.service_id = "D311";
		ibx_barcode_scan_value.hide();
		grp_slip.hide();
		
		scwin.data.today = com.getServerDateTime();
		
		// 기간역전 체크
		com.checkPeriod(ica_start_dt, ica_end_dt);

		// enter key event
		com.setEnterKeyEvent(grp_emp, scwin.btn_psn_onclick);	
		com.setEnterKeyEvent(grp_req_emp, scwin.btn_req_psn_onclick);	
				
		//바코드 스캔 처리 관련 전역변수
		scwin.data.barCode = [];
		scwin.data.reading = false;
		scwin.data.barcodeChk = false;
		scwin.data.manager = "";

		com.biz.checkRole({ serviceId : scwin.data.service_id, roleCodes : com.getLoginInfo('roleCode')}, function(e) {
			scwin.data.isRoleYn = e.isRoleYn;
		});			
		scwin.data.roleCode = com.getLoginInfo("roleCode");
		
		document.addEventListener("keypress", function(e) {
		  //보통 바코드 리더기가 읽기가 끝나면 Enter 를 입력하므로...
		  console.log("키누름 시작");
		  console.log(e.keyCode);
		  console.log(e.key);
		  console.log(barCode.length);
		  console.log(e.keyCode == 13);				  
		  if (e.keyCode == 13) {
		    if (barCode.length > 10) {
		      console.log("코드 시작");
		      ibx_barcode_scan_value.focus();
		      ibx_barcode_scan_value.setValue(barCode.join(""));
		      console.log(barCode);
		      /// code ready to use
		      barCode = [];
		    }
		  } else {
		    barCode.push(e.key); //while this is not an 'enter' it stores the every key
		  }
		});		
/*	//사용용도 확인 필요.
		window.parent.postMessage({
				    focusData: { focus : 'ON' }
		}, '*');
*/	
		scwin.initPage(param);
	};
	
	scwin.onpageunload = function() {
	};
	
	
	/**
	 * 화면 초기 세팅
	 */
	scwin.initPage = function(param) {
		if (param.req_no != undefined && param.req_no !="") {
			sbx_slt_search_Type.setValue("use_req_no");
			ibx_search_value.setValue(param.req_no);
		}

		// 공통코드
		var codeOptions = [ { code : "HCF", compID : "sbx_centr_cd"} //지역본부
		                  , { code : "XAB", compID : "sbx_domain"} //이메일도메인
		               ];		
		com.setCmnCd(codeOptions, function() {
		});	

		if (scwin.data.roleCode.indexOf("1019101") > 0 || scwin.data.roleCode.indexOf("1019102") > 0 || scwin.data.roleCode.indexOf("1019201") >0) {
			grp_slip.show("");
			scwin.data.manager = "A";
		} else {
			sbx_centr_cd.setDisabled(true);
			dma_search.set("syspayno", com.getLoginInfo("sn"));
			ibx_req_empno.setValue(com.getLoginInfo("empno"));
			ibx_req_psn_name.setValue(com.getLoginInfo("cn"));
			dma_search.set("req_syspayno", com.getLoginInfo("sn"));
		}
		
		if (com.getLoginInfo("sn")=="99991135") {
			scwin.data.manager = "Y";
		}
		
		grp_base_info.trigger("click");
		ibx_barcode_scan_value.focus();
		
		scwin.searchDept();
	};

	/**
	 * 부서유형 조회
	 */	
	scwin.searchDept = function() {
		com.execute(sbm_selectDept, {
			successCallback : function(e) {
				console.log(e.responseJSON);
				sbx_centr_cd.setValue(dma_dept.get("dept_typ"));
				sbx_slt_search_date.setSelectedIndex(0);
				//달력세팅
				ica_start_dt.setValue(com.addDate(scwin.data.today, -60));
				ica_end_dt.setValue(com.addDate(scwin.data.today, 60)); 
				
				scwin.search();				
			}
		});			
	};

	/**
	 * 키워드 구분 선택 변경시
	 */	
	scwin.sbx_slt_search_Type_onchange = function(info) {
		if (this.getValue()=="") {
			ibx_search_value.setValue("");
			ibx_search_value.setDisabled(true);
		} else {
			ibx_search_value.setDisabled(false);
		}
	};
	
	/**
	 * 키워드 검색어 입력 이벤트
	 */		
	scwin.ibx_search_value_onkeydown = function(e) {
		if (e.keyCode ==13) {
			scwin.search();
		}
	};
	
	/**
	 * 바코드 스캔으로 바코드 input box 내용 이벤트
	 */		
	scwin.ibx_barcode_scan_value_onchange = function(info) {
		var barcodeValue = ibx_barcode_scan_value.getValue().trim();
		
		//한글로 입력된 경우 영어로 변경처리
		var convertValue = biz.saf.korTypeToEng(barcodeValue);
		
		if (convertValue.length > 0) {
			scwin.data.barcodeChk = true;
			dma_search.set("use_req_no", ibx_barcode_scan_value.getValue());
			sciwn.searchDeuse();			
		}
	};
	
	/**
	 * 바코드로 입력된 제품 정보 조회 실행
	 */		
	scwin.searchDeuse = function() {
		com.execute(sbm_selectSfcProductQyInfoList, {
			successCallback : function(e) {
				console.log(e.responseJSON);
			}
		});		
	};
	
	/**
	 * 연구실 책임자 조회 돋보기버튼 클릭 이벤트
	 */	
	scwin.btn_psn_onclick = function(e) {
		var data = { empno : ibx_empno.getValue(), 
					 work_clsf : "HAG010", 
					 ref_yn : (ibx_empno.getValue()=="") ? "Y" :"N"
					}
		com.pop.open( com.pop.TYPE.HUM, data, function(ret) {		
			ibx_psn_name.setValue(ret.nm);
			ibx_empno.setValue(ret.empno);
			dma_search.set("main_syspayno", ret.syspayno);
		});					
	};

	/**
	 * 연구실 책임자 변경 이벤트
	 */	
	scwin.ibx_empno_onkeyup = function(e) {
		if (this.getValue() == "") {
			ibx_psn_name.setValue("");
			dma_search.set("main_syspayno", "");			
		}		
	};
	
	/**
	 * 신청자 조회 돋보기버튼 클릭 이벤트
	 */		
	scwin.btn_req_psn_onclick = function(e) {
		var data = { empno : ibx_req_empno.getValue(), 
					 work_clsf : "HAG010", 
					 ref_yn : (ibx_empno.getValue()=="") ? "Y" :"N"
					}
		com.pop.open( com.pop.TYPE.HUM, data, function(ret) {		
			ibx_req_psn_name.setValue(ret.nm);
			ibx_req_empno.setValue(ret.empno);
			dma_search.set("req_syspayno", ret.syspayno);
		});			
	};
	
	/**
	 * 신청자 변경이벤트
	 */	
	scwin.ibx_req_empno_onkeyup = function(e) {
		if (this.getValue() == "") {
			ibx_req_psn_name.setValue("");
			dma_search.set("req_syspayno", "");			
		}			
	};
		
	/**
	 * 조회버튼 클릭 이벤트
	 */			
	scwin.btn_search_onclick = function(e) {
		scwin.search();
	};

	/**
	 * 조회 실행
	 */	
	scwin.search = function() {
		if (sbx_slt_search_Type.getValue() == "prduct_nm") {
			dma_search.set("prduct_nm", ibx_search_value.getValue());
		} else if (sbx_slt_search_Type.getValue() == "lab_nm") {	
			dma_search.set("lab_nm", ibx_search_lab_nm.getValue());
		} else if (sbx_slt_search_Type.getValue() == "makr_cmpny") {
			dma_search.set("makr_cmpny", ibx_search_value.getValue());
		} else if (sbx_slt_search_Type.getValue() == "use_req_no") {
			dma_search.set("use_req_no", ibx_search_value.getValue());
		}	

		if (sbx_disposal_satate.getValue()=="1") {
			dma_search.set("disposal_state", "SFI001");
		} else if (sbx_disposal_satate.getValue()=="2") {
			dma_search.set("disposal_state", "SFI002");		
		} else if (sbx_disposal_satate.getValue()=="3") {
			dma_search.set("disposal_state", "SFI002");
			dma_search.set("apr_state", "XAD100");		
		} else if (sbx_disposal_satate.getValue()=="4") {
			dma_search.set("disposal_state", "SFI003");		
		} else if (sbx_disposal_satate.getValue()=="5") {
			dma_search.set("disposal_state", "SFI005");		
		} else {
			dma_search.set("disposal_state", "");
		}
		
		dma_search.set("manager_yn", scwin.data.manager);
		
		if (com.getLoginInfo("sn")=="99991135") {
			dma_search.set("syspayno", "20160348");
		} else {
			dma_search.set("syspayno", com.getLoginInfo("sn"));		
		}
		com.execute(sbm_selectSfaCheProdDeuseList, {
			successCallback : function(e) {
				console.log(e.responseJSON);
				dlt_deuse_req.setJSON(e.responseJSON.safChePrdDsuseInfoVoList);
				grd_list.removeFocusedCell();
				
				for(var i=0; i<dlt_deuse_req.getRowCount(); i++) {
            		if (dlt_deuse_req.getCellData([i] , "dcsn_daytm") != "" || dlt_deuse_req.getCellData([i] , "disposal_state") == "SFI004") {
            			grd_list.setDisabled( "cell" , i , "chk" , true );
					} else {
						grd_list.setDisabled( "cell" , i , "chk" , false );
					}
					
					// 폐기신청 결재중 상태이면서 전자결재 상태값이 완료라면 폐기신청 결재완료로 폐기상태를 변경시켜준다.
					if (dlt_deuse_req.getCellData([i] , "deuse_apr_state") == "XAD100" && dlt_deuse_req.getCellData([i] , "disposal_state") == "SFI002") {
						dlt_deuse_req.setCellData( i , "disposal_state_nm", "배출 대기중" );
					}					
				}
				
				if (scwin.data.focus != undefined && scwin.data.focus !="") {
					grd_list.setFocusedCell(scwin.data.focus, "use_req_no");
				}
				tbx_result.setValue(dlt_deuse_req.getTotalRow());				
			}
		});	
	};

	/**
	 * 폐기완료처리 버튼 클릭 이벤트
	 */			
	scwin.btn_dispos_complete_onclick = function(e) {
		if (!scwin.preComplete()) {
			return;
		}
		
		com.confirm("폐기완료 하시겠습니까 ?", function(ret) { 		
			if (ret) {
				scwin.completeDeuse();
			}
		});		

	};

	/**
	 * 폐기완료처리 실행
	 */
	scwin.completeDeuse = function() {
		com.execute(sbm_saveCompleteDeuse, {
			successCallback : function(e) {
				console.log(e.responseJSON.elData);
				var res = e.responseJSON.elData;
				if (scwin.data.barcodeChk) {
					ibx_barcode_scan_value.setValue("");
				}
				
				if (!scwin.data.barcodeChk) {
					if (res.count > 0) {
						com.alert("폐기확인 되었습니다.");
					}
				}
				scwin.search();
			}
		});		
	};
	

	/**
	 * 폐기완료처리 전 
	 */
	scwin.preComplete = function() {
		var chkArr = grd_list.getCheckedIndex("chk");
		var useReqNoArr = "";
		var spaceCdArr = "";
		var dsuseReqNoArr = "";	
	
		if (chkArr.length == 0) {
			com.alert("선택된 데이터가 없습니다.");
			return false;
		}	
		
		scwin.data.focus = grd_list.getFocusedRowIndex();

		// 폐기확정(확인) 필수 체크
		for(var i = 0 ; i < chkArr.length ; i++) {
			if (dlt_deuse_req.getCellData(chkArr[i] , "deuse_apr_state") != "XAD100" || dlt_deuse_req.getCellData(chkArr[i] , "disposal_state") != "SFI002") {
				com.alert("폐기상태가 [배출 대기중]인 데이터만 폐기완료가 가능합니다.");
				return false;
			}
		}

		// 선택한 행의 use_req_no 세팅
		for(var i = 0 ; i < chkArr.length ; i++) {
			if (chkArr.length == 1) {
				useReqNoArr = dlt_deuse_req.getCellData( chkArr[i] , "use_req_no" );
				spaceCdArr = dlt_deuse_req.getCellData( chkArr[i] , "space_cd" );
				dsuseReqNoArr = dlt_deuse_req.getCellData( chkArr[i] , "dsuse_req_no" );
			} else {
				for(i=0; i < chkArr.length; i++) {
					useReqNoArr = useReqNoArr + dlt_deuse_req.getCellData( chkArr[i] , "use_req_no" ) + ",";
					spaceCdArr = spaceCdArr + dlt_deuse_req.getCellData( chkArr[i] , "space_cd" ) + ",";
					dsuseReqNoArr = dsuseReqNoArr + dlt_deuse_req.getCellData( chkArr[i] , "dsuse_req_no" ) + ",";
				}
			}
		}
		
		dma_req_param.set("updt_psn_syspayno", com.getLoginInfo("sn"));		
		dma_req_param.set("dsuse_req_no", dsuseReqNoArr);		
		dma_req_param.set("syspayno", com.getLoginInfo("sn"));		
		dma_req_param.set("use_req_no", useReqNoArr);		
		dma_req_param.set("space_cd", spaceCdArr);		
		dma_req_param.set("disposal_state", "SFI003");				
		
		barcodeChk = false;
						
		return true;
	};

	/**
	 * 폐기신청 반려 버튼 클릭 이벤트 
	 */
	scwin.btn_dispos_req_reject_onclick = function(e) {
		if (!scwin.preDisposal()) {
			return;
		}
		com.confirm("폐기신청 반려 하시겠습니까 ?", function(ret) {
			if (ret) {
				//폐기신청 반려 사유 작성 팝업 요픈 
				scwin.openRejectReqPop(scwin.data.reject);
			}
		});			

	};

	/**
	 * 폐기신청 반려 사유 작성 팝업 요픈 처리
	 */	
	scwin.openRejectReqPop = function(data) {
		biz.saf.pop.open(biz.saf.pop.TYPE.REQ_REJECT, data, function(ret) {
			console.log(ret);
			if (ret.companion_rs != undefined) {
				dlt_deuse_disposal.setJSON(dlt_deuse_req.getMatchedJSON("chk", "Y", true), false);
	
				dma_req_param.set("prdu_state_new", "SFI005");
				dma_req_param.set("use_req_no", data.use_req_no);				
				dma_req_param.set("space_cd", data.space_cd);				
				dma_req_param.set("syspayno", com.getLoginInfo("sn"));				
				dma_req_param.set("dsuse_req_no", data.dsuse_req_no);				
				dma_req_param.set("uid", com.getLoginInfo("uid"));				
				dma_req_param.set("cn", com.getLoginInfo("cn"));				
				dma_req_param.set("companion_rs", ret.companion_rs); 
				
				com.execute(sbm_saveProdDeuseDisposal, {
					successCallback : function(e) { // 성공 콜백
						com.alert("폐기신청 반려처리가 완료되었습니다.", function() {
							scwin.search();
						});
					} 
				});		
			}
		});	
	}
	
	/**
	 * 폐기신청 반려 처리 전
	 */		
	scwin.preDisposal = function() {
		var chkArr = grd_list.getCheckedIndex("chk");
		console.log(chkArr);
		var useReqNoArr = "";
		var spaceCdArr = "";
		var dsuseReqNoArr = "";
		
		if (chkArr.length == 0) {
			com.alert("선택된 데이터가 없습니다.");
			return false;
		}
		
		scwin.data.focus = grd_list.getFocusedRowIndex();		

		// 반려 체크 로직
		for(var i = 0 ; i < chkArr.length ; i++) {
			// 폐기상태가 SFI002[폐기신청 결재중]인 상태만 폐기신청 반려가 가능하도록 설정
			if (dlt_deuse_req.getCellData( chkArr[i] , "disposal_state" ) == "SFI005") {
				com.alert("이미 폐기신청 반려된 제품입니다.");
				return false;
			}
			if (dlt_deuse_req.getCellData( chkArr[i] , "disposal_state" ) != "SFI002") {
				com.alert("폐기상태가 [배출 대기중]인 데이터만 폐기신청 반려가 가능합니다.");
				return false;
			}
			// 폐기신청 결재가 완료가 아닌 건은 폐기신청 반려를 하지 못함.
			if (dlt_deuse_req.getCellData( chkArr[i] , "deuse_apr_state" ) != "XAD100") {
				com.alert("폐기신청 결재가 진행중인 데이터가 있습니다.\n결재가 완료된 후 진행해주세요.");
				return false;
			}
		}
		
		// 선택한 행의 use_req_no 세팅
		for (var i = 0 ; i < chkArr.length ; i++) {
			if (chkArr.length == 1) {
				useReqNoArr = dlt_deuse_req.getCellData( chkArr[i] , "use_req_no" );
				spaceCdArr = dlt_deuse_req.getCellData( chkArr[i] , "space_cd" );
				dsuseReqNoArr = dlt_deuse_req.getCellData( chkArr[i] , "dsuse_req_no" );
			} else {
				for (i=0; i < chkArr.length; i++) {
					if (i == 0) {
						useReqNoArr = useReqNoArr + dlt_deuse_req.getCellData( chkArr[i] , "use_req_no" );
						spaceCdArr = spaceCdArr + dlt_deuse_req.getCellData( chkArr[i] , "space_cd" );
						dsuseReqNoArr = dsuseReqNoArr + dlt_deuse_req.getCellData( chkArr[i] , "dsuse_req_no" );						
					} else {
						useReqNoArr = useReqNoArr + ","+ dlt_deuse_req.getCellData( chkArr[i] , "use_req_no" );
						spaceCdArr = spaceCdArr+ "," + dlt_deuse_req.getCellData( chkArr[i] , "space_cd" );
						dsuseReqNoArr = dsuseReqNoArr+ "," + dlt_deuse_req.getCellData( chkArr[i] , "dsuse_req_no" );

					}
				}
			}
		}
		var data = {use_req_no : useReqNoArr, 
					space_cd : spaceCdArr, 
					dsuse_req_no : dsuseReqNoArr,
					gubun:"edit"};		
					
	    scwin.data.reject = data;
		
		return true;	
	};
	
	/**
	 * 엑셀 다운로드 이벤트
	 */	
	scwin.btn_down_excel_onclick = function(e) {
		var option = {
			    fileName : "화학제품폐기관리.xls"
			  , removeColumns : "0,9,11,14,15,16"
			  , useDataFormat : true
		};
		com.downloadGridExcel(grd_list, option);		
	};
		
	
	/**
	 * 그리드 셀클릭 이벤트
	 */	
	scwin.grd_list_oncellclick = function(row,col,colId) {
		if (colId == "dsuse_req_no") {
			var dsuseReqNo = dlt_deuse_req.getCellData(row, colId);
			scwin.openDeuseReqPop(dsuseReqNo);
		}
	};
	
	/**
	 * 화학제품폐기신청 팝업 오픈 실행
	 */
	scwin.openDeuseReqPop = function(dsuseReqNo) {
		var data = {dsuse_req_no:dsuseReqNo, 
					sn:com.getLoginInfo("sn"), 
					cn:com.getLoginInfo("cn"), 
					uid:com.getLoginInfo("uid"), 
					roleCode:scwin.data.roleCode, 
					celphonenumber:com.getLoginInfo("phone"), 
					focus:grd_list.getFocusedRowIndex()
		};
		
		biz.saf.pop.open(biz.saf.pop.TYPE.DEUSE, data, function(ret) {
			if (ret) {
				com.movePageMenu("A001", { "reqNo" : ret.dsuse_req_no});		
			}
		});
	};
	]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload" ev:onpageunload="scwin.onpageunload">
    	<w2:wframe id="wfm_title" src="/cm/xml/contentTitle.xml" style=""></w2:wframe>
    	<xf:group class="pageWrap" id="grp_base_info" style="">
    		<xf:group class="searchSection" id="" style="">
    			<xf:group class="schbox" id="" style="">
    				<xf:group class="w2tb tbl" id="" style="" tagname="table">
    					<w2:attributes>
    						<w2:summary></w2:summary>
    					</w2:attributes>
    					<xf:group tagname="caption"></xf:group>
    					<xf:group tagname="colgroup">
    						<xf:group style="width:90px;" tagname="col"></xf:group>
    						<xf:group style="width:240px;" tagname="col"></xf:group>
    						<xf:group style="width:90px;" tagname="col"></xf:group>
    						<xf:group style="width:300px;" tagname="col"></xf:group>
    						<xf:group style="width:70px;" tagname="col"></xf:group>
    						<xf:group style="width:170px;" tagname="col"></xf:group>
    						<xf:group style="width:80px;" tagname="col"></xf:group>
    						<xf:group style="" tagname="col"></xf:group>
    					</xf:group>
    					<xf:group style="" tagname="tr">
    						<xf:group class="w2tb_th" style="" tagname="th">
    							<w2:attributes>
    								<w2:scope>row</w2:scope>
    							</w2:attributes>
    							<xf:select1 allOption="" appearance="minimal" chooseOption="" class="sel" direction="auto" disabled="false"
    								disabledClass="w2selectbox_disabled" id="sbx_slt_search_date" ref="data:dma_search.search_date" style="" submenuSize="auto">
    								<xf:choices>
    									<xf:item>
    										<xf:label><![CDATA[등록일자]]></xf:label>
    										<xf:value><![CDATA[regist]]></xf:value>
    									</xf:item>
    									<xf:item>
    										<xf:label><![CDATA[확정일자]]></xf:label>
    										<xf:value><![CDATA[dcsn]]></xf:value>
    									</xf:item>
    								</xf:choices>
    							</xf:select1>
    						</xf:group>
    						<xf:group class="w2tb_td" style="" tagname="td">
    							<w2:attributes></w2:attributes>
    							<xf:group class="inpcalWrap" id="" style="">
    								<w2:inputCalendar calendarValueType="yearMonthDate" class="inpcal" focusOnDateSelect="false"
    									footerDiv="false" id="ica_start_dt" renderDiv="true" rightAlign="false" style="" ref="data:dma_search.start_ymd">
    								</w2:inputCalendar>
    								<w2:textbox class="dash" id="" label="~" style="" tagname="span"></w2:textbox>
    								<w2:inputCalendar calendarValueType="yearMonthDate" class="inpcal" focusOnDateSelect="false"
    									footerDiv="false" id="ica_end_dt" renderDiv="true" rightAlign="false" style="" ref="data:dma_search.end_ymd">
    								</w2:inputCalendar>
    							</xf:group>
    						</xf:group>
    						<xf:group class="w2tb_th" style="" tagname="th">
    							<w2:attributes>
    								<w2:scope>row</w2:scope>
    							</w2:attributes>
    							<w2:textbox id="" label="키워드" style="" tagname="span"></w2:textbox>
    						</xf:group>
    						<xf:group class="w2tb_td" style="" tagname="td">
    							<w2:attributes></w2:attributes>
    							<xf:select1 ref="" submenuSize="auto" appearance="minimal" disabledClass="w2selectbox_disabled"
    								chooseOption="true" disabled="false" style="width:90px;" allOption="" id="sbx_slt_search_Type" class="sel" direction="auto"
    								ev:onchange="scwin.sbx_slt_search_Type_onchange" chooseOptionLabel="-전체-">
    								<xf:choices>
    									<xf:item>
    										<xf:label><![CDATA[제품명]]></xf:label>
    										<xf:value><![CDATA[prduct_nm]]></xf:value>
    									</xf:item>
    									<xf:item>
    										<xf:label><![CDATA[제조사]]></xf:label>
    										<xf:value><![CDATA[makr_cmpny]]></xf:value>
    									</xf:item>
    									<xf:item>
    										<xf:label><![CDATA[사용번호]]></xf:label>
    										<xf:value><![CDATA[use_req_no]]></xf:value>
    									</xf:item>
    								</xf:choices>
    							</xf:select1>
    							<xf:input adjustMaxLength="false" style="width:120px;" id="ibx_search_value" class="inp" ev:onkeydown="scwin.ibx_search_value_onkeydown"></xf:input>
    							<xf:input adjustMaxLength="false" class="inp" id="ibx_barcode_scan_value" style="width:65px;" ev:onchange="scwin.ibx_barcode_scan_value_onchange"></xf:input>
    						</xf:group>
    						<xf:group class="w2tb_th" tagname="th">
    							<w2:attributes>
    								<w2:scope>row</w2:scope>
    							</w2:attributes>
    							<w2:textbox id="" label="연구실명" style="" tagname="span"></w2:textbox>
    						</xf:group>
    						<xf:group class="w2tb_td" tagname="td">
    							<w2:attributes>
    								<w2:scope>row</w2:scope>
    							</w2:attributes>
    							<xf:input adjustMaxLength="false" class="inp" id="ibx_search_lab_nm" style="width: 150px;" ref="data:dma_search.lab_nm"></xf:input>
    						</xf:group>
    						<xf:group class="w2tb_th" tagname="th">
    							<w2:attributes></w2:attributes>
    							<w2:textbox id="" label="연구실책임자" style="" tagname="span"></w2:textbox>
    						</xf:group>
    						<xf:group class="w2tb_td" tagname="td">
    							<w2:attributes></w2:attributes>
    							<xf:group class="inpSch" id="grp_emp" style="width: 90px;">
    								<xf:input adjustMaxLength="false" class="inp" id="ibx_empno" style="" ev:onkeyup="scwin.ibx_empno_onkeyup"></xf:input>
    								<xf:trigger class="btn" id="btn_psn" style="" type="button" ev:onclick="scwin.btn_psn_onclick">
    									<xf:label><![CDATA[검색]]></xf:label>
    								</xf:trigger>
    							</xf:group>
    							<xf:input adjustMaxLength="false" class="inp" id="ibx_psn_name" style="width: 120px;" readOnly="true"></xf:input>
    						</xf:group>
    					</xf:group>
    					<xf:group tagname="tr">
    						<xf:group class="w2tb_th" style="" tagname="th">
    							<w2:attributes>
    								<w2:scope>row</w2:scope>
    							</w2:attributes>
    							<w2:textbox id="" label="배출일자" style="" tagname="span"></w2:textbox>
    						</xf:group>
    						<xf:group class="w2tb_td" style="" tagname="td">
    							<w2:attributes></w2:attributes>
    							<w2:inputCalendar calendarValueType="yearMonthDate" class="inpcal" focusOnDateSelect="false"
    								footerDiv="true" id="ica_exhst_ymd" renderDiv="true" rightAlign="false" style="" ref="data:dma_search.wste_exhst_ymd" mandatory="true" maxYear="2027" minYear="2010">
    							</w2:inputCalendar>
    						</xf:group>
    						<xf:group class="w2tb_th" style="" tagname="th">
    							<w2:attributes>
    								<w2:scope>row</w2:scope>
    							</w2:attributes>
    							<w2:textbox id="" label="폐기진행상태" style="" tagname="span"></w2:textbox>
    						</xf:group>
    						<xf:group class="w2tb_td" style="" tagname="td">
    							<w2:attributes></w2:attributes>
    							<xf:select1 allOption="" appearance="minimal" chooseOption="true" class="sel" direction="auto"
    								disabled="false" disabledClass="w2selectbox_disabled" id="sbx_disposal_satate" style="width:150px;" submenuSize="auto"
    								chooseOptionLabel="-전체-" ref="">
    								<xf:choices>
    									<xf:item>
    										<xf:label><![CDATA[폐기신청 저장]]></xf:label>
    										<xf:value><![CDATA[1]]></xf:value>
    									</xf:item>
    									<xf:item>
    										<xf:label><![CDATA[폐기신청 결재중]]></xf:label>
    										<xf:value><![CDATA[2]]></xf:value>
    									</xf:item>
    									<xf:item>
    										<xf:label><![CDATA[배출 대기중]]></xf:label>
    										<xf:value><![CDATA[3]]></xf:value>
    									</xf:item>
    									<xf:item>
    										<xf:label><![CDATA[폐기확정]]></xf:label>
    										<xf:value><![CDATA[4]]></xf:value>
    									</xf:item>
    									<xf:item>
    										<xf:label><![CDATA[폐기확정 반려]]></xf:label>
    										<xf:value><![CDATA[5]]></xf:value>
    									</xf:item>
    								</xf:choices>
    							</xf:select1>
    						</xf:group>
    						<xf:group class="w2tb_th" tagname="th">
    							<w2:attributes>
    								<w2:scope>row</w2:scope>
    							</w2:attributes>
    							<w2:textbox id="" label="지역본부" style="" tagname="span"></w2:textbox>
    						</xf:group>
    						<xf:group class="w2tb_td" style="" tagname="td">
    							<w2:attributes>
    								<w2:scope>row</w2:scope>
    							</w2:attributes>
    							<xf:select1 allOption="" appearance="minimal" chooseOption="true" class="sel" direction="auto"
    								disabled="false" disabledClass="w2selectbox_disabled" id="sbx_centr_cd" ref="data:dma_search.centr_cd" style="width:150px;" submenuSize="auto"
    								chooseOptionLabel="-전체-">
    								<xf:choices></xf:choices>
    							</xf:select1>
    						</xf:group>
    						<xf:group class="w2tb_th" tagname="th">
    							<w2:attributes></w2:attributes>
    							<w2:textbox id="" label="신청자" style="" tagname="span"></w2:textbox>
    						</xf:group>
    						<xf:group class="w2tb_td" tagname="td">
    							<w2:attributes></w2:attributes>
    							<xf:group class="inpSch" id="grp_req_emp" style="width: 90px;">
    								<xf:input adjustMaxLength="false" class="inp" id="ibx_req_empno" style="" ev:onkeyup="scwin.ibx_req_empno_onkeyup"></xf:input>
    								<xf:trigger class="btn" id="btn_req_psn" style="" type="button" ev:onclick="scwin.btn_req_psn_onclick">
    									<xf:label><![CDATA[검색]]></xf:label>
    								</xf:trigger>
    							</xf:group>
    							<xf:input adjustMaxLength="false" class="inp" id="ibx_req_psn_name" style="width: 120px;" readOnly="true"></xf:input>
    						</xf:group>
    					</xf:group>
    				</xf:group>
    			</xf:group>
    			<xf:group class="schbtn" id="">
    				<xf:trigger class="btn search" id="btn_search" style="" type="button" ev:onclick="scwin.btn_search_onclick">
    					<xf:label><![CDATA[조회]]></xf:label>
    				</xf:trigger>
    			</xf:group>
    		</xf:group>
    		<xf:group class="titleSection" id="" style="">
    			<xf:group class="le" id="">
    				<xf:group class="result" id="">
    					<w2:span id="" label="*조회결과 " style=""></w2:span>
    					<w2:span class="numtotal" id="tbx_result" label="0" style=""></w2:span>
    					<w2:span id="" label="건" style=""></w2:span>
    				</xf:group>
    			</xf:group>
    			<xf:group class="ri" id="">
    				<xf:group class="btnarea" id="" style="">
    					<xf:group class="singleLine" id="grp_slip">
	    					<xf:trigger class="btn" id="btn_dispos_complete" style="" type="button" ev:onclick="scwin.btn_dispos_complete_onclick">
	    						<xf:label><![CDATA[폐기완료]]></xf:label>
	    					</xf:trigger>   
	    					<xf:trigger class="btn" id="btn_dispos_req_reject" style="" type="button" ev:onclick="scwin.btn_dispos_req_reject_onclick">
	    						<xf:label><![CDATA[폐기신청 반려]]></xf:label>
	    					</xf:trigger>  
    					</xf:group>   					 				
    					<xf:trigger class="btn icon down ml4" id="btn_down_excel" style="" type="button" ev:onclick="scwin.btn_down_excel_onclick">
    						<xf:label><![CDATA[엑셀다운로드]]></xf:label>
    					</xf:trigger>
    				</xf:group>
    			</xf:group>
    		</xf:group>
    		<w2:gridView autoFit="allColumn" class="grid" dataList="data:dlt_deuse_req" defaultCellHeight="28"
    			evenRowBackgroundColor="#f7faff" id="grd_list" noResultMessage="조회 결과가 없습니다." noResultMessageClass="noResult"
    			rowMouseOverColor="#e7f0fb" rowNumBackgroundColor="#fff" rowNumHeaderValue="No." rowNumVisible="true" rowNumWidth="60"
    			rowStatusHeaderValue="상태" rowStatusVisible="false" rowStatusWidth="50" scrollByColumn="false" scrollByColumnAdaptive="false"
    			selectedCellColor="#fbf2cd" selectedRowColor="#fbf2cd" style="height: 85px;" visibleRowNum="20"
    			ev:oncellclick="scwin.grd_list_oncellclick" sortEvent="onclick" sortable="true">
    			<w2:caption id="caption1" style="" value="this is a grid caption."></w2:caption>
    			<w2:header id="header1" style="">
    				<w2:row id="row1" style="">
    					<w2:column checkboxLabel="전체선택" displayMode="label" fixColumnWidth="true" id="column1" inputType="checkbox"
    						readOnly="false" style="height:28px;" value="선택" width="45">
    					</w2:column>
    					<w2:column displayMode="label" id="column9" inputType="text" style="height:28px;" value="제품사용번호" width="150"></w2:column>
    					<w2:column displayMode="label" id="column7" inputType="text" style="height:28px;" value="신청번호" width="100"></w2:column>
    					<w2:column displayMode="label" id="column5" inputType="text" style="height:28px;" value="제품명" width="300"></w2:column>
    					<w2:column displayMode="label" id="column3" inputType="text" sortable="true" style="height:28px;" value="연구실명"
    						width="100">
    					</w2:column>
    					<w2:column displayMode="label" id="column20" inputType="text" style="height:28px;" value="폐기물분류" width="100"></w2:column>
    					<w2:column displayMode="label" id="column21" inputType="text" style="height:28px" value="신청자" width="80"></w2:column>
    					<w2:column displayMode="label" id="column23" inputType="text" style="height:28px" value="신청일자" width="100"></w2:column>
    					<w2:column displayMode="label" id="column25" inputType="text" style="height:28px" value="배출일자" width="100"></w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="column47" value="폐기상태코드" displayMode="label"
    						hidden="true">
    					</w2:column>
    					<w2:column displayMode="label" id="column27" inputType="text" style="height:28px" value="폐기진행상태" width="100"></w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="column49" value="결재상태코드" displayMode="label"
    						hidden="true">
    					</w2:column>
    					<w2:column displayMode="label" id="column39" inputType="text" style="height:28px" value="결재상태" width="100"></w2:column>
    					<w2:column displayMode="label" id="column37" inputType="text" style="height:28px" value="완료일자" width="150"></w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="column41" value="연구실코드" displayMode="label"
    						hidden="true">
    					</w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="column43" value="결의번호" displayMode="label"
    						hidden="true">
    					</w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="column45" value="결의일자" displayMode="label"
    						hidden="true">
    					</w2:column>
    				</w2:row>
    			</w2:header>
    			<w2:gBody id="gBody1" style="">
    				<w2:row id="row2" style="">
    					<w2:column checkboxLabel="선택" displayMode="label" id="chk" inputType="checkbox" readOnly="false"
    						style="height:28px;" width="50" trueValue="Y">
    					</w2:column>
    					<w2:column displayMode="label" id="use_req_no" inputType="text" readOnly="true" style="height:28px;" width="150"></w2:column>
    					<w2:column displayMode="label" id="dsuse_req_no" inputType="link" readOnly="true" style="height:28px;" value=""
    						width="100">
    					</w2:column>
    					<w2:column class="le" displayMode="label" escape="false" id="prduct_nm" inputType="text" readOnly="true"
    						style="height:28px;" width="300" textAlign="left">
    					</w2:column>
    					<w2:column displayMode="label" id="lab_nm" inputType="text" readOnly="true" style="height:28px;" width="100" class="" textAlign="left"></w2:column>
    					<w2:column displayMode="label" id="wste_clsf_nm" inputType="text" readOnly="true" style="height:28px;"
    						width="100">
    					</w2:column>
    					<w2:column displayMode="label" id="reqst_nm" inputType="text" style="height:28px" value="" width="80"
    						readOnly="true">
    					</w2:column>
    					<w2:column displayMode="label" id="reqst_ymd" inputType="calendar" style="height:28px" value="" width="100"
    						readOnly="true">
    					</w2:column>
    					<w2:column displayMode="label" id="wste_exhst_ymd" inputType="calendar" style="height:28px" value="" width="100"
    						readOnly="true">
    					</w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="disposal_state" value="" displayMode="label"></w2:column>
    					<w2:column displayMode="label" id="disposal_state_nm" inputType="text" style="height:28px" value="" width="100"
    						readOnly="true">
    					</w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="deuse_apr_state" value="" displayMode="label"></w2:column>
    					<w2:column displayMode="label" id="deuse_apr_state_nm" inputType="text" style="height:28px" value="" width="100"
    						readOnly="true">
    					</w2:column>
    					<w2:column displayMode="label" id="dcsn_daytm" inputType="calendar" style="height:28px" value="" width="150"
    						readOnly="true">
    					</w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="space_cd" value="" displayMode="label"
    						readOnly="true">
    					</w2:column>
    					<w2:column width="70" inputType="text" style="height:28px" id="unslip_no" value="" displayMode="label"
    						readOnly="true">
    					</w2:column>
    					<w2:column width="70" inputType="calendar" style="height:28px" id="unslip_write_ymd" value="" displayMode="label"
    						readOnly="true">
    					</w2:column>
    				</w2:row>
    			</w2:gBody>
    		</w2:gridView>
    	</xf:group>
    </body>
</html>
