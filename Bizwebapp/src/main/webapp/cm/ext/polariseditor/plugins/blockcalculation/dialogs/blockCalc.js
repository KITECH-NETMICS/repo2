(function(){POLARIS.dialog.add("blockcalculation",function(q){function v(a){function b(a,b){if(!a)return-1;for(var e=0,c=a.length;e<c;e++)b(a[e],e)}var c=POLARIS.plugins.tabletools.getSelectedCells(a),d=a=NaN,l=NaN;if(c=function(a,c){var e=NaN,d=0;b(a,function(a){a=a.$.innerText.trim().replace(/\u200b|,/g,"").split("\n");var b,g=a.length,f;for(b=0;b<g;b++)f=parseFloat(a[b]),isNaN(f)||(d++,f=+f,e=isNaN(e)?f:c(e,f))});return{result:e,count:0==d?NaN:d}}(c,function(a,b){return a+b}))a=c.result,l=c.count,
d=a/l;return{sum:isNaN(a)?"":a,avg:isNaN(d)?"":d,numCount:isNaN(l)?"":l}}var r="txtSum",n=function(){var a=this.getDialog();a.getContentElement("blockCalc","radioOption1")!=this&&a.getContentElement("blockCalc","radioOption1").setValue("");a.getContentElement("blockCalc","radioOption2")!=this&&a.getContentElement("blockCalc","radioOption2").setValue("");a.getContentElement("blockCalc","radioOption3")!=this&&a.getContentElement("blockCalc","radioOption3").setValue("");r=this.items[0][1]},h=q.lang.blockcalculation;
POLARIS.getUrl(POLARIS.plugins.get("about").path+"dialogs/"+(POLARIS.env.hidpi?"hidpi/":"")+"polaris_bi_info.png");return{title:h.label,minWidth:244,minHeight:115,resizable:POLARIS.DIALOG_RESIZE_NONE,contents:[{id:"blockCalc",label:"",padding:5,elements:[{type:"hbox",children:[{id:"radioOption1",type:"radio",order:"vertical",verticalalign:"top",items:[[h.labelSum,"txtSum"]],onClick:n},{id:"txtSum",type:"text",order:"vertical",verticalalign:"top",style:"width:180px; background-color: yellow;"}]},{type:"hbox",
children:[{id:"radioOption2",type:"radio",order:"vertical",verticalalign:"top",items:[[h.labelAvg,"txtAvg"]],onClick:n},{id:"txtAvg",type:"text",order:"vertical",verticalalign:"top",style:"width:180px; background-color: yellow;"}]},{type:"hbox",children:[{id:"radioOption3",type:"radio",order:"vertical",verticalalign:"top",items:[[h.labelLine,"txtLine"]],onClick:n},{id:"txtLine",type:"text",order:"vertical",verticalalign:"top",style:"width:180px; background-color: yellow; readOnly;"}]},{type:"hbox",
children:[{type:"checkbox",id:"chkComma",label:h.labelComma,onClick:function(){var a=this.getDialog(),b=a.getContentElement("blockCalc","txtSum"),a=a.getContentElement("blockCalc","txtAvg");if(1==this.getValue()){var c=b.getValue().toString().split(".");b.setValue(c[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")+(c[1]?"."+c[1]:""));b=a.getValue().toString().split(".");a.setValue(b[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")+(b[1]?"."+b[1]:""))}else c=b.getValue().toString().split("."),b.setValue(c[0].replace(/[^\d]+/g,
"")+(c[1]?"."+c[1]:"")),b=a.getValue().toString().split("."),a.setValue(b[0].replace(/[^\d]+/g,"")+(b[1]?"."+b[1]:""))}}]}]}],onShow:function(){var a=this.getContentElement("blockCalc","txtSum"),b=this.getContentElement("blockCalc","txtAvg"),c=this.getContentElement("blockCalc","txtLine");this.getContentElement("blockCalc","chkComma");var d=a._.inputId;document.getElementById(d).readOnly=!0;d=b._.inputId;document.getElementById(d).readOnly=!0;d=c._.inputId;document.getElementById(d).readOnly=!0;a:{for(var d=
q.getSelection(),l=d.getRanges(),p=0,h=0,e=0;e<l.length;e++){var n=new POLARIS.dom.walker(l[e]);if(0==n.range.endOffset-n.range.startOffset){d=v(d);a.setValue(d.sum);b.setValue(d.avg);c.setValue(d.numCount);break a}for(var m;m=n.next();)if(m.type==POLARIS.NODE_TEXT){m=m.getText();for(var k="",g="",f=!1,t=!1,u=0,e=0;e<m.length;e++)if(k=m.charAt(e),"0"<=k&&"9">=k||"."==k){if("."!=k)if(0==t)g=1==f?10*g+1*k:1*k;else if(1==f){for(var f=.1,r=0;r<u;r++)f*=.1;g+=k*f;u++}else g=1*k;else 1==f&&(t=!0);e==m.length-
1&&(p+=g,h++);f=!0}else 1==f&&(p+=g,h++,g=0),t=f=!1,u=0}}a.setValue(p);b.setValue(p/h);c.setValue(h)}a=q.plugins.blockcalculation.getOperation();"sum"==a?this.getContentElement("blockCalc","radioOption1").setValue("txtSum"):"avg"==a&&this.getContentElement("blockCalc","radioOption2").setValue("txtAvg")},buttons:[POLARIS.dialog.cancelButton(q,{label:q.lang.common.close})],onOk:function(){this.getContentElement("blockCalc",r).getSelection().getRanges().execCommand("Copy",!1,null)}}})})();